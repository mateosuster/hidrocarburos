---
title: "Renta de la tierra hidrocarburífera en Argentina (1960 - 2018)"
author:
- affiliation: UNGS/CONICET
  name: Mateo Suster y Juan Kornblihtt
output:
  pdf_document: 
    toc: yes
    keep_tex: yes
  html_document:
    df_print: paged
    toc: yes
  html_notebook:
    toc: yes
    toc_float: yes
---

<br>
<br>

<center> <h1></h1> </center> 



```{r}
# para guardar ggplot con tamaño
# ggsave("facet_wrap_chart.png", facet_wrap_chart, width = 1680/72, height = 1050/72, dpi = 72)

```

  
```{r message=FALSE, warning=FALSE, include=FALSE}
# library(xtable) # ej xtable(tabla) para pasar a latex
knitr::opts_chunk$set(echo = FALSE)

library(readxl) 
# library(readr)
library(tidyverse)
library(lubridate)
library(fs)
library(ggplot2)
library(plotly)
library(huxtable) #revisar esto para dar formato al eje Y
# library(PerformanceAnalytics)
library(Hmisc)
library(zoo)

options(scipen = 9999999)

# agregar label para variables de graficos 
#facetwrap(~ experimentox, labeller = as_labeller(exp_names))+  

```

# Funciones de conversión 

* [Canada – National Energy Board. Energy Conversion Tables](https://apps.cer-rec.gc.ca/Conversion/conversion-tables.aspx?GoCTemplateCulture=en-CA#2-3)
* [BP](https://www.bp.com/content/dam/bp/business-sites/en/global/corporate/pdfs/energy-economics/statistical-review/bp-stats-review-2019-approximate-conversion-factors.pdf)
* [EIA](https://www.eia.gov/kids/what-is-energy/energy-calculators.php#natgascalc)


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Funciones de conversión para crudo
## Metro cubico a barril (_p = precio, _q = cantidad)
conversor_m3bbl_p <- function(x) {x / 6.2898}
conversor_m3bbl_q <- function(x) {x * 6.2898}

# Funciones de conversión para gas
## Pies cúbico a metro cúbico
## 1ft³= 0.02831685m³
conversor_ft3m3_p <- function(x) {x / 0.02831685}
conversor_ft3m3_q <- function(x) {x * 0.02831685}

## Pie cúbico a Millón de BTU
# 1 ft3 =  0.001028 MM BTU
conversor_ft3MMBTU_q <- function(x) {x * 0.001028}
conversor_ft3MMBTU_p <- function(x) {x / 0.001028}

## Millón de BTU a metro cúbico
## 1 MM Btu =  27,8 m3 de gas (IAPG) ó 28.32861 m3 (Canada Energy Regulator)  
conversor_MMBTUm3gas_p <- function(x) {x / 28.32861}
  
## m3 a  MMBTU de gas
# 1 m3 = 0.0353 MM BTU  (Canada Energy Regulator)
# otra opción 1 m3 = 34.121 MM BTU  (BP)
conversor_m3MMBTU_q <- function(x){x * 0.0353}
conversor_m3MMBTU_p <- function(x){x / 0.0353}

## m3 a  MMBTU (Alternativa, revisar)
# conversor_m3MMBTU_q <- function(x){x * 1/27.8}
# conversor_m3MMBTU_p <- function(x){x / 1/27.8}

## Conversión a BEP desde distintas medidas
conversor_m3bep_q <- function(x) {x * 5883}
conversor_MMBTUbep_q <- function(x) {x * 0.17245496} # BP
conversor_MMBTUbep_p <- function(x) {x / 0.17245496}
conversor_bepMMBTU_p <- function(x) {x / 5.798615}
```


```{r message=FALSE, warning=FALSE, include=FALSE}
# Otras funciones
cambio_porcentual <- function(x) {x/lag(x) - 1}

generar_indice <-  function(serie,fecha, fecha_base){
  valor_base <- serie[which(fecha==fecha_base)]
  if_else(serie == 0, 0, serie/valor_base)
}



variacion_interanual <- function(x) {x  - lag(x)}

tasa_crecimiento <- function(x) {(x  - lag(x))/lag(x)}


generar_indice <-  function(serie,fecha, fecha_base){
  valor_base <- serie[which(fecha==fecha_base)]
  (serie/valor_base)
}



# Tabla para convertir los cambios de moneda
conversor_pesos <- read_excel("C:/Archivos/Datos/Hidrocarburos/pase de moneda.xlsx") %>% 
  # mutate("m$n" = as.double(conversor_pesos$`m$n`)) %>% 
  mutate_all(., as.double) %>% 
  mutate(moneda = c("moneda nacional", "pesos ley", "peso argentino", "austral", "pesos")) %>% 
  filter(moneda == "pesos")

```






```{r message=FALSE, warning=FALSE, include=FALSE}

# Datos auxiliares
##Revista de Política de Precios de la Energía
## GAS
#precio transferencia, regalias, compensaciones, etc a noviembre de cada año
cuadro_4.1 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del gas natural y derivados 1970 - 1988.xlsx", 
    skip = 1, sheet = 1)

#precio bolivia vs precios internos
cuadro_4.3 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del gas natural y derivados 1970 - 1988.xlsx", 
    skip = 1, sheet = 3) %>%
  rename(unidad_gas = "unidad gas") %>% 
  mutate(unidad_gas = "pesos de 1970/1000 m3" )

#precio adquisición del Estado y tarifa media de gas distribuido
cuadro_4.4 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del gas natural y derivados 1970 - 1988.xlsx", 
    skip = 1, sheet = 4)
```


```{r message=FALSE, warning=FALSE, include=FALSE}
## CRUDO

# Precios por cuenca
cuadro_2.2 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del petroleo crudo y derivados 1970 - 1989.xlsx", 
    skip = 0, sheet = 2) %>% 
  mutate(unidad = "pesos de 1970")

#evolución de precios por cuencia (indices 1970 = 100)
cuadro_2.3 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del petroleo crudo y derivados 1970 - 1989.xlsx", 
    skip = 0, sheet = 3) %>% 
  rename(anio = "...1")


# precio promedio pagado a contratistas en pesos y dolares
cuadro_2.5 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del petroleo crudo y derivados 1970 - 1989.xlsx", 
    skip = 1, sheet = 5)

# precios pagados a contratistas vs cobrados por refinadoras privadas (precio crudo neuquina)
cuadro_2.6 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del petroleo crudo y derivados 1970 - 1989.xlsx", 
    skip = 1, sheet = 6) %>% 
  mutate(unidad = "pesos_de_1970_m3")

# valores unitarios del producto compuesto a nivel productores y consumidores
cuadro_2.7 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del petroleo crudo y derivados 1970 - 1989.xlsx", 
    skip = 1, sheet = 7)

```
 


```{r message=FALSE, warning=FALSE, include=FALSE}
### TCP 
tcp_anual <- read_excel("C:/Archivos/Datos/TCP/tcp_anual.xlsx", 
    col_types = c("numeric", "numeric", "numeric")) %>% 
  rename(anio = fecha)

tcp_anual_b <- read_excel("C:/Archivos/Datos/TCP/tcc_tcp_historico.xlsx") %>% 
  rename(tcc =  `TCC exportaciones`, sobrevaluacion = `Sobrevaluación (TCP/ TCC) 1952-1972=1`,
         tcp = "TCP") %>% 
  mutate(anio = case_when(anio == 43313 ~ 2018,
                          T ~ anio)) %>% 
  select(anio, tcc, tcp, sobrevaluacion)

# tc_3500 <- read_excel("/Archivos/Datos/TCP/com3500.xls", skip = 3, sheet = 1) %>% 
#   select(-"...3") %>% 
#   mutate(anio = year(Fecha)) %>% 
#   group_by(anio) %>% 
#   summarise(tcc_avg = mean(`Tipo de Cambio de Referencia - en Pesos - por Dólar`))
# write.csv(tc_3500, "resultados/auxiliares/tc_3500.csv")

tcc_dic_63 <- read_excel("C:/Archivos/Datos/TCP/tcc_dic_63.xlsx")

tcc_moneda_original <-  tcc_dic_63 %>% 
  select(-usd_dic) %>% 
  left_join(tcp_anual_b %>% select(anio, tcc )) %>% 
  mutate(moneda = case_when(anio == 1984 ~ "$arg",
                            T ~ moneda),
          tcc_moneda = case_when( #homogenizamos los cambios de moneda
                 moneda == "m$n" ~ tcc*conversor_pesos$`m$n` ,
                 moneda == "$ley" ~ tcc*conversor_pesos$`$Ley`, 
                 moneda == "$arg" ~ tcc*conversor_pesos$`$a`, 
                 moneda == "A" ~ tcc*conversor_pesos$A,
                 T ~ tcc) )
tcc_moneda_original  
```


```{r message=FALSE, warning=FALSE, include=FALSE}
## IPC
ipc <- read_excel("C:/Archivos/Datos/indices/ipc_mensual_1963_2018.xlsx") %>% 
  mutate(anio = zoo::na.locf(anio)) %>% 
  rename(ipc_0703 = `Base 7/2003 = 1`) %>% 
  mutate(fecha = as.Date(parse_date_time(paste(anio, mes, sep = "-"), orders = "ym"))) %>% 
  select(fecha, anio, mes , everything(.))

#este está mal  
# ipc_variacion <-  ipc  %>% 
#   filter(mes == 1) %>% 
#   mutate(ipc_var = cambio_porcentual(ipc_0703),
#          ipc_var= case_when(is.na(ipc_var) ~ 1,
#                                   T ~ ipc_var),
#           ipc_0162 = case_when(anio == 1962 ~ 1),
#          ipc_0162 = lag(ipc_0162)+lag(ipc_0162)* ipc_var)
#          
         # ipc_0162 = lag(ipc_0162) + (lag(ipc_0162)* ipc_var))
         # ipc_0162 = case_when( is.na(ipc_0162) ~ lag(ipc_0162) + lag(ipc_0162)*ipc_var ))


ipc_promedio <- ipc %>%
  group_by(anio) %>% 
  summarise(ipc_03 = mean(ipc_0703)) %>% 
  mutate(fecha = as.Date(parse_date_time(anio , orders = "y")), 
         ipc_70 = generar_indice(serie = ipc_03,  
                            fecha= fecha, 
                            fecha_base = "1970-01-01"),
         ipc_18 = generar_indice(serie = ipc_03,  
                            fecha= fecha, 
                            fecha_base = "2018-01-01")) %>% 
  select(fecha, everything(.))

write.csv(ipc_promedio, file = "C:/Archivos/Datos/indices/ipc_promedio.csv")

# ipc_70 <- ipc_variacion %>% 
#   select(fecha, ipc_0170) %>% 
#   left_join(ipc_promedio %>% 
#               select(fecha, ipc_70))

# IPIM base 1993 = 100
# Índice de precios internos al por mayor (IPIM)
# Índice de precios internos básicos al por mayor (IPIB)
# Índice de precios básicos del productor (IPP)
sipm_serie56_95 <- read_excel("C:/Archivos/Datos/INDEC/IPIM/sipm-serie56-95.xls",
    skip = 6) %>% 
  rename(anio = mes,
         ipim_nivel_gral = general...2 ,
         ipim_nivel_nac = nacionales...3,
         ipim_nivel_impo = Importados,
         ipib_nivel_gral = general...5 ,
         ipib_nivel_nac = nacionales...6,
         ipib_nivel_impo = importados,
         ipp_nivel_gral = general...8) %>% 
  filter(grepl( "19", anio)) %>% 
  mutate(anio = as.double(anio))

ipim_base94 <- sipm_serie56_95 %>% mutate(ipim_nivel_gral_94 = generar_indice(ipim_nivel_gral, 
                                          fecha = anio,
                                          fecha_base = 1994)) %>% 
  select(anio, ipim_nivel_gral, ipim_nivel_gral_94)

# Ganancia y pbi pesos corrientes (fuente: JIC/EM continuacion JIC)
ganancia_y_pbi <- read_excel("/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/ganancia y pbi.xlsx") %>% 
  mutate(unidad = "Millones de pesos corrientes") %>% 
  select(anio, unidad, everything(.))

```


```{r message=FALSE, warning=FALSE, include=FALSE}
# Estimacion de otros autores
# **Estimación JK**
renta_hidrocarburos_jk <- read_excel("/Archivos/Datos/Hidrocarburos/Estimacion propia/renta_hidrocarburos_jk.xls", 
    skip = 2) %>% 
  filter(indice_tiempo <= 2019) %>% 
  mutate_all(as.double) %>% 
  rename(precio_me_gas = `Gas natural mercado externo`,
         precio_mi_gas = `precio interno gas natural_pesos`,
         precio_me_crudo = `Precio crudo mercado externo`,
         precio_mi_crudo = `Precio crudo mercado interno`,
         precio_bolivia_gas_usd = `Gas Natural. Precio Venta Bolivia a Argentina...24`, 
         precio_bolivia_gas_pesos = `Gas Natural. Precio Venta Bolivia a Argentina...25`,
         renta_diferencial_precio_crudo =`Renta por venta crudo en el mercado interno por debajo / arriba precio internacional`,
         renta_diferencial_precio_gas = 'Renta por venta gas en el mercado interno por debajo / arriba precio internacional',
         renta_sobrevaluacion_crudo = 'Renta crudo por exportaciones a peso sobrevaluado',
         renta_sobrevaluacion_gas = 'Renta gas por exportaciones',
         retenciones = "Retenciones",
         regalias = `Regalias total`,
         renta_total = 'SUMA renta otros (sin importaciones ni retenciones)') %>% 
  mutate(unidad_gas = "MMBTU",
         unidad_crudo = "Barriles",
         unidad_renta = "Pesos corrientes") %>% 
  select(anio = indice_tiempo, unidad_gas, unidad_crudo, unidad_renta,
         prod_petcru, expo_crudo, crudo_interno,
         prod_gasnat, expo_gas, gas_interno,
         precio_me_gas , precio_mi_gas , precio_me_crudo, precio_mi_crudo, 
         precio_bolivia_gas_usd ,  precio_bolivia_gas_pesos , 
         renta_diferencial_precio_crudo , renta_diferencial_precio_gas ,
         renta_sobrevaluacion_crudo , renta_sobrevaluacion_gas ,
         retenciones, regalias, 
         TCC, TCP, 
         renta_total) %>%
  mutate_at(.vars = c("prod_petcru", "expo_crudo", "crudo_interno"), 
            .funs = conversor_m3bbl_q) %>% 
  mutate_at(.vars = c("precio_mi_crudo", "precio_me_crudo"),
            .funs = conversor_m3bbl_p) %>% 
  mutate_at(.vars = c("prod_gasnat", "expo_gas", "gas_interno"),
            .funs = conversor_m3MMBTU_q) %>% 
  mutate_at(.vars = c("precio_mi_gas", "precio_bolivia_gas_pesos"),
            .funs = conversor_m3MMBTU_p)

  
renta_precio_expo_crudo_jk <- renta_hidrocarburos_jk %>% 
  select(anio, prod_petcru, expo_crudo, crudo_interno, 
         precio_mi_crudo, precio_me_crudo, TCC, TCP, 
         renta_diferencial_precio_crudo, renta_sobrevaluacion_crudo )


renta_precio_expo_gas_jk <- renta_hidrocarburos_jk %>% 
  select(anio, prod_gasnat, expo_gas, gas_interno, 
         precio_mi_gas, precio_bolivia_gas_pesos, TCC, TCP, 
         renta_diferencial_precio_gas, renta_sobrevaluacion_gas )


#Estimación Bill y Farfaro Ruiz
renta_hidrocarburos_fr <- read_excel("/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/renta_hidrocarburos_FR.xlsx" ) %>%
  select(-unidad) %>% 
  rename(regalias = "Regalías",
         retenciones = Retenciones,
         expo_tc = "Mediante sobrevaluación para export",
         dif_precios = "Mediante diferencia precio interno con internac") %>%
  group_by(anio , ipc_08) %>% 
  mutate_all(function(x) {x / 10^3}) %>% 
  left_join(ipc_promedio %>% select(anio, ipc_18)) %>%
  mutate(regalias =regalias * ipc_08 /ipc_18,
         retenciones =retenciones * ipc_08 /ipc_18,
         expo_tc =expo_tc * ipc_08 /ipc_18,
         dif_precios =dif_precios * ipc_08 /ipc_18,
         renta_total = regalias+ retenciones+ expo_tc+ dif_precios,
         unidad = "millones de pesos 2018") %>% 
  ungroup() %>% 
  select(-ipc_08) 
renta_hidrocarburos_fr

#otros autores
renta_autores <- read_csv("C:/Archivos/Datos/Hidrocarburos/Estimacion calculo renta otros/renta_autores.csv", 
    col_types = cols(X1 = col_skip()))


```


# Variables

## Producción

Fuentes: 

* [Ministerio de Hacienda, Informes
Sectoriales](https://www.argentina.gob.ar/economia/politicaeconomica/regionalysectorial/informesproductivos) (1998-hoy). 
* [Secretaría de Energía - Regalias](http://datos.minem.gob.ar/dataset/regalias-de-petroleo-crudo-gas-natural-glp-gasolina-y-condensado) (1998-hoy)
* [Secretaría de Energía - SESCO Downstream](http://datos.minem.gob.ar/dataset/produccion-de-petroleo-y-gas-tablas-dinamicas)(1993-hoy)
* [Anuario de combustibles](http://datos.minem.gob.ar/dataset/anuarios-de-combustibles-1950-1999) (1911-1992)
* Kozulj y Pistonesi. Revista  del Instituto de Economía Energética (IDEE) - Fundación Bariloche  (1970 - 1988)
* [EIA](https://www.eia.gov/international/data/country/ARG/petroleum-and-other-liquids/annual-petroleum-and-other-liquids-production?pd=5&p=0000000000000000000000000000000000vg&u=0&f=A&v=mapbubble&a=-&i=none&vo=value&&t=C&g=none&l=249--6&s=94694400000&e=1546300800000) (1980 - 2019)

### Producción de Crudo


La producción de petróleo crudo de largo plazo proviene del Anuario de Combustibles, de la cual contamos datos desde 1911 hasta 1992. Sus valores para el período 1980-1992 coinciden con los de EIA, por lo cual pueden usarse como fuentes alternativas. Asimismo, la evolución de SESCO es similar a la de EIA, salvo por pequeñas divergencias entre 2008 y 2013. La serie de Regalías presenta un nivel menor que las anteriores debido a las deducciones de producción que realizan las empresas para pagar un menor nivel de Regalías hacia las provincias donde realizan la producción. Por último, la serie del Ministerio de Economía coincide con Regalías en sus primeros años, luego presenta un nivel intermedio entre Regalías y SESCO y a partir de 2009 toma a SESCO como fuente. Salvo el Anuario de Combustibles, el resto de las series presentan datos hasta los últimos años. Por lo tanto, el criterio de selección para la serie de producción con la que se realizarán los cálculos es el siguiente:

* Criterio de cómputo para producicón de crudo: 
  + 1911 a 1992: Anuario de combustibles 
  + 1993 - actualidad: SESCO Downstream



```{r include=FALSE}
# PROCESAR ESTA BASE
mecon_hidrocarburos_df <-  read_csv("C:/Archivos/Datos/Hidrocarburos/Mecon/hidrocarburos.csv", 
    col_types = cols(indice_tiempo = col_date(format = "%d/%m/%Y")), 
    locale = locale(encoding = "ISO-8859-1"))
unique(mecon_hidrocarburos_df$indicador)

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
#Anuario de combustibles
prod_anuario <- read_excel("C:/Archivos/Datos/Hidrocarburos/Produccion/Produccion_Desde_1911 - copia.xls") %>% 
  rename(anio = "AÑO", crudo_anuario_Mm3 = "PETROLEO (Mm3)", 
  gas_h = `GAS NATURAL (Mill. m3)`, carbon_h = `CARBON (MTn) (*)`) %>% 
  mutate(gas_anuario_MMm3   = as.double(gas_h), 
         carbon_anuario_Mtn   = as.double(carbon_h),
         crudo_anuario = crudo_anuario_Mm3 * 1000) %>% 
  select(anio, crudo_anuario, gas_anuario_MMm3, carbon_anuario_Mtn )

# Revista IDEE
# Producción crudo por administración y contratos
cuadro_2.1 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del petroleo crudo y derivados 1970 - 1989.xlsx", 
    skip = 1, sheet = 1) %>% 
  rename(unidad = "...5")

#base Ministerio de Hacienda
hidrocarburos_base_mecon <-  read_csv("C:/Archivos/Datos/Hidrocarburos/Mecon/datasets viejos/hidrocarburos.csv", 
    locale = locale(date_names = "es", encoding = "ISO-8859-1")) %>% 
  mutate(fecha = as.Date(lubridate::parse_date_time(indice_tiempo, orders = "dmy"))) %>% 
  select(fecha, everything(.), -c(1:3, fuente, indice_tiempo,alcance_id))

#lista con indicadores
lista_filtro <- unique(hidrocarburos_base_mecon$indicador)


prod_mecon_crudo <- hidrocarburos_base_mecon %>% 
  filter( indicador == lista_filtro[3],
         actividad_producto_nombre == "Petróleo crudo",
         frecuencia_nombre == "Mensual") %>%  
  mutate(anio = year(fecha)) %>% 
  group_by(anio, actividad_producto_nombre, indicador, unidad_de_medida) %>% 
  summarise(crudo_mecon = sum(valor))


#Base regalias
prod_regalias_crudo <- read_delim("C:/Archivos/Datos/Hidrocarburos/Regalias/produccion_crudo_regalias.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  rename(anio = "AÑO") %>% 
  mutate(unidad = "m3",
         anio =zoo::na.locf(anio),
         fecha = as.Date(parse_date_time(paste0(anio, MES), orders = "ym"))) %>% 
  select(fecha, MES, anio, unidad, "TOTAL CUENCA", everything(.)) %>% 
  rename(prod_crudo_m3 = "TOTAL CUENCA") %>% 
  group_by(anio, unidad ) %>% 
  summarise(crudo_regalias = sum(prod_crudo_m3))

#Base SESCO .csv  (Pre 2009)
prod_sesco_crudo_a <- read_csv("C:/Archivos/Datos/Hidrocarburos/SESCO/produccin-de-petrleo-anterior-al-2009.csv") %>%
  select(anio, mes,idconcepto, concepto, Cantidad ) %>%
  rename(cantidad = Cantidad) %>%
  # filter(!idconcepto %in% c(4, 5, 7, 8, 9	)) %>%
  filter(concepto %in% c("Producción Primaria (m3)","Producción Secundaria (m3)",
                         "Producción por Recuperación Aisistida (m3)")) %>%
  group_by(anio) %>%
  summarise(crudo_sesco = sum(cantidad, na.rm = T)) %>%
  mutate(unidad = "m3")

# Base SESCO (Post 2009)
prod_sesco_crudo_b <- read_csv(
  "C:/Archivos/Datos/Hidrocarburos/SESCO/produccin-de-petrleo-por-yacimiento.csv") %>% 
  select(anio, mes,idconcepto, concepto, cantidad ) %>%
  # filter(!idconcepto %in% c(4, 5, 7, 8, 9	)) %>%
  # filter(idconcepto %in% c(1,2,3, 6))%>%
    filter(concepto %in% c("Producción Primaria (m3)","Producción Secundaria (m3)",
                         "Producción por Recuperación Aisistida (m3)")) %>%
  group_by(anio) %>%
  summarise(crudo_sesco = sum(cantidad, na.rm = T)) %>%
  mutate(unidad = "m3")

prod_sesco_crudo <- prod_sesco_crudo_a %>% 
  bind_rows(prod_sesco_crudo_b)

# SESCO desde 1950
  
prod_sec_energia <- read.csv( "../data/secretaria_energia/sesco/serie-produccion-petroleo-total-pais-desde-1950.csv") %>% 
  mutate(produccion_petroleo = produccion_petroleo*1000,
         unidad = "m3") %>% 
  rename(crudo_sec_energia = produccion_petroleo) 


#EIA

#unidad original = barrels per day

# Total Petroleum and other liquids production = Crude oil, NGPL, and other liquids production + Refinery processing gain
# Crude oil, NGPL, and other liquids production = Crude oil including lease condensate production + Natural gas plant liquids production + Other liquids production

prod_eia_crudo <-  read_csv("C:/Archivos/Datos/EIA/data/oil_production_arg.csv", 
    trim_ws = FALSE, skip = 1) %>% 
  filter(!is.na(API)) %>% 
  select(-API) %>% 
  gather(.,
         key = anio,
         value = valor,
         2:ncol(.)) %>% 
  spread(.,
         key = X2,
         value = valor) %>% 
  rename(total_oil_and_other = `        Total petroleum and other liquids (Mb/d)`,
         crude_oil_condensate = `                Crude oil including lease condensate (Mb/d)`,
         natural_gas = `                NGPL (Mb/d)`,
         other_liquids = `                Other liquids (Mb/d)`,
         crude_oil_ngpl_other_liquids = `            Crude oil, NGPL, and other liquids (Mb/d)`,
         refinery_processing_gain = `            Refinery processing gain (Mb/d)`) %>% 
  mutate_at(.vars = (c("crude_oil_condensate", "natural_gas", "other_liquids", 
                  "crude_oil_ngpl_other_liquids", "refinery_processing_gain"  ,"total_oil_and_other")),
    .funs = function(x) {x * 365 * 1000}) %>% 
  mutate(anio = as.double(anio),
         unidad = "barriles")

#EIA all data
eia_all_data <- read_csv("C:/Archivos/Datos/EIA/data/argentina/INT-Export-09-17-2020_11-15-16.csv", 
    skip = 1)


# Comparación entre series
prod_merge_crudo <-  prod_regalias_crudo %>% 
  left_join(prod_mecon_crudo  %>% 
              select(anio, crudo_mecon)) %>%
  select(anio, unidad, crudo_regalias, crudo_mecon) %>% 
  left_join(prod_sesco_crudo) %>% 
  full_join(prod_anuario %>% 
              select(anio, crudo_anuario) %>% 
              mutate(unidad = "m3")) %>% 
  left_join(prod_sec_energia, by = c("anio", "unidad")) %>% 
  # mutate(dif =  crudo_regalias/crudo_mecon-1) %>% 
  mutate_at(.vars = c(   "crudo_regalias" ,"crudo_mecon",   
                       "crudo_sesco",    "crudo_anuario", "crudo_sec_energia" ), 
            .funs = conversor_m3bbl_q) %>%  
  left_join(prod_eia_crudo %>% 
              select(anio, crudo_eia = crude_oil_condensate)) %>% 
   mutate(prod_crudo =  case_when(anio < 1950 ~ crudo_anuario,
                                  anio %in% 1950:2015 ~crudo_sec_energia , 
                                  anio > 2015 ~ crudo_sesco ),
          unidad = "barriles", 
          variable =  "Producción de crudo según distintas fuentes")  %>%
  arrange(anio) %>% 
  select(anio, variable, unidad, prod_crudo, everything(.)) %>% 
  rename(regalias = crudo_regalias,
         mecon = crudo_mecon,
         sesco = crudo_sesco,
         anuario_combustibles = crudo_anuario,
         eia = crudo_eia) %>% 
  filter(anio < 2021)


# write.csv(prod_merge_crudo, file = "resultados/produccion_crudo.csv")
# writexl::write_xlsx(prod_merge_crudo, 
#                     path = "resultados/produccion_crudo.xlsx")

#diferencia promedio del 6% entre las bases (es mayor la de mecon)
# summary(prod_merge_crudo)


#Existencias
existencias_petroleo <- read_excel("/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/existencias_crudo.xlsx") %>%
  filter(!(is.na(existencias ))) %>% 
  rename(existencias_crudo = existencias) %>% 
  mutate(existencias_crudo = conversor_m3bbl_q(existencias_crudo),
         unidad = "barriles")

# plot(existencias_petroleo$anio, existencias_petroleo$existencias_crudo)

```

<br>
**Tabla 1. Producción de petróleo crudo en Argentina según distintas fuentes (barriles)**
```{r echo=FALSE, message=FALSE, warning=FALSE}
prod_merge_crudo %>% 
  select(-prod_crudo)
 
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplotly(prod_merge_crudo %>% 
  mutate(regalias = case_when(regalias == 0 ~ NA_real_,
                                    T ~ regalias)) %>%
    select(-prod_crudo) %>% 
  gather(key = fuente, value = valor, 4:ncol(.)) %>% 
  ggplot(aes(anio, valor, color = fuente))+
  geom_line()+
  labs(title = "Gráfico 1. Producción de petróleo crudo.
        Argentina (1911 - 2020)",
       y = "Millones de Barriles",
       caption = "Fuente: elaboración propia en base a Anuario de Combustibles, EIA, Ministerio de Economía, Secretaría de Energía (Base Regalías y SESCO)")+
  # scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+
  scale_y_continuous(labels = scales::unit_format(unit ="", scale = 1e-6))+
  theme(legend.position = "bottom"), width = 600, height = 400)
                     
                     
```



### Producción de Gas Natural

Al igual que en la producción de petróleo crudo, la serie de largo plazo de producción de gas proviene del Anuario de Combustibles, de la cual contamos datos desde 1913 hasta 1992. A diferencia del crudo, sus valores para el período 1980-1992 no coinciden con los de EIA, pero está última sí coincide con los de Regalías entre 1999 y 2015. En cambio, la serie de SESCO, tiende a continuar la evolución de EIA y Regalías, pero con el nivel del Anuario de Combustibles, por lo que ambos pares de series pueden empalmar coherentemente según su nivel. Nuevamente, los valores de la base de Regalías son menores debido a las deducciones de producción para tributar menos regalías. La serie del Ministerio de Economía toma los valores de SESCO.Por lo tanto, el criterio de selección para la serie de producción de gas para los cálculos es el siguiente:

* Criterio de cómputo de la producción de gas:
  + 1911 a 1992: Anuario de combustibles 
  + 1993 en adelante: SESCO Downstream

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Base MECON
prod_mecon_gas <- hidrocarburos_base_mecon %>% 
  filter(indicador == lista_filtro[3],
         actividad_producto_nombre == "Gas natural",
         frecuencia_nombre == "Mensual") %>%  
  mutate(anio = year(fecha)) %>% 
  group_by(anio, actividad_producto_nombre, indicador, unidad_de_medida) %>% 
  summarise(gas_mecon = sum(valor))

#Base regalias
prod_regalias_gas <- read_delim("C:/Archivos/Datos/Hidrocarburos/Regalias/produccion_gas_regalias.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  rename(anio = "AÑO") %>% 
  mutate(unidad = "Miles de m3",
         anio = zoo::na.locf(anio),
         fecha = as.Date(parse_date_time(paste0(anio, MES), orders = "ym"))) %>% 
  select(fecha, unidad, "TOTAL CUENCA", everything(.)) %>% 
  rename(prod_gas_Mm3 = "TOTAL CUENCA") %>% 
  group_by(anio, unidad ) %>% 
  mutate_all(as.double) %>% 
  summarise(gas_regalias = sum(prod_gas_Mm3))

#Base SESCO
#pre 2009
prod_sesco_gas_a <- read_csv("C:/Archivos/Datos/Hidrocarburos/SESCO/produccin-de-gas-anterior-al-2009.csv")  %>% 
  select(anio, mes,idconcepto, concepto, Cantidad ) %>%
  rename(cantidad = Cantidad) %>%
  filter(idconcepto != 4) %>%
  group_by(anio) %>%
  summarise(gas_sesco = sum(cantidad, na.rm = T)) %>%
  mutate(unidad = "Miles de m3")

#post 2009
prod_sesco_gas_b <- read_csv("C:/Archivos/Datos/Hidrocarburos/SESCO/produccin-de-gas-por-yacimiento.csv") %>% 
  select(anio, mes,idconcepto, concepto, cantidad ) %>%
  filter(idconcepto %in% c(1,2,3))%>%
  group_by(anio) %>%
  summarise(gas_sesco = sum(cantidad, na.rm = T)) %>%
  mutate(unidad = "Miles de m3")

prod_sesco_gas <- prod_sesco_gas_a %>%
  bind_rows(prod_sesco_gas_b)

#sesco historic
prod_sec_energia_gas <- read.csv( "../data/secretaria_energia/sesco/producciongasnaturaldesde-1950.csv") %>% 
  mutate(produccion_gas_natural = produccion_gas_natural*1000,
         unidad = "Miles de m3") %>% 
  rename(sec_energia_prod = produccion_gas_natural) 



#EIA
prod_eia_dry_natural_gas <- read_csv("C:/Archivos/Datos/EIA/data/Dry_natural_gas_production_Argentina_Annual.csv", 
    skip = 4)  %>% 
  rename(anio = Year,
         prod_eia = `Series ID: INTL.26-1-ARG-BCF.A billion cubic feet`) %>% 
  mutate(prod_eia = conversor_ft3m3_q(prod_eia * 1000000),
         unidad = "Miles de m3")


# Comparación entre series
prod_merge_gas <-  prod_regalias_gas %>% 
  left_join(prod_mecon_gas  %>% 
              select(anio, gas_mecon)) %>%
  select(anio, unidad, gas_regalias, gas_mecon) %>% 
  left_join(prod_sesco_gas) %>%  
  full_join(prod_anuario %>% 
              select(anio, gas_anuario = gas_anuario_MMm3 ) %>% 
              mutate(gas_anuario = gas_anuario * 1000,
                     unidad = "Miles de m3")) %>% 
      left_join(prod_sec_energia_gas %>% select(anio, sec_energia_prod)) %>% 
  left_join(prod_eia_dry_natural_gas %>% rename(gas_eia = prod_eia)) %>% 
  mutate(prod_gas = case_when(anio < 1993 ~ gas_anuario,
                                  anio > 1992 ~ gas_sesco),
          variable =  "Producción de gas según distintas fuentes") %>% 
  arrange(anio) %>% 
  select(anio, variable, unidad, prod_gas, everything(.)) %>% 
   filter(!is.na(prod_gas)) %>% 
  rename(regalias = gas_regalias,
         mecon = gas_mecon,
         sesco = gas_sesco,
         anuario_combustibles =gas_anuario,
         eia = gas_eia) %>% 
  filter(anio < 2021)


# write.csv(prod_merge_gas, file = "resultados/produccion_gas.csv")
# writexl::write_xlsx(prod_merge_gas, 
#                     path = "resultados/produccion_gas.xlsx")

#diferencia promedio del 14% entre las bases (es mayor la de mecon)
# summary(prod_merge_gas)

prod_merge_gas_MMBTU <- prod_merge_gas %>% 
  group_by(anio, variable, unidad) %>% 
  mutate_all(function(x) {conversor_m3MMBTU_q(x*1000)}) %>% 
  ungroup() %>% 
  mutate(unidad = "MMBTU") %>%
  select(anio, unidad, everything(.))
  
prod_merge_gas_bep <- prod_merge_gas_MMBTU %>% 
  group_by(anio, variable, unidad) %>% 
  mutate_all(conversor_MMBTUbep_q) %>% 
  ungroup() %>% 
  mutate(unidad = "BEP")
  
# write.csv(prod_merge_gas_bep, file = "resultados/prod_merge_gas_bep.csv")
```

<br>
**Tabla 2. Producción de gas natural en Argentina según distintas fuentes (MMBTU)**
```{r echo=FALSE, message=FALSE, warning=FALSE}
prod_merge_gas_MMBTU %>% 
  select(-prod_gas)

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplotly(prod_merge_gas_MMBTU %>% 
           select(-prod_gas) %>%
  mutate(regalias = case_when(regalias == 0 ~ NA_real_,
                                    T ~ regalias)) %>% 
  gather(key = fuente, value = valor, 4:ncol(.)) %>% 
  ggplot(aes(anio, valor, color = fuente))+
  geom_line()+
  labs(title = "Gráfico 2. Producción de gas.
        Argentina (1913 - 2020)",
       y = "MMBTU",
       caption = "Fuente: elaboración propia en base a Anuario de Combustibles, EIA, Ministerio de Economía, Secretaría de Energía (Base Regalías y SESCO)")+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+
  theme(legend.position = "bottom"), width = 600, height = 400)
```

### Produccion total
```{r}
produccion_total <- prod_merge_gas_bep %>% 
  select(anio, unidad,prod_gas) %>%
  left_join(prod_merge_crudo %>% 
              select(anio, unidad,prod_crudo) %>%  mutate(unidad ="BEP") ) %>% 
  mutate(produccion_total_bep = prod_crudo + prod_gas)

produccion_total
```




```{r message=FALSE, warning=FALSE, include=FALSE}
## Crudo procesado

```



```{r message=FALSE, warning=FALSE, include=FALSE}
## Ventas
 # Crudo y Gas

# * [SESCO - Refinación y Comercialización de petróleo, gas y derivados](http://datos.minem.gob.ar/dataset/refinacion-y-comercializacion-de-petroleo-gas-y-derivados-tablas-dinamicas)
# 
#  Datos de cantidades
#  
#compras empresas del sector
compras <- read_csv("C:/Archivos/Datos/Hidrocarburos/SESCO/Refinación y comercializacion/compras.csv")

#ventas mdo interno. cantidades. post 2010
ventas_mercado_producto_empresa <- read_csv("C:/Archivos/Datos/Hidrocarburos/SESCO/Refinación y comercializacion/ventas-mercado-producto-empresa.csv", 
    locale = locale(encoding = "ISO-8859-1"))

#ventas mdo interno. cantidades. post 2010
ventas_a_empresas_del_sector <- read_csv("C:/Archivos/Datos/Hidrocarburos/SESCO/Refinación y comercializacion/ventas-a-empresas-del-sector.csv")

```


## Precio Mercado Interno

Fuentes: 

* [Base Ministerio de Hacienda, Informes
Sectoriales](https://www.argentina.gob.ar/economia/politicaeconomica/regionalysectorial/informesproductivos)
* [Secretaría de Energía-Regalias](http://datos.minem.gob.ar/dataset/regalias-de-petroleo-crudo-gas-natural-glp-gasolina-y-condensado)
  + Por ausencia de información, el precio de regalias entre 1993 y 1998 es el precio total (es decir, es un ponderado que incluye también el precio del mercado externo). En los años posteriores, dicho precio sí corresponde al del mercado interno.  
* Kozulj y Pistonesi. Revista  del Instituto de Economía Energética (IDEE) - Fundación Bariloche  (1970 - 1988). Precio oficial interno de la cuenca neuquina a tasa de cambio oficial. Las fuentes utilizadas de esta revista son Secretaria de Energía, YPF, Gas del Estado, Boletin Informativo de Techint y series propias de IDEE
* Memoria Anual y balances contables de YPF (varios años). Precio intero promedio resultante de la relación entre ventas y cantidades producidas.
* Precios anuario. **FALTA BUSCAR**

***ver de donde sacan el TCC***
***cambiar precio del 92 por mecon estimado y valores restantes por estimado de idee***

####  Precio Mercado Interno de Crudo

* Criterio para precio_crudo: 
  + 1963 a 1965: Kozulj y Pistonesi - Revista IDEE ajustado con el índice del precio del Anuario de YPF 
  + 1989 a 1991: Anuario de YPF
  + 1966 a 1988: Kozulj y Pistonesi - Revista IDEE
  + 1992: MECON ajustado con la variación del Índice de precios internos al por mayor (IPIM)
  + 1993 en adelante: MECON 
 
  
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Memorias de YPF
vtas_precio_memo_ypf_crudo <- read_excel("C:/Archivos/Datos/Hidrocarburos/Memoria YPF/vtas_valor_cantidad_precio_crudo.xlsx") %>% 
  rename(cant_vendidad = "m3", valor_vendido = "valor", precio_a = "$/m3", 
         tcc_dic = "Cotiz dic U$S", precio_usd = "U$S (a diciembre de cada año)") %>% 
  mutate(unidad_cant = "m3",
         precio_mi_pesos_ypf_crudo = valor_vendido/cant_vendidad, 
         precio_mi_ypf_crudo = precio_mi_pesos_ypf_crudo / tcc_dic) %>% 
  # left_join(tcp_anual_b %>% select(anio, tcc)) %>%
  # mutate(precio_mi_usd_ypf_crudo = precio_mi_ypf_crudo / tcc) %>% #recalculo de precio con nuevo TC
  select(anio,unidad_cant, moneda, valor_vendido, cant_vendidad, 
         precio_mi_pesos_ypf_crudo,tcc_dic,  precio_mi_ypf_crudo)

# Base MECON
precio_mi_mecon_crudo <- hidrocarburos_base_mecon %>% 
  filter(indicador == lista_filtro[2], 
         actividad_producto_nombre == "Petróleo crudo",
         alcance_tipo == "PAIS") %>%
  mutate(anio = year(fecha)) %>% 
  group_by(anio) %>% 
  summarise(precio_mi_mecon_crudo = mean(valor)) %>% 
  mutate(unidad = "USD/m3")


#MECON / CUENTAS NACIONALES 
precios_mecon <- read_excel("C:/Archivos/Datos/Hidrocarburos/Mecon/base-mineria-e-hidrocarburos cuentas nacionales.xls", 
    sheet = "Precios", skip = 7) %>% 
  rename(anio = "...1",
         mes = "...2",
         precio_cobre_c_lb = "Cotización Bolsa de Londres (LME)",
         precio_oro_usd_ozt =  "Cotización Bolsa de Nueva York (COMEX)",
         precio_plata_usd_ozt = "Cotización London Bullion Market Association (LBMA)",
         precio_cinc_c_lb = "Cotización LME",
         precio_hierro_usd_tn = "67,55% Brasil",
         precio_plomo_usd_tn = "London Metal Exchange",
         precio_gas_me_pesos_Mm3 = "mercado externo...9",
         precio_gas_mi_pesos_Mm3 = "mercado interno...10",
         precio_crudo_me_usd_m3 = "mercado externo...11",
         precio_crudo_me_usd_bbl  = "...12",
         precio_crudo_mi_usd_m3 = "mercado interno...13",
         precio_crudo_mi_usd_bbl  = "...14",
         promedio_brent_dubai_wti_usd_bbl = "Promedio Brent-Dubai-WTI",
         brent_uk_usd_bbl ="Brent  Puertos Gran Bretaña") %>% 
  filter(!is.na(anio)) %>% 
  mutate_all(as.double) %>% 
  group_by(anio) %>% 
  summarise(precio_gas_me_pesos_Mm3 = mean(precio_gas_me_pesos_Mm3, na.rm = T),
            precio_gas_mi_pesos_Mm3 = mean( precio_gas_mi_pesos_Mm3, na.rm = T),
            precio_crudo_me_usd_bbl = mean( precio_crudo_me_usd_bbl, na.rm = T),
            precio_crudo_mi_usd_bbl = mean( precio_crudo_mi_usd_bbl, na.rm = T),
            promedio_brent_dubai_wti_usd_bbl = mean( promedio_brent_dubai_wti_usd_bbl, na.rm = T),
            brent_uk_usd_bbl = mean( brent_uk_usd_bbl, na.rm = T)) %>% 
  left_join(tcp_anual) %>% 
  mutate( precio_crudo_me_pesos_bbl =  precio_crudo_me_usd_bbl *TCC,
          precio_crudo_mi_pesos_bbl =  precio_crudo_mi_usd_bbl *TCC)


## Base regalias
precio_mi_regalias_crudo <- read_delim("C:/Archivos/Datos/Hidrocarburos/Regalias/precio_mercado_interno_crudo_regalias.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE) %>%
  rename(anio = "AÑO",
         mes = "MES",
         total_tipo_crudo = "TOTAL TIPO DE CRUDO") %>% 
    mutate(unidad = "USD/m3",
         anio = na.locf(anio)) %>%  
  select(anio, mes, unidad, total_tipo_crudo, everything(.), -c(BRENT, WTI)) %>% 
  gather(.,
         key = "tipo_crudo",
         value = "valor",
         5:ncol(.)) %>% 
  group_by(anio, unidad) %>%
  summarise(precio_mi_regalias_crudo = mean(total_tipo_crudo),
            precio_promedio_tipo_crudo = mean(valor)) %>% 
  mutate(tipo_precio = "mercado interno")

# Revista IDEE
# precios internos vs precio promedio interno de eeuu vs precio arabai saudita. cuadro 3.1.3.1 p.170
precio_mi_vs_internacional_idee_crudo <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del petroleo crudo y derivados 1970 - 1989.xlsx", 
    skip = 1, sheet = 4)


#merge
precio_mi_crudo <- precio_mi_regalias_crudo %>%  
  select(anio, unidad, precio_mi_regalias_crudo) %>% 
  left_join(precio_mi_mecon_crudo ) %>% 
  full_join(vtas_precio_memo_ypf_crudo %>% 
              select(anio,   precio_mi_ypf_crudo )) %>% 
  left_join(precio_mi_vs_internacional_idee_crudo %>% 
              select(anio, precio_mi_idee_crudo = precio_crudo_neuquina_tc_oficial )) %>% 
  mutate(unidad = "USD/m3") %>% 
  mutate_at(.vars = c("precio_mi_regalias_crudo", 
                      "precio_mi_mecon_crudo", "precio_mi_ypf_crudo", "precio_mi_idee_crudo"), 
            .funs = conversor_m3bbl_p) %>% 
  left_join(precios_mecon %>% 
              select(anio, precio_mi_mecon_ccnn_crudo = precio_crudo_mi_usd_bbl )) %>% 
  left_join(ipim_base94 %>% 
              select(anio, ipim_nivel_gral_94), by = "anio") %>% 
  rename(regalias = precio_mi_regalias_crudo,
         mecon = precio_mi_mecon_crudo,
         ypf = precio_mi_ypf_crudo,
         idee = precio_mi_idee_crudo,
         mecon_ccnn = precio_mi_mecon_ccnn_crudo) %>% 
  arrange(anio) %>% 
  ungroup()
precio_mi_crudo <-  precio_mi_crudo %>% 
  mutate( unidad = "USD/barriles",
           variable =  "Precio del mercado interno del petróleo crudo según distintas fuentes",
          mecon_estimado = precio_mi_crudo$mecon[precio_mi_crudo$anio==1994]*ipim_nivel_gral_94,
          indice_ypf_72 = generar_indice(serie = ypf, fecha = anio, fecha_base = 1972),
         idee_estimado = precio_mi_crudo$idee[precio_mi_crudo$anio==1972] * indice_ypf_72,
         precio_crudo_mdoint =   case_when(
                anio %in% 1963:1965 ~ idee_estimado,
                anio %in% 1966:1988 ~ idee,
                anio %in% 1989:1991 ~ ypf,
                anio == 1992 ~ mecon_estimado,
                anio >1992 ~ mecon)) %>% 
  select(anio, unidad, variable, precio_crudo_mdoint , everything(.), 
         -c(ipim_nivel_gral_94, idee_estimado,mecon_estimado,indice_ypf_72,idee_estimado )) %>% 
  filter(anio < 2021)

  
  
# writexl::write_xlsx(precio_mi_crudo, path = "resultados/precio_mi_crudo.xlsx")

# writexl::write_xlsx(precio_mi_vs_internacional_idee_crudo %>% 
#                       select(anio,  precio_crudo_neuquina_tc_oficial ) %>% 
#                       spread(.,
#                              key = anio,
#                              value = precio_crudo_neuquina_tc_oficial) %>% 
#                       mutate(variable = "precio_crudo_neuquina_tc_oficial en USD/m3") %>%
#                       select(variable, everything(.)),
#                     path = "precio_mi_vs_internacional_idee_crudo.xlsx")
```

<br>
**Tabla 3. Precio del mercado interno del petróleo crudo en Argentina según distintas fuentes (barriles)**
```{r echo=FALSE, message=FALSE, warning=FALSE}
precio_mi_crudo %>% 
  select(-precio_crudo_mdoint)
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplotly(precio_mi_crudo %>% 
      select(-precio_crudo_mdoint) %>% 
      mutate(regalias = 
               case_when(regalias == 0 ~ NA_real_,
                          T ~ regalias)) %>% 
  gather(key = variable, value = valor, 4:ncol(.)) %>% 
  ggplot(aes(anio, valor, color = variable, shape = variable))+
  geom_line(alpha = 0.8)+
  labs(title = "Gráfico 3. Precios del mercado interno del petróleo crudo.
       Argentina (1963 - 2020)",
       y = "USD/barril")+
  theme(legend.position = "bottom"), width = 800, height = 600)
                     
```


#### Precio Mercado Interno de Gas Natural
* Precio Mercado Interno de gas:
  + 1963 - 1969 & 1989 - 1992: Anuario de YPF
  + 1970 - 1988:  Kozulj y Pistonesi - Revista IDEE
  + 1993 en adelante: Secretaría de Energía - Base Regalías


```{r echo=FALSE, message=FALSE, warning=FALSE}
#Anuario YPF
vtas_precio_memo_ypf_gas <- read_excel("C:/Archivos/Datos/Hidrocarburos/Memoria YPF/vtas_valor_cantidad_precio_gas.xlsx") %>% 
    rename(cant_vendidad = "m3", valor_vendido = "$", moneda = "Moneda") %>% 
  left_join(vtas_precio_memo_ypf_crudo %>% select(anio, moneda, tcc_dic )) %>% 
  mutate(precio_mi_ypf_gas_moneda_original = (valor_vendido/cant_vendidad) / 1000,
         precio_mi_usd_ypf_gas = precio_mi_ypf_gas_moneda_original / tcc_dic,
         precio_mi_ypf_gas = case_when( #homogenizamos los cambios de moneda
           moneda == "m$n" ~ precio_mi_ypf_gas_moneda_original/conversor_pesos$`m$n` ,
           moneda == "$ley" ~ precio_mi_ypf_gas_moneda_original/conversor_pesos$`$Ley`, 
           moneda == "$arg" ~ precio_mi_ypf_gas_moneda_original/conversor_pesos$`$a`, 
           moneda == "A" ~ precio_mi_ypf_gas_moneda_original/conversor_pesos$A,
           T ~ precio_mi_ypf_gas_moneda_original),
         moneda = "ars",
         unidad = "ars/Miles de m3") %>% #aclaramos la unidad monetaria ya transformada
  select(anio, unidad, moneda, valor_vendido, cant_vendidad, 
         precio_mi_ypf_gas,precio_mi_ypf_gas_moneda_original, tcc_dic, precio_mi_usd_ypf_gas)

#Anuario Combustible
anuario_de_combustible <- read_excel("C:/Archivos/Datos/Hidrocarburos/Anuario Combustibles/anuario de combustible.xlsx") %>% 
  filter(mercancia == "gas_natural") %>% 
  group_by(anio ,     mes,      unidad ) %>% 
  summarise(precio_mi_anuario_gas = mean(valor)) %>% 
  group_by(anio ,       unidad ) %>% 
  summarise(precio_mi_anuario_gas = mean(precio_mi_anuario_gas)) %>% 
  mutate(precio_mi_anuario_gas = (precio_mi_anuario_gas/conversor_pesos$A)/1000,
         unidad = "ars/Miles de m3")

# Base MECON
precios_internos_mecon_gas <- hidrocarburos_base_mecon %>% 
  filter(indicador == lista_filtro[2], 
         actividad_producto_nombre == "Gas natural",
         alcance_tipo == "PAIS") %>%
  mutate(anio = year(fecha)) %>% 
  group_by(anio) %>% 
  summarise(precio_mi_mecon_gas = mean(valor)) %>% 
  mutate(unidad = "ars/Miles de m3")


## Base regalias
#valores 93 - 98
precio_regalias_total_gas <- read_excel("C:/Archivos/Datos/Hidrocarburos/Precios/precio_mi_gas.xlsx",
    sheet = "jk") %>% 
  filter(anio < 1999) %>% 
  mutate(precio_total_gas = precio_mi_gas * 1000,
         unidad = "ars/Miles de m3") %>% 
  select(-precio_mi_gas)

#valores post 99
precio_regalias_mi_gas <- read_delim("C:/Archivos/Datos/Hidrocarburos/Regalias/precio_mercado_interno_gas_regalias.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE) %>%
  rename(anio = "AÑO",
         mes = "MES",
         total_cuenca = "TOTAL CUENCA") %>% 
  mutate(unidad = "ars/Miles de m3",
         anio = na.locf(anio)) %>% 
  select(anio, mes, unidad,  everything(.)) %>% 
  gather(.,
         key = "cuenca",
         value = "valor",
         4:ncol(.)) %>% 
  mutate(valor = gsub(",", "", valor),
         valor = as.double(valor)) %>% 
  group_by(anio, unidad, cuenca) %>% 
  summarise(precio_promedio_cuenca = mean(valor))%>% 
  mutate(tipo_precio = "mercado interno") %>% 
  filter(cuenca == "total_cuenca")%>%  #quito precio promedio elaborado pq no se usará
  left_join(precio_regalias_total_gas) %>% 
  mutate(precio_mi_regalias_gas = case_when(anio < 1999 ~ precio_total_gas,
                                            T ~ precio_promedio_cuenca)) %>% 
  select(-c(precio_total_gas, precio_promedio_cuenca))

#Revista IDEE
#precio transferencia, regalias, compensaciones, etc promedio anual
precio_mi_idee_gas <- read_excel("C:/Archivos/Datos/Hidrocarburos/Revistas Políticas de Precios de la Energia en Arg 1970-1988/Precios del gas natural y derivados 1970 - 1988.xlsx", 
    skip = 1, sheet = 2) %>% 
  select(anio, unidad, precio_transferencia) %>% 
  left_join(ipc_promedio %>% select(anio, ipc_70)) %>%
  mutate(precio_mi_indexado_pesos = precio_transferencia * ipc_70 / conversor_pesos$`$Ley`) %>% 
  left_join(tcp_anual_b %>% select(anio, tcc) ) %>% 
  mutate(precio_mi_indexado_usd = precio_mi_indexado_pesos/tcc )  
  # select(-c(unidad, precio_transferencia))

# writexl::write_xlsx(precio_mi_idee_gas, path = "precio_mi_idee_gas.xlsx")

#conversor de moneda 
# %>% 
#   mutate(precio_transferencia = case_when(
#     anio < 1983 ~ precio_transferencia/conversor_pesos$`$Ley`,
#     anio == 1983 ~ precio_transferencia / conversor_pesos$`$a`,
#     anio %in% 1983:1991 ~ precio_transferencia/conversor_pesos$A))

#Merge
precio_mi_gas <- precio_regalias_mi_gas %>% 
  select(anio, unidad, precio_mi_regalias_gas) %>% 
  left_join(precios_internos_mecon_gas) %>% 
  full_join(vtas_precio_memo_ypf_gas %>% 
              select(anio, unidad,  precio_mi_ypf_gas )) %>% 
  left_join(precio_mi_idee_gas %>% 
                      select(anio,  precio_mi_idee_indexado = precio_mi_indexado_pesos)) %>%
                             # precio_mi_idee_ctes_pesos = precio_transferencia)) %>% 
  left_join(anuario_de_combustible) %>% 
  left_join(precios_mecon %>% 
              select(anio , precio_mi_mecon_ccnn_gas = precio_gas_mi_pesos_Mm3)) %>% 
  # mutate(precio_gas_mdoint = case_when(anio < 1988 ~ precio_mi_ypf_gas,
  #                                  anio == 1988 ~  precio_mi_idee_indexado,
  #                                  anio %in% 1989:1991  ~ precio_mi_ypf_gas,
  #                                  anio == 1992  ~ precio_mi_ypf_gas/10,
  #                                  anio > 1992 ~ precio_mi_regalias_gas),
  #        dif_ypf_idee = precio_mi_ypf_gas/precio_mi_idee_indexado-1 ) %>%
  mutate(variable = "Precio del mercado interno del gas natural según distintas fuentes",
         precio_gas_mdoint = case_when(anio %in% 1963:1969|anio %in% 1989:1991 ~
                                           precio_mi_ypf_gas, 
                                         anio %in% 1970:1988 ~ precio_mi_idee_indexado,
                                         anio == 1992  ~ precio_mi_ypf_gas,
                                         anio > 1992 ~ precio_mi_regalias_gas) ) %>% 
  arrange(anio) %>%
  select(anio, unidad,variable, precio_gas_mdoint, everything(.) ) %>% 
  rename(regalias = precio_mi_regalias_gas,
         mecon = precio_mi_mecon_gas,
         ypf = precio_mi_ypf_gas,
         idee = precio_mi_idee_indexado,
         mecon_ccnn = precio_mi_mecon_ccnn_gas,
         anuario = precio_mi_anuario_gas) %>% 
  filter(anio < 2021)

#precio interno en MMBTU pesos
precio_mi_gas_MMBTU <-  precio_mi_gas %>% 
  group_by(anio) %>% 
  select(-c(unidad, variable)) %>% 
  mutate_all( function(x) {conversor_m3MMBTU_p(x/1000)}) %>% 
  mutate(unidad = "ars/MMBTU") %>% 
  select(anio, unidad, everything(.))

#precio interno en MMBTU usd
precio_interno_gas_mmbtu_usd <- precio_mi_gas_MMBTU %>%
  # select(-dif_ypf_idee) %>% 
  gather(key = tipo_precio,
         value = valor,
         3:ncol(.)) %>%
 left_join(tcp_anual_b, by = "anio") %>%
  mutate(valor = valor/ tcc,
         unidad = "USD/MMBTU") %>% 
  select(-c(tcc,tcp, sobrevaluacion)) %>% 
  spread(key = tipo_precio,
         value = valor)


# writexl::write_xlsx(precio_mi_gas, path = "resultados/precio_mi_gas.xlsx")

#precio revista transpuesto
# writexl::write_xlsx(precio_mi_idee_gas %>% 
#                       select(anio,  precio_transferencia_ypf_a_GE =precio_transferencia ) %>% 
#                       spread(.,
#                              key = anio,
#                              value = precio_transferencia_ypf_a_GE) %>% 
#                       mutate(variable = "precio_transferencia_ypf_a_GE en pesos de 1970/1000 m3") %>%
#                       select(variable, everything(.)),
#                     path = "precio_mi_idee_gas.xlsx")

# graf_mi_gas <- precio_mi_idee_gas %>% 
#   select(anio, precio_mi_indexado_pesos, precio_mi_indexado_usd) %>% 
#   gather(.,
#          key = variable ,
#          value = valor,
#          2:3) %>%
#   filter(variable =="precio_mi_indexado_usd" ) %>% 
#   ggplot(aes(anio, valor, color = variable))+
#   geom_line()
# graf_mi_gas

# precio_mi_gas %>% 
#   filter(anio > 2000) %>% 
#   select(anio, precio_gas_mdoint, precio_mi_mecon_ccnn_gas)
```

<br>
**Tabla 4. Precio del mercado interno del gas natural en Argentina según distintas fuentes (barriles)**
```{r echo=FALSE, message=FALSE, warning=FALSE}
precio_mi_gas %>% 
  select(-precio_gas_mdoint)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
graf_precio_interno_gas_mmbtu <- precio_mi_gas_MMBTU %>%
  # select(-c(dif_ypf_idee, precio_gas_mdoint)) %>% 
  select(-c( precio_gas_mdoint)) %>% 
  gather(key = tipo_precio,
         value = valor,
         3:ncol(.)) %>%
 left_join(tcp_anual_b, by = "anio") %>%
  mutate(valor = valor/ tcc) %>%
  ggplot(aes(x = anio, y = valor, color = tipo_precio))+
  geom_line() +
  theme(legend.position = "bottom")+
  # theme(legend.position = "none")+
  labs(title = "Gráfico N°4. Precio del mercado interno del gas natural.
       Argentina (1963 - 2018)", 
       y = "USD/MMBTU")
ggplotly(graf_precio_interno_gas_mmbtu, width = 800, height = 600)
```


## Precios de Referencia del Mercado Mundial
Precios de exportación desde Argentina, benchmarks y Precios del mercado de EEUU (solo gas, internos y de expo/impo)

* [Secretaría de Energía-Regalias](http://datos.minem.gob.ar/dataset/regalias-de-petroleo-crudo-gas-natural-glp-gasolina-y-condensado)) (2006-hoy)
* [MECON](http://datos.minem.gob.ar/dataset/precio-de-exportacion-de-petroleo-crudo). Serie corta y sin transformaciones
* EIA
  + [Brent](https://www.eia.gov/dnav/pet/hist/RBRTED.htm) (1987-hoy)
  + [WTI](https://www.eia.gov/dnav/pet/hist/rwtcD.htm) (1986-hoy)
  + [Henry Hub](https://www.eia.gov/dnav/ng/hist/rngwhhdd.htm) (1997-hoy)
  + [Precio Gas de Boca de Pozo en EEUU](https://www.eia.gov/dnav/ng/hist/n9190us3A.htm)
* [Inflation Data](https://inflationdata.com/articles/inflation-adjusted-prices/historical-crude-oil-prices-table/) (1946-hoy)
* [Eurostat](https://ec.europa.eu/eurostat/web/energy/data/database)
* Revista IDEE   
  + Precio de Importación de gas natural desde Bolivia (1970-1988)
* [UN Comtrade](https://comtrade.un.org/data/)
  + Precio de Exportación e Importación de gas y crudo (a Bolivia y promedio mundial)
  + El precio impo bolivia de  UN Comtrade cierra, da valores coherentes pero no deberia, dado que la conversión deberia realizarse multiplicando el precio en Mm3 por 1000 y ahí recién realizar la conversión
  

#### Precios de Referencia del Crudo
* Fuentes seleccionadas para precio_me_crudo: 
  + entre 1962 y 1992: precio de exportación argentina de UN Comtrade (clasificación SITC as reported)
  + entre 1993-2001 y 2004-2014: precio de exportación argentina de Mecon
  + entre 2002 y 2003: precio de exportación de Argentina de UN Comtrade (Clasificación HS as reported)
  + 2014 en adelante: precio de exportación argentina de Secretaría de Energía (Regalías)
  + Valores faltantes previos a 1992 (1970 - 1985): Brent (Fuente: Inflation Data)


**Falta construir una paridad de expo/impo con el flete**

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Base regalias
precio_me_regalias_crudo <- read_delim("C:/Archivos/Datos/Hidrocarburos/Regalias/precio_mercado_externo_crudo_regalias.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE) %>%
  rename(anio = "AÑO",
         mes = "MES",
         total_tipo_crudo = "TOTAL TIPO DE CRUDO") %>% 
  mutate(unidad = "USD/m3",
         anio = na.locf(anio)) %>%
  select(anio, mes, unidad, total_tipo_crudo, everything(.), -c(BRENT, WTI)) %>% 
  gather(.,
         key = "tipo_crudo",
         value = "valor",
         5:ncol(.)) %>% 
  group_by(anio, unidad) %>%
  summarise(precio_total_tipo_crudo = mean(total_tipo_crudo)) %>% 
            # precio_promedio_tipo_crudo = mean(valor))%>% 
  mutate(tipo_precio = "mercado externo",
         precio_total_tipo_crudo = conversor_m3bbl_p(precio_total_tipo_crudo),
         unidad = "USD/barriles")

# Mecon MODIFICAR 
precio_exportacion_crudo <- read_excel("C:/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/precio-exportacion-crudo.xlsx", 
    skip = 2)

#INDEC ComEx
precio_expo_indec <- read_csv("C:/Archivos/Datos/INDEC/ComEx/precio_anual_promedio_expo_hidro_indec.csv",  col_types = cols(X1 = col_skip())) %>% 
  left_join(tcp_anual %>% select(-TCP))  %>% 
  mutate( precio_expo_gas_indec = (precio_expo_gas_indec) * TCC,
                      unidad_gas = "ars/Miles de m3"	)
  # mutate(precio_expo_gas_indec = precio_expo_gas_indec * TCC, 
  #        unidad = case_when(unidad == "USD/Miles de m3" ~ "ars/Miles de m3",
  #                           T ~ unidad))

#UN COMTRADE
expo_crudo_uncomtrade_hs <- read_csv("C:/Archivos/Datos/UN Comtrade/expo_crudo_uncomtrade_hs.csv") %>% 
  mutate(unidad_precio = "USD/barriles",
         unidad_valor = "USD",
         unidad_cantidad = "barriles") %>% 
  rename(anio = Period,
         precio_expo_comtrade_hs_crudo = expo_precio_bbl, 
         expo_usd_comtrade_crudo = "Trade Value (US$)")

expo_crudo_sitc <- read_csv("C:/Archivos/Datos/UN Comtrade/expo_crudo_sitc.csv") %>% 
  mutate(unidad_precio = "USD/barriles",
         unidad_valor = "USD",
         unidad_cantidad = "barriles") %>% 
  rename(anio = Period,
         precio_expo_comtrade_sitc_crudo = expo_precio_bbl, 
         expo_usd_comtrade_crudo = "Trade Value (US$)")

#Merge bases
precio_expo_crudo <- precio_me_regalias_crudo %>% 
  rename(precio_expo_regalias_crudo = precio_total_tipo_crudo) %>% 
  select(-tipo_precio) %>% 
  left_join(precios_mecon %>% 
              select(anio, precio_expo_mecon_crudo = precio_crudo_me_usd_bbl )) %>%
  left_join(precio_expo_indec %>% 
              select(-c(precio_expo_gas_indec, unidad_gas))) %>%
  left_join(expo_crudo_uncomtrade_hs %>% 
              select(anio, unidad = unidad_precio, precio_expo_comtrade_hs_crudo)) %>% 
  full_join(expo_crudo_sitc %>% 
              select(anio, unidad = unidad_precio, precio_expo_comtrade_sitc_crudo)) %>%
  arrange(anio) %>% 
  # mutate(precio_expo_crudo = case_when(anio < 1993 ~ precio_expo_comtrade_sitc_crudo,
  #                                    anio %in% 1993:2014 ~ precio_expo_mecon_crudo,
  #                                    anio > 2014 ~ precio_expo_regalias_crudo)) %>% 
  # select(anio, unidad, precio_expo_crudo, everything(.), -TCC)
  select(anio, unidad, everything(.), -TCC)
# precio_expo_crudo

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
### Precio Referencia Mercado Externo Crudo
#Brent
brent_a <- read_excel("C:/Archivos/Datos/Hidrocarburos/Precios/brent.xlsx", 
    skip = 4)%>%  
  rename(anio = Year, brent_nominal = `Nominal Price`, brent_adjusted = `Inflation Adjusted Price`)  %>% 
  mutate(unidad = "USD/barriles",
         anio = as.double(anio)) 


brent_daily  <-  read_excel("C:/Archivos/Datos/Hidrocarburos/Precios/RBRTEd.xls", 
    sheet = "Data 1", skip = 2) %>%
  rename(fecha = Date, brent_spot = `Europe Brent Spot Price FOB (Dollars per Barrel)`) %>% 
  mutate(unidad = "USD/barriles",
         fecha = as.Date(fecha), 
         anio = year(fecha)) 

brent_IEA  <-  brent_daily %>% 
  group_by(unidad, anio) %>% 
  summarise(brent_spot = mean(brent_spot))

brent <- brent_a %>%
  select(-brent_adjusted) %>% 
  left_join(brent_IEA) %>% 
  # mutate(dif = brent_spot/brent_nominal - 1) %>% 
  select(anio, unidad, everything(.)) %>% 
  rename(brent_iea = brent_spot,
         brent_historic = brent_nominal)

#WTI 
wti_EIA_daily <- read_excel("C:/Archivos/Datos/EIA/data/RWTCd.xls", 
    sheet = "Data 1", skip = 2) %>% 
  rename(wti_eia = `Cushing, OK WTI Spot Price FOB (Dollars per Barrel)` ) %>% 
  mutate(mes = month(Date),
         anio = year(Date),
         unidad = "USD/barriles")

wti_EIA <- wti_EIA_daily %>% 
  group_by(anio, unidad) %>% 
  summarise(wti_eia = mean(wti_eia, na.rm = T))

wti_fred <- read_csv("C:/Archivos/Datos/FRED/WTISPLC.csv")  %>%
  rename(wti_spot_price = WTISPLC) %>% 
  mutate(anio = year(DATE),
         unidad = "USD/barriles") %>% 
  group_by(anio, unidad) %>% 
  summarise(wti_spot_price_fred = mean(wti_spot_price))
  
wti_retencion_04 <- wti_EIA_daily  %>% 
  filter(anio > 2003 ) %>% 
  group_by(anio, mes) %>% 
  summarise(wti = mean(wti_eia)) %>% 
  mutate(retencion = case_when(wti < 32 ~ 0.25,
                               wti >= 32 & wti < 34.99 ~ 0.28,
                               wti >= 35 & wti < 36.99 ~ 0.31,
                               wti >= 37 & wti < 38.99 ~ 0.34,
                               wti >= 39 & wti < 40.99 ~ 0.37,
                               wti >= 41 & wti < 42.99 ~ 0.40,
                               wti >= 43 & wti < 44.99 ~ 0.43,
                               wti >= 45 ~ 0.45)) %>% 
  group_by(anio) %>% 
  summarise(retencion = mean(retencion))


wti_retencion_07 <- wti_EIA_daily %>% 
  filter(anio %in% c( 2007:2014), Date > "2007-11-02" ) %>% 
  mutate(retencion = case_when(wti_eia >= 60.9 ~ (wti_eia - 42)/42 ,
                               wti_eia < 60.9 ~ 0.45)) %>% 
  group_by(anio) %>% 
  summarise(wti_eia = mean(wti_eia),
            retencion =  mean(retencion))

brent_rentencion_14 <-  brent_daily %>%
   filter(anio %in% c( 2014:2015), fecha > "2007-11-02" ) %>%
  mutate(retencion = case_when(brent_spot >= 71 ~ (brent_spot - 70)/70,
                               brent_spot < 71 ~ 0.01)) %>% 
   group_by(anio) %>% 
  summarise(brent_spot = mean(brent_spot),
            retencion =  mean(retencion))
  
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
#Precio de exportacion y referencia. Merge de bases
precios_referencia_y_expo_crudo <-  precio_expo_crudo  %>%   
  full_join(brent )%>% #select(-dif)) %>% 
  left_join(wti_EIA ) %>% 
  full_join(wti_fred) %>% 
  mutate(precio_expo_crudo_indec = case_when(precio_expo_crudo_indec > 300 ~ NA_real_,
                                             T ~ precio_expo_crudo_indec),
         precio_me_crudo = case_when(anio %in% 1993:2001 | anio %in% 2004:2014 ~ precio_expo_mecon_crudo,
                                     anio %in% 2002:2003 ~ precio_expo_comtrade_hs_crudo,
                                     anio > 2014 ~ precio_expo_regalias_crudo,
                                     is.na(precio_expo_comtrade_sitc_crudo) ~ brent_historic,
                                     anio < 1993 ~ precio_expo_comtrade_sitc_crudo)) %>% 
  select(anio, unidad, precio_me_crudo, everything(.)) %>% 
  arrange(anio) %>% 
  filter(anio < 2021)


# writexl::write_xlsx(precios_referencia_y_expo_crudo, 
#                     path = "resultados/precio_expo_y_mdo_mundial_crudo.xlsx")
precios_referencia_y_expo_crudo %>% 
  select(-precio_me_crudo)


graf_precio_mdo_mundial_crudo <- precios_referencia_y_expo_crudo %>% 
  select(-precio_me_crudo) %>% 
  gather(key = tipo_precio,
         value = valor,
         3:ncol(.)) %>%
  # filter(!(tipo_precio %in% c("precio_gas_bolivia_usd_idee", "precio_impo_gas_bolivia_MMBTU_comtrade",
  #                             "precio_expo_gas_comtrade", "precio_expo_gas_indec"))) %>%
  # filter(anio != 2002 & tipo_precio != "precio_expo_crudo_indec") %>%
  ggplot(aes(x = anio, y = valor, color = tipo_precio))+
  geom_line(alpha = 0.9) +
  theme(legend.position = "bottom")+
  labs(title = "Precios de exportación y referencia del mercado mundial del crudo", 
       y = "USD/barriles")

ggplotly(graf_precio_mdo_mundial_crudo, width = 600, height = 400)

```

#### Precios de Referencia del Gas

* Criterio de precio_externo_gas:
  + Años 1964 y 1965: Precio de importación de gas proveniente de Bolivia hacia Argentina de UN Comtrade
  + 1966 en adelante: Precio de exportacion de gas desde Bolivia a Argentina de UN Comtrade
  + Datos faltantes para los años previos a 1963 y período 1968-1971

##### Exportación Argentina

```{r echo=FALSE, message=FALSE, warning=FALSE}
### Precio de Exportación del Gas 
#regalias
precio_expo_regalias_gas <- read_delim("C:/Archivos/Datos/Hidrocarburos/Regalias/precio_mercado_externo_gas_regalias.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE) %>%
   rename(anio = "AÑO",
         mes = "MES",
         total_cuenca = "TOTAL CUENCA") %>% 
   mutate(unidad = "ars/Miles de m3",
          anio = na.locf(anio)) %>% 
  select(anio, mes, unidad, everything(.)) %>% 
  gather(.,
         key = "cuenca",
         value = "valor",
         4:ncol(.)) %>% 
  group_by(anio, unidad, cuenca) %>%
  mutate(valor = gsub(",", "", valor),
         valor = as.double(valor)) %>%  
  summarise(precio_expo_gas_regalias = mean(valor, na.rm = T)) %>% 
  mutate(tipo_precio = "mercado externo") %>%
  filter(cuenca == "total_cuenca")%>%
  arrange(anio)

#comtrade
expo_gas_comtrade <- read_csv("C:/Archivos/Datos/UN Comtrade/resultados/expo_gas_sitc.csv") %>% 
  left_join(tcp_anual_b %>% select(anio, tcc)) %>% 
  mutate(expo_precio_MMBTU = conversor_m3MMBTU_p(expo_precio_Mm3 ),
         expo_precio_Mm3_ars = expo_precio_Mm3 * tcc) 

#merge de bases
#precio en pesos
precio_expo_gas <- expo_gas_comtrade %>% 
  mutate(unidad = "ars/Miles de m3") %>% 
  select(anio, unidad, precio_expo_gas_comtrade = expo_precio_Mm3_ars) %>% 
  full_join(precio_expo_regalias_gas %>% 
              select(-c(cuenca, tipo_precio))) %>%
  left_join(precio_expo_indec %>%
              select(anio, unidad = unidad_gas, precio_expo_gas_indec) %>% 
              filter(!(is.na(precio_expo_gas_indec)))) %>% 
  left_join(precios_mecon %>% 
              select(anio, precio_expo_gas_mecon = precio_gas_me_pesos_Mm3))


#precios en dolares
precio_expo_gas_usd <- expo_gas_comtrade  %>%  
  select(anio,  precio_expo_gas_comtrade = expo_precio_MMBTU) %>%
  left_join( precio_expo_gas %>% select(-c(precio_expo_gas_comtrade, unidad)), by = "anio") %>% 
  left_join(tcp_anual %>% select(-TCP)) %>%
  mutate(precio_expo_gas_regalias = (precio_expo_gas_regalias/1000) / TCC, 
         precio_expo_gas_indec = (precio_expo_gas_indec )/ TCC, 
         precio_expo_gas_mecon = (precio_expo_gas_mecon/1000)/ TCC,
         unidad = "USD/MMBTU") %>% 
  mutate_at(.vars = c("precio_expo_gas_regalias", "precio_expo_gas_indec", "precio_expo_gas_mecon"),
            .funs = conversor_m3MMBTU_p) %>% 
  select(anio, unidad, everything(.),-TCC)


```

##### Referencias mundiales

```{r echo=FALSE, message=FALSE, warning=FALSE}
### Precio Referencia Mercado Externo Gas 
#### Precios Mundiales
#henry_hub EIA
henry_hub <- read_excel("C:/Archivos/Datos/Hidrocarburos/Precios/RNGWHHDd.xls", 
    sheet = "Data 1", skip = 2) %>% 
  rename( date = Date,
    henry_hub_spot = `Henry Hub Natural Gas Spot Price (Dollars per Million Btu)`) %>% 
  mutate(unidad = "USD/MMBTU",
         anio = year(date)) %>% 
  group_by(anio, unidad) %>% 
  summarise(eia_henry_hub_spot = mean(henry_hub_spot, na.rm = T)) 

henry_hub_ars <-  henry_hub %>% 
  left_join(tcp_anual %>% 
              select(anio, TCC)) %>% 
  mutate(henry_hub_spot = conversor_MMBTUm3gas_p(eia_henry_hub_spot *1000*TCC),
         unidad= "ars/Miles de m3")

# Precio USA boca de pozo EIA          unidad = "USD/ft3"
wellhead_price_eeuu <- read_excel("C:/Archivos/Datos/EIA/data/natural_gas_wellhead_price_eeuu.xls", 
    sheet = "Data 1", skip = 2) %>% 
  rename(us_wellhead_price_ft3 = "U.S. Natural Gas Wellhead Price (Dollars per Thousand Cubic Feet)") %>%  
  mutate( us_wellhead_price_Mm3 = conversor_ft3m3_p(us_wellhead_price_ft3*1000),
          us_wellhead_price_MMBTU = conversor_ft3MMBTU_p(us_wellhead_price_ft3/1000),
          anio = year(Date),
         unidad  = "USD") 

#otros precios de USA EIA
price_eeuu <- read_excel("C:/Archivos/Datos/EIA/data/natural_gas_prices_usa.xls", 
    sheet = "Data 1", skip = 2) %>% 
  rename(us_wellhead_gas_price = `U.S. Natural Gas Wellhead Price (Dollars per Thousand Cubic Feet)`,
         us_import_gas_price = `Price of U.S. Natural Gas Imports (Dollars per Thousand Cubic Feet)`,
         us_pipeline_import_price = `U.S. Natural Gas Pipeline Imports Price (Dollars per Thousand Cubic Feet)`,
         us_lng_import_price = `Price of U.S. Natural Gas LNG Imports (Dollars per Thousand Cubic Feet)`,
         us_export_gas_price = `Price of U.S. Natural Gas Exports (Dollars per Thousand Cubic Feet)`,
         us_export_gas_pipeline_price = `Price of U.S. Natural Gas Pipeline Exports (Dollars per Thousand Cubic Feet)`,
         us_export_lng_price = `Price of Liquefied U.S. Natural Gas Exports (Dollars per Thousand Cubic Feet)`) %>% 
  select(us_wellhead_gas_price, us_import_gas_price, us_pipeline_import_price,
        us_lng_import_price, us_export_gas_price,
        us_export_gas_pipeline_price, us_export_lng_price ) %>% 
  mutate(anio = 1922:2019)
  

price_eeuu_Mm3 <-  price_eeuu %>% 
  mutate_all(function(x){conversor_ft3m3_p( 1000)}) %>% 
  mutate(anio = 1922:2019,
         unidad = "USD/Miles de m3") 

price_eeuu_MMBTU <-  price_eeuu %>% 
  mutate_all(function(x){conversor_ft3MMBTU_p(x /1000)}) %>% 
  mutate(anio = 1922:2019,
         unidad = "USD/MMBTU")  %>% 
  select(anio, unidad, everything(.))
  

#eurostat


#BP
bp_gas_prices <- read_excel("C:/Archivos/Datos/BP/bp-stats-review-2020-all-data.xlsx", 
    sheet = "Gas - Prices ", skip = 3) %>% 
  rename(anio = ...1, 
         bp_lng_japan_cif = Japan,
         bp_lng_jkm = "Japan Korea Marker",
         bp_gas_german_import_price = "Average German",
         bp_gas_nbp = UK,
         bp_gas_netherlands_ttf = "Netherlands TTF",
         bp_gas_henry_hub = US,
         bp_gas_canada = Canada, 
         bp_oil_mix_mean_oecd = OECD) %>% 
  mutate_all(as.double) %>% 
  filter(!is.na(anio)) %>% 
  mutate(unidad = "USD/MMBTU")

bp_gas_2016 <- bp_gas_prices %>% 
              select(anio, bp_lng_jkm, bp_gas_henry_hub, bp_gas_netherlands_ttf ) %>% 
              filter(anio == 2016)


#FMI
fmi_prices <- read_csv("C:/Archivos/Datos/FMI/PCPS_09-16-2020 15-07-10-66_timeSeries.csv", 
    col_types = cols(X38 = col_skip()))

fmi_gas_price <- fmi_prices %>% 
  filter(`Commodity Name` %in% c("Natural gas, EU","Natural Gas, US Henry Hub Gas","LNG, Asia"  ),
         `Unit Name` == "Index") %>% 
  rename(commodity = "Commodity Name",
         unidad = "Unit Name") %>% 
  gather(.,
         key = anio,
         value = valor, 
           8:ncol(.)) %>% 
  select(commodity, anio, valor, unidad ) %>% 
  mutate(valor = valor / 100,
         anio = as.double(anio)) %>% 
  spread(.,
         key = commodity, 
         value = valor) %>% 
  rename(fmi_lng_asia = "LNG, Asia",
         fmi_natural_gas_eu ="Natural gas, EU",
         fmi_henry_hub = "Natural Gas, US Henry Hub Gas") %>% 
  mutate(fmi_lng_asia = fmi_lng_asia * bp_gas_2016$bp_lng_jkm,
         fmi_henry_hub =  fmi_henry_hub * bp_gas_2016$bp_gas_henry_hub,
         fmi_natural_gas_eu = fmi_natural_gas_eu * bp_gas_2016$bp_gas_netherlands_ttf,
         unidad = "USD/MMBTU")


# unique(fmi_prices$`Commodity Name`)
# unique(fmi_prices$`Unit Name`)
# unique(fmi_prices$`Country Name`)
```


##### Bolivia
 
```{r echo=FALSE, message=FALSE, warning=FALSE}

#### Precio de importación de Bolivia
#Precio impo bolivia revista IDEE
precio_idee_impo_gas <- cuadro_4.3  %>% 
  select(anio, unidad_gas, precio_gas_bolivia) %>% 
  left_join(ipc_promedio %>% select(anio, ipc_70)) %>%
  mutate(precio_gas_bolivia_idee = precio_gas_bolivia * ipc_70 / conversor_pesos$`$Ley`,
         unidad = "ars/Miles de m3") %>% 
  left_join(tcp_anual_b %>% select(anio, tcc)) %>% 
  mutate(precio_gas_bolivia_usd_idee = precio_gas_bolivia_idee /tcc)


#precio Bolivia YPFB en USD (original)
# a m3
precio_expo_bolivia_usd_ypfb <- read_excel("C:/Archivos/Datos/Hidrocarburos/Precios/precio_expo_bolivia.xlsx") %>%
  mutate_at(.vars = c("precio_expo_bolivia_arg_gas", "precio_expo_bolivia_bzl_gas"),
            .funs = function(x) {conversor_ft3m3_p(x)}) %>% 
  mutate(unidad = "USD/Miles de m3")


# a MM BTU
precio_expo_bolivia_usd_MMBTU_ypfb <- read_excel("C:/Archivos/Datos/Hidrocarburos/Precios/precio_expo_bolivia.xlsx") %>%
  mutate_at(.vars = c("precio_expo_bolivia_arg_gas", "precio_expo_bolivia_bzl_gas"),
            .funs = function(x) {conversor_ft3MMBTU_p(x/1000)}) %>% 
  mutate(unidad = "USD/MMBTU") %>% 
  rename(precio_expo_bolivia_arg_ypfb = precio_expo_bolivia_arg_gas,
         precio_expo_bolivia_bzl_ypfb = precio_expo_bolivia_bzl_gas)  


#precio bolivia en pesos 
#sumarle el flete = 0.024129794
precio_expo_bolivia_pesos_ypfb <-  precio_expo_bolivia_usd_ypfb %>% 
    left_join(tcp_anual) %>%
  mutate(precio_expo_bolivia_arg_gas_pesos = precio_expo_bolivia_arg_gas * TCC , 
         precio_expo_bolivia_bzl_gas_pesos = precio_expo_bolivia_bzl_gas * TCC,
         unidad = "ars/Miles de m3")


#precio impo de argentina desde bolivia UN Comtrade
gas_impo_bolivia_comtrade_usd <- read_csv("C:/Archivos/Datos/UN Comtrade/resultados/gas_impo_bolivia_comtrade.csv") %>%
  select(Period, "Trade Flow", Reporter, Partner, "Commodity Code", Commodity,
         Qty, trade_value_usd, precio_impo_gas_bolivia, unidad_precio, unidad_cantidad) %>% 
  rename(anio = Period) %>% 
  mutate(precio_impo_gas_bolivia_MMBTU_comtrade = conversor_m3MMBTU_p(precio_impo_gas_bolivia),
         unidad = "USD/MMBTU")

#pasaje a pesos
gas_impo_bolivia_comtrade <- gas_impo_bolivia_comtrade_usd  %>% 
  left_join(tcp_anual_b, by = "anio") %>% 
  mutate(precio_impo_gas_bolivia = precio_impo_gas_bolivia * tcc,
         unidad_precio = "ars/Miles de m3")


#precio expo bolivia UN COMTRADE
gas_expo_bolivia_comtrade_usd <- read_csv("C:/Archivos/Datos/UN Comtrade/resultados/gas_expo_bolivia_comtrade.csv") %>%
  select(Period, "Trade Flow", Reporter, Partner, "Commodity Code", Commodity,
         Qty, trade_value_usd, precio_expo_gas_bolivia, unidad_precio, unidad_cantidad) %>% 
  rename(anio = Period) %>% 
   mutate(precio_expo_gas_bolivia_arg_MMBTU_comtrade = conversor_m3MMBTU_p(precio_expo_gas_bolivia),
         unidad = "USD/MMBTU")

#pasaje a pesos
gas_expo_bolivia_comtrade <-  gas_expo_bolivia_comtrade_usd %>%
  left_join(tcp_anual_b, by = "anio") %>% 
  mutate(precio_expo_gas_bolivia = precio_expo_gas_bolivia * tcc,
         unidad_precio = "ars/Miles de m3")
```

##### Todos los precios
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Precio de exportacion y referencia de Gas. Merge de bases

#precios en usd
precio_mdomundial_gas_MMBTU <- price_eeuu_MMBTU %>% 
  left_join(  henry_hub) %>%
  left_join(bp_gas_prices) %>% 
  left_join(fmi_gas_price) %>% 
  left_join(precio_expo_bolivia_usd_MMBTU_ypfb) %>% 
  left_join(gas_impo_bolivia_comtrade_usd %>% 
              select(anio, unidad, precio_impo_gas_arg_bolivia_comtrade = precio_impo_gas_bolivia_MMBTU_comtrade)) %>% 
  left_join(gas_expo_bolivia_comtrade_usd %>% 
              select(anio, unidad, 
                     precio_expo_gas_bolivia_arg_comtrade = precio_expo_gas_bolivia_arg_MMBTU_comtrade)) %>% 
  left_join(precio_idee_impo_gas %>% select(anio, precio_gas_bolivia_usd_idee)) %>% 
  left_join(precio_expo_gas_usd) %>% 
  mutate(precio_impo_gas_bolivia_idee = conversor_m3MMBTU_p(precio_gas_bolivia_usd_idee/1000),#ok
         precio_externo_gas = case_when( anio < 1966 ~ precio_impo_gas_arg_bolivia_comtrade,
                                         T~ precio_expo_gas_bolivia_arg_comtrade),
         precio_exportacion_gas_ar = case_when(anio <1999 ~precio_expo_gas_comtrade,
                                            anio >= 1999 ~ precio_expo_gas_regalias)) %>% 
  select(anio, unidad, precio_externo_gas, everything(.), -precio_gas_bolivia_usd_idee) %>% 
  filter(anio < 2021)

precio_mdomundial_gas_bep <- precio_mdomundial_gas_MMBTU %>%
  select(-unidad) %>% 
  group_by(anio) %>% 
  mutate_all(conversor_MMBTUbep_p) %>% 
  mutate(unidad = "USD/bep") %>% 
  select(anio, unidad, everything(.))

comparacion_bep <- precio_mdomundial_gas_bep %>% 
    # select(anio, precio_externo_gas) %>%
  left_join(precios_referencia_y_expo_crudo %>% 
              select(anio, brent_historic, wti_spot_price_fred,
                     precio_expo_comtrade_sitc_crudo)) %>% 
  mutate(unidad = "USD/bep")
  
# precio_mdomundial_gas_Mm3 <- precio_mdomundial_gas_MMBTU %>%
#   select(-unidad) %>% 
#   group_by(anio) %>% 
#   mutate_all(conversor_m3MMBTU_p) %>% 
#   mutate(unidad = "USD/bep") %>% 
#   select(anio, unidad, everything(.))
  

# writexl::write_xlsx(list(MMBTU = precio_mdomundial_gas_MMBTU, 
#                          BEP = precio_mdomundial_gas_bep), path = "resultados/precio_mdo_mundial_gas.xlsx")

#grafico precios bep
graf_precio_mdo_mundial_gas_bep <- precio_mdomundial_gas_bep %>% 
  select(-precio_externo_gas) %>% 
  gather(key = tipo_precio,
         value = valor,
         3:ncol(.)) %>%
  # filter(!(tipo_precio %in% c("precio_gas_bolivia_usd_idee", "precio_impo_gas_bolivia_MMBTU_comtrade",
  #                             "precio_expo_gas_comtrade", "precio_expo_gas_indec"))) %>%
  filter(!(tipo_precio %in% c("precio_expo_gas_indec"))) %>% 
  ggplot(aes(x = anio, y = valor, color = tipo_precio))+
  geom_line() +
  theme(legend.position = "bottom")+
  labs(y = "USD/bep")
# plotly::ggplotly(graf_precio_mdo_mundial_gas_bep)

graf_precio_mdo_mundial_gas_mmbtu <- precio_mdomundial_gas_MMBTU %>% 
  filter(precio_externo_gas < 25) %>% 
  gather(key = tipo_precio,
         value = valor,
         3:ncol(.)) %>%
  filter(
    valor < 25,
    !(tipo_precio %in% c("bp_oil_mix_mean_oecd"
                              # , "precio_expo_gas_indec"
                              # "precio_gas_bolivia_usd_idee",
                              # "precio_impo_gas_arg_bolivia_comtrade",
                              # "precio_expo_gas_comtrade"
                              ))) %>%
  # filter(!(tipo_precio %in% c("precio_expo_gas_indec"))) %>% 
  ggplot(aes(x = anio, y = valor, color = tipo_precio))+
  geom_line() +
  # theme(legend.position = "bottom")+
  theme(legend.position = "right")+
  labs(title = "Precios de exportación y referencia del mercado mundial del gas", 
       y = "USD/MMBTU")
ggplotly(graf_precio_mdo_mundial_gas_mmbtu, width = 600, height = 400)


#precios en ars. INCOMPLETO
precio_expo_y_me_gas <- precio_expo_gas %>%
  full_join(precio_idee_impo_gas %>% 
              select(anio, unidad, precio_gas_bolivia_idee)) %>% 
  full_join(precio_expo_bolivia_pesos_ypfb %>% 
              select(anio, unidad, 
                     precio_bolivia_ypfb = precio_expo_bolivia_arg_gas_pesos )) %>% 
  full_join(gas_impo_bolivia_comtrade %>% 
              select(anio, unidad = unidad_precio,
                     precio_impo_gas_bolivia_comtrade = precio_impo_gas_bolivia )) %>% 
  left_join(gas_expo_bolivia_comtrade %>% 
              select(anio, unidad = unidad_precio, 
                     precio_expo_gas_bolivia_comtrade = precio_expo_gas_bolivia )) %>%
  left_join(henry_hub) %>% 
  arrange(anio)

# writexl::write_xlsx(precio_expo_y_me_gas, path = "precio_expo_y_mdo_mundial_gas.xlsx")
# writexl::write_xlsx(comparacion_bep, path = "comparacion_bep.xlsx")


comparacion_precios <- precio_mdomundial_gas_MMBTU %>% 
  select(anio, unidad, precio_externo_gas) %>% 
  left_join(precio_interno_gas_mmbtu_usd %>% 
              select(anio, unidad, precio_gas_mdoint))
 
```
buscamos un precio

cuanto es una cantidad de btu de gas al precio de referencia (ej bolivia) y cuanto es si convierto esos btu a barriles y los valorizo con el precio del barril? cuanto queda la unidad en btu si tomo el precio de petroleo y lo covierto a btu. 
es decir, cuanto es el valor si la valorizo en precio del petroleo

¿cuantos usd es un btu de petroleo?
si tomo un barril de petroleo y lo convierto a btu ( me va a dar cuantos USD es un btu)
luego comparo los USD/btu y lo comparo con el gas de bolivia

grinber: convierte todo el gas en petroleo y le pone el precio de petroeloe. subestima los precios del gas?

```{r}
precio_crudo_vs_gas <- precio_mdomundial_gas_bep %>% 
  select(anio, unidad, precio_externo_gas) %>% 
  left_join(precios_referencia_y_expo_crudo %>% 
              select(-unidad) %>% 
              gather(key = tipo_precio_crudo,
                     value   = precio_crudo_usd_bbl,
                     2:ncol(.)), by ="anio") %>% 
  mutate(precio_crudo_sobre_gas =precio_crudo_usd_bbl/precio_externo_gas) %>% 
  filter(!(is.na(precio_crudo_sobre_gas)), 
         !(tipo_precio_crudo %in% c("wti_spot_price_fred", "precio_me_crudo"))  )
         # (tipo_precio_crudo %in% c("brent_iea"))  )
         # (tipo_precio_crudo %in% c("brent_iea", "brent_historic"))  )
precio_crudo_vs_gas

graf <-  precio_crudo_vs_gas %>% 
  ggplot(aes(anio, precio_crudo_sobre_gas, color=tipo_precio_crudo))+
  geom_line()+
  labs(title = "precio del crudo sobre el del gas (ambos en barriles)")

ggplotly(graf, width = 800, length=600)
# graf

# writexl::write_xlsx(precio_crudo_vs_gas, path= "precio del crudo vs gas.xlsx")  
```



## Exportaciones e Importaciones

* Fuentes
  + [SESCO Downstream](https://datos.gob.ar/dataset/energia-refinacion-comercializacion-petroleo-gas-derivados-tablas-dinamicas)
  + INDEC
  + MECON
  + UNComtrade

#### Exportaciones e Importaciones de Crudo
* Exportaciones de Crudo: 
  + 1962 a 1993: UN Comtrade
  + 1994 en adelante: SESCO Downstream
  + Los datos faltantes de SESCO se completaron con MECON
  + Siguen habiendo datos faltantes para los años 1965, 1970-74, 1976-78, 1980-84

```{r echo=FALSE, message=FALSE, warning=FALSE}
### SESCO
#cantidades. post 2010 (hasta 2019)
importaciones_exportaciones <- read_csv("C:/Archivos/Datos/Hidrocarburos/SESCO/Refinación y comercializacion/importaciones-exportaciones.csv")

# cantidades. post 2016 
importaciones_exportaciones_post2016 <- read_csv("C:/Archivos/Datos/Hidrocarburos/SESCO/Refinación y comercializacion/importaciones-exportaciones-a-partir-del-2016-.csv")

####comercio exterior post 2010: "TD_comercio_exterior.xlsx"
comex_post2010 <- read_delim("/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/comex_post2010.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE, 
    skip = 5) %>% 
  mutate(unidad = case_when(Datos == "Suma de monto" ~ "USD",
                            T ~ unidad),
         	unidad = str_remove_all(	unidad, "[()]" ),
         fecha = as.Date(parse_date_time(paste0(anio, mes), orders = "ym"))) %>%  
  filter(!is.na(anio)) %>% 
  rename(exportacion = "Exportación",
         importacion = "Importación") %>% 
  select(fecha, anio, mes, everything(.), -c("Total general", Datos)) %>% 
  gather(.,
         key = variable,
         value = valor,
         6:7)

#otra base. solo cantidades. ver de donde apareció
impo_expo <- read_csv("/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/importaciones-exportaciones (1).csv")


###exportaciones pre 2010: "Exportaciones.xlsx"
expo_pre2010 <- read_delim("/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/expo_pre2010.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  rename(anio = "Año",
         mes = "Mes",
         producto = Producto,
         valor = Total) %>% 
  mutate(anio = zoo::na.locf(anio),
         mes = zoo::na.locf(mes),
         producto = zoo::na.locf(producto),
         variable = "exportacion",
         fecha = as.Date(parse_date_time(paste0(anio, mes), orders = "ym")),
         unidad = case_when(str_detect(Datos, "M3") ~ "m3",
                            str_detect(Datos, "Ton") ~ "ton",
                            str_detect(Datos, "FOB") ~ "USD")) %>% 
  select(fecha, everything(.), -c(Datos))

#no se de donde salió este pero habria q rastrearlo
expo_usd_ton <- read_delim("C:/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/expo_usd_ton.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE, 
    skip = 3)

###importaciones pre 2010: "Importaciones.xlsx"
impo_pre2010 <- read_delim("/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/impo_pre2010.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  rename(anio = "Año",
         mes = "Mes",
         producto = Producto,
         valor = Total) %>% 
  mutate(anio = zoo::na.locf(anio),
         mes = zoo::na.locf(mes),
         producto = zoo::na.locf(producto),
         variable = "importacion",
         fecha = as.Date(parse_date_time(paste0(anio, mes), orders = "ym")),
         unidad = case_when(str_detect(Datos, "M3") ~ "m3",
                            str_detect(Datos, "Ton") ~ "ton",
                            str_detect(Datos, "FOB") ~ "USD")) %>% 
  select(fecha, everything(.), -c(Datos))
# impo_pre2010


#Base unida de SESCO
comercio_exterior <- comex_post2010 %>% 
  bind_rows(impo_pre2010, expo_pre2010) %>% 
  arrange(fecha) %>% 
  mutate(valor = case_when(unidad == "miles/m3" ~ valor * 1000,
                           T ~ valor),
         unidad = case_when(unidad == "miles/m3" ~ "m3",
                            T ~ unidad))

#expo e impo de Crudo. cantidades y valor
comex_crudo_sesco <- comercio_exterior %>% 
  filter(str_detect(producto, "PETROLEO") | str_detect(producto, "Cuenca"),
         unidad != "Ton") %>% 
  group_by(anio, variable, unidad) %>% 
  summarise(valor = sum(valor, na.rm = T)) %>% 
  mutate(producto = "crudo",
         valor = case_when(unidad == "m3" ~ conversor_m3bbl_q(valor),
                           T ~ valor),
         unidad = case_when(unidad == "m3" ~ "barriles",
                            T ~ unidad))


#qué productos entran en el filtro de crudo?
# unique((comercio_exterior %>% filter(str_detect(producto, "PETROLEO") | str_detect(producto, "Cuenca")))$producto)


#MECON
comex_hidrocarburos_mecon <- read_excel("C:/Archivos/Datos/Hidrocarburos/Mecon/base-mineria-e-hidrocarburos cuentas nacionales.xls", 
    sheet = "Com. exterior", skip = 7) %>%
  rename(anio = '...1' ,
         expo_Mm3_crudo = 'Exportaciones...2',
         impo_Mm3_crudo = 'Importaciones...3',
         saldo_Mm3_crudo = `Balance (X-M)...4`,
         expo_MMm3_gas = 'Exportaciones...5',
         impo_Mm3_gas = 'Importaciones...6',
         saldo_Mm3_gas = `Balance (X-M)...7`,
         expo_metaliferos_otros_MMusd = `Minerales metalíferos, escorias y cenizas`,
         expo_crudo_MMusd = `Petróleo crudo`,
         expo_gas_MMusd = `Gas de petróleo y otros hidrocarburos`,
         expo_carburantes_otros_MMusd = `Carburantes, grasas y aceites lubricantes`,
         expo_electrica_MMusd = `Energía eléctrica`,
         expo_resto_combustibles_MMusd = `Resto de combustibles`) %>% 
  filter(!is.na(anio )) %>% 
  mutate_all(as.double) %>% 
  mutate(expo_bbl_crudo = conversor_m3bbl_q(expo_Mm3_crudo*1000),
         impo_bbl_crudo = conversor_m3bbl_q(impo_Mm3_crudo*1000),
         saldo_bbl_crudo = conversor_m3bbl_q(saldo_Mm3_crudo*1000))


#INDEC - ComEx
#cantidades
cantidades_expo_hidro_indec <- read_csv("C:/Archivos/Datos/INDEC/ComEx/cantidades_expo_hidro_indec.csv", 
    col_types = cols(X1 = col_skip())) %>% 
  rename(expo_indec_crudo = petroleo_crudo_expo,
           expo_indec_gas  = gas_natural_expo)

#valor
expo_hidro_valor_indec <- read_csv("C:/Archivos/Datos/INDEC/ComEx/expo_hidro_valor.csv", 
    col_types = cols(X1 = col_skip())) %>% 
  rename(expo_indec_crudo = petroleo_crudo_expo,
           expo_indec_gas  = gas_natural_expo)



#Merge de bases
#Crudo expo cantidad
expo_q_crudo <- comex_crudo_sesco %>%
  filter(variable == "exportacion",
         unidad == "barriles") %>%
  select(anio, unidad, valor) %>% 
  ungroup() %>% 
  rename(expo_sesco_crudo = valor) %>% 
  left_join(comex_hidrocarburos_mecon %>% 
              select(anio, expo_mecon_crudo = expo_bbl_crudo)) %>% 
  left_join(cantidades_expo_hidro_indec %>% 
              select(-expo_indec_gas)) %>% 
  full_join(expo_crudo_sitc %>% 
              select(anio, unidad = unidad_cantidad, expo_comtrade_crudo = expo_bbl )) %>% 
  mutate(expo_crudo = case_when(anio < 1999  ~ expo_comtrade_crudo,
                                # anio %in% 1999:2014 ~ expo_mecon_crudo ,
                                anio >= 1999 ~ expo_sesco_crudo,
                                  is.na(expo_sesco_crudo) ~ expo_mecon_crudo,
                                T ~ expo_sesco_crudo),
         unidad = "barriles") %>% #,
         # dif = expo_crudo/expo_indec_crudo - 1) %>% 
  select(anio, unidad,expo_crudo, everything(.), -variable) %>% 
  arrange(anio)


# Merge crudo USD
expo_usd_crudo <- comex_crudo_sesco %>% 
  filter(variable == "exportacion" , unidad == "USD") %>% 
  rename(expo_crudo_sesco = valor) %>%
  left_join(comex_hidrocarburos_mecon %>% 
              select(anio, expo_crudo_mecon = expo_crudo_MMusd)) %>% 
  left_join(expo_hidro_valor_indec %>% 
              select(anio, expo_indec_crudo)) %>% 
  full_join(expo_crudo_sitc %>% 
            select(anio, unidad = unidad_valor, expo_comtrade_crudo = expo_usd_comtrade_crudo)) %>%
  mutate(expo_crudo_mecon = expo_crudo_mecon *1000000,
         expo_crudo = case_when(anio <1994 ~ expo_comtrade_crudo,
                                anio >= 1994 ~ expo_crudo_sesco)) %>% 
  ungroup() %>% 
  select(anio, unidad, expo_crudo, everything(.), -c(variable, producto)) %>% 
  arrange(anio) %>% 
  group_by(anio, unidad) %>% 
  mutate_all(function(x) {x/10^6})

# writexl::write_xlsx(list(usd = expo_usd_crudo, 
                         # cantidades = expo_q_crudo,
                         # precio_exportacion_y_referencia = precios_referencia_y_expo_crudo), 
                    # path = "C:/Archivos/Datos/Hidrocarburos/Estimacion propia/resultados/expo_crudo.xlsx")

expo_q_crudo
expo_usd_crudo
```


#### Exportaciones e Importaciones de Gas
* Fuentes seleccionadas:
 + 1962 a 1996: UN Comtrade,
 + 1997 en adelante: SESCO Downstream
 + Datos faltantes para los años 1999 y 2000

```{r echo=FALSE, message=FALSE, warning=FALSE}
#SESCO
comex_gas <- comercio_exterior %>% 
  filter(str_detect(producto, "GAS NATURAL") | str_detect(producto, "Gas Natural") 
         | str_detect(producto, "Gas de Refinería"),
         producto != "Gas Natural Licuado",
         unidad != "Ton") %>%
  group_by(anio, variable, unidad) %>% 
  summarise(valor = sum(valor, na.rm = T))%>% 
  mutate(producto = "gas")

# writexl::write_xlsx(list(comex_crudo_sesco %>% filter(unidad == "USD", variable == "exportacion"),
#                          comex_crudo_sesco %>% filter(unidad == "USD", variable == "importacion"),
#                          comex_gas %>% filter(unidad == "USD", variable == "importacion"),
#                          comex_gas %>% filter(unidad == "USD", variable == "exportacion")), 
#                     path = "comex_sesco.xlsx")

#Expo gas SESCO cantidades
expo_sesco_q_gas <- comex_gas  %>%
  filter(variable == "exportacion",
         unidad == "m3") %>% 
  ungroup() %>% 
  select(-c(variable, producto)) %>%
  rename(expo_sesco_gas = valor) %>%
  mutate(expo_sesco_gas = replace_na(expo_sesco_gas, 0 ),
         expo_sesco_gas = expo_sesco_gas / 1000,
         unidad = "Miles de m3")

#expo sesco gas valor
expo_sesco_usd_gas <- comex_gas  %>%
  filter(variable == "exportacion",
         unidad == "USD") %>% 
  ungroup() %>% 
  select(-c(variable, producto)) %>%
  rename(expo_sesco_gas = valor) %>%
  mutate(expo_sesco_gas = replace_na(expo_sesco_gas, 0 ))


#expo UN Comtrade
expo_gas_sitc <- read_csv("C:/Archivos/Datos/UN Comtrade/resultados/expo_gas_sitc.csv")  %>% 
  rename(trade_value_usd = "Trade Value (US$)") %>% 
  mutate(unidad = "USD",
         expo_Mm3 = expo_Mm3 /1000,
         unidad_cantidad =  "Miles de m3")


#Merge cantidades
expo_q_gas <-  expo_sesco_q_gas %>% 
  left_join(comex_hidrocarburos_mecon %>% 
              select(anio, expo_gas_mecon = expo_MMm3_gas) %>%
              mutate(unidad = "Miles de m3",
                     expo_gas_mecon = expo_gas_mecon * 1000) ) %>% 
  left_join(cantidades_expo_hidro_indec %>% 
              select(-expo_indec_crudo)) %>% 
  full_join(expo_gas_sitc %>%
              select(anio, expo_gas_comtrade = expo_Mm3, unidad = unidad_cantidad )) %>% 
  # mutate(dif = expo_sesco_gas/ expo_indec_gas - 1 ) %>%
  mutate(expo_gas = case_when(anio < 1997 ~ expo_gas_comtrade,
                             anio > 1996 ~expo_sesco_gas )) %>% 
  arrange(anio) %>% 
  select(anio, unidad, expo_gas, everything(.))

expo_q_gas_MMBTU <- expo_q_gas %>% 
  group_by(anio) %>% 
  select(-c(unidad)) %>% 
  mutate_all(function(x) {conversor_m3MMBTU_q(x*1000)} ) %>% 
  mutate(unidad = "MMBTU")

#Merge valor
expo_usd_gas <- expo_sesco_usd_gas %>%
  left_join(comex_hidrocarburos_mecon %>% 
              select(anio, expo_gas_mecon = expo_gas_MMusd) %>% 
              mutate(expo_gas_mecon = expo_gas_mecon * 1000000))  %>% 
  left_join(expo_hidro_valor_indec %>% 
              select(anio, expo_gas_indec = expo_indec_gas)) %>% 
  full_join(expo_gas_sitc %>%
              select(anio, expo_gas_comtrade = trade_value_usd, unidad )) %>% 
  # mutate(dif = expo_sesco_gas/expo_gas_indec -1) %>% 
  mutate(expo_gas = case_when(anio < 1997 ~ expo_gas_comtrade,
                                anio >= 1997 ~ expo_sesco_gas)) %>% 
  select(anio, unidad, expo_gas, everything(.)) %>% 
  arrange(anio)
  

# writexl::write_xlsx(list( cantidades = expo_q_gas, 
#                           USD = expo_usd_gas, 
#                           precio_expo_y_referencia = precio_expo_y_me_gas),
#                     path = "resultados/expo_gas.xlsx")

# comex_crudo_sesco %>% filter(unidad == "m3", variable == "exportacion")
# comex_gas %>% filter(unidad == "m3", variable == "exportacion")
expo_q_gas 
expo_usd_gas
```

## Empleo, Remuneraciones y Masa Salarial (CCNN)

* Salario y empleo
  + MTEySS (Base Minería e Hidrocarburos de las Cuentas Nacionales) (1996-2013)
  + [Ministerio de Trabajo, Empleo y Seguridad Social - Observatorio de Empleo y Dinámica Empresarial (OEDE)](http://www.trabajo.gob.ar/estadisticas/oede/estadisticasnacionales.asp) (1996-2019)
  + EPH ??
<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}
#anuarios CEPAL
cepal_1991 <- read_excel("C:/Archivos/Datos/Hidrocarburos/CEPAL/cepal_1991.xlsx") %>% 
  mutate(valor = valor / conversor_pesos$A /10^3,
         unidad = "Millones de pesos corrientes")

masa_salarial_cepal <- cepal_1991 %>% 
  filter(variable == "remuneracion_al_trabajo") %>% 
  rename(ms_cepal = valor)
  

#con datos de la base de CCNN
empleo <- read_excel("C:/Archivos/Datos/Hidrocarburos/Mecon/base-mineria-e-hidrocarburos cuentas nacionales.xls", 
    sheet = "Empleo registrado", skip = 5) %>% 
  rename(anio = "Año",
          periodo ="Período",
         empleo_extraccion_hidrocarburos = "...7",
        empleo_servicios_hidrocarburos = "...8" ) %>%
   filter(is.na(periodo), !is.na(anio) ) %>%
  select(anio, empleo_extraccion_hidrocarburos,empleo_servicios_hidrocarburos ) %>% 
  mutate(unidad_empleo = "Puestos de trabajo",
         empleo_extraccion_hidrocarburos = as.double(empleo_extraccion_hidrocarburos),
         empleo_servicios_hidrocarburos = as.double(empleo_servicios_hidrocarburos)) 
  

salarios <- read_excel("C:/Archivos/Datos/Hidrocarburos/Mecon/base-mineria-e-hidrocarburos cuentas nacionales.xls", 
    sheet = "Remuneraciones", col_types = c("numeric", 
        "date", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text"), skip = 5) %>% 
    rename(anio = "Año",
          periodo ="Período",
          salario_extraccion_hidrocarburos = "...7",
         salario_servicios_hidrocarburos =  "...8") %>% 
  filter(!is.na(anio) & anio < 2014) %>% 
  select(anio, salario_extraccion_hidrocarburos,salario_servicios_hidrocarburos ) %>% 
  mutate(unidad_salario = "Pesos corrientes",
         salario_extraccion_hidrocarburos= as.double(salario_extraccion_hidrocarburos),
        salario_servicios_hidrocarburos = as.double(salario_servicios_hidrocarburos))
   
masa_salarial_ccnn <- empleo %>% 
  left_join(salarios, by = "anio") %>% 
  mutate(unidad_masa_salarial = "Millones de pesos corrientes",
         masa_salarial_extraccion = (salario_extraccion_hidrocarburos *empleo_extraccion_hidrocarburos*13)/10^6,
         masa_salarial_servicios = (salario_servicios_hidrocarburos *empleo_servicios_hidrocarburos*13)/10^6,
         masa_salarial_total = masa_salarial_extraccion + masa_salarial_servicios) 



#con datos de empleo registrado 
remuneraciones_anual <- read_excel("C:/Archivos/Datos/Hidrocarburos/Ministerio Trabajo/nacional_serie_remuneraciones_anual.xlsx", 
    sheet = "C 5", col_types = c("skip", 
        "text", "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric"), skip = 4) %>% 
  gather(key = anio,
         value = valor,
         2:ncol(.)) %>%
  rename(rama_actividad = "Rama de actividad") %>% 
  filter( str_detect(rama_actividad, "petróleo")) %>% 
  mutate(unidad_salario = "Pesos corrientes",
         rama_actividad= 
           case_when(rama_actividad==
                                     "Actividades  de servicios relacionadas con la extracción de petróleo y gas, excepto las actividades de prospección" ~ 
                                     "remuneracion_servicios_extraccion",
                                   rama_actividad==
                                     "Extracción de petróleo crudo y gas natural" ~ 
                                     "remuneracion_extraccion_petroleo_gas")) %>% 
    filter(!(is.na(rama_actividad))) %>% 
  spread(key = rama_actividad,
         value = valor)
  


empleo_anual <- read_excel("C:/Archivos/Datos/Hidrocarburos/Ministerio Trabajo/nacional_serie_empleo_anual.xlsx", 
    sheet = "C 5", col_types = c("skip", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text"), 
    skip = 4)%>% 
  gather(key = anio,
         value = valor,
         2:ncol(.)) %>%
  rename(rama_actividad = "Rama de actividad") %>% 
  filter( str_detect(rama_actividad, "petróleo")) %>% 
  mutate(valor = as.double(valor),
         unidad_empleo = "Puestos de trabajo",
         rama_actividad= case_when(rama_actividad==
                                     "Actividades  de servicios relacionadas con la extracción de petróleo y gas, excepto las actividades de prospección" ~ 
                                     "empleo_servicios_extraccion",
                                   rama_actividad==
                                     "Extracción de petróleo crudo y gas natural" ~ "empleo_extraccion_petroleo_gas")) %>% 
  filter(!(is.na(rama_actividad))) %>% 
  spread(key = rama_actividad,
         value = valor)

masa_salarial_oede <- empleo_anual %>% 
  left_join(remuneraciones_anual, by = "anio") %>% 
  mutate(unidad_masa_salarial = "Millones de pesos corrientes",
         masa_salarial_extraccion = (  remuneracion_extraccion_petroleo_gas *empleo_extraccion_petroleo_gas*13)/10^6,
         masa_salarial_servicios = (remuneracion_servicios_extraccion *empleo_servicios_extraccion*13)/10^6,
         masa_salarial_total = masa_salarial_servicios + masa_salarial_extraccion,
         anio =as.double(anio))

masa_salarial_hidrocarburos <- masa_salarial_ccnn %>% 
  select(anio, unidad = unidad_masa_salarial, masa_salarial_extraccion_ccnn= masa_salarial_extraccion, 
         masa_salarial_total_ccnn = masa_salarial_total) %>% 
  full_join(masa_salarial_oede %>% 
              select(anio, unidad = unidad_masa_salarial, 
                     masa_salarial_extraccion_oede= masa_salarial_extraccion,
                     masa_salarial_total_oede =masa_salarial_total)) %>% 
  full_join(masa_salarial_cepal %>% 
              select(anio, unidad, ms_cepal)) %>% 
  # mutate(ms = case_when(anio < 1996 ~ ms_cepal,
  #                       anio >= 1996 ~masa_salarial_oede)) %>% 
  arrange(anio)
masa_salarial_hidrocarburos  


```



## Pozos


### Metros perforados

Fuente:

* [Secretaría de Energía](https://datos.gob.ar/dataset/energia-perforacion-pozos-petroleo-gas)


```{r echo=FALSE, message=FALSE, warning=FALSE}
metros_perforados_posterior_al_2009 <- read_csv("C:/Archivos/Datos/Hidrocarburos/Pozos/secretaria de energia/metros-perforados.csv", 
    col_types = cols(indice_tiempo = col_date(format = "%Y-%m")))

metros_perforados_anterior_al_2009 <- read_csv("C:/Archivos/Datos/Hidrocarburos/Pozos/secretaria de energia/metros-perforados-anterior-al-2009.csv") %>% 
  rename(cantidad = Cantidad)

metros_perforados_empresa <- metros_perforados_posterior_al_2009 %>%
  bind_rows(metros_perforados_anterior_al_2009) %>% 
  select(anio, mes, idempresa, empresa, idconcepto, concepto, cantidad, observaciones ) %>% 
  group_by(anio, idempresa, empresa) %>%
  summarise(metros_perforados = sum(cantidad, na.rm = T)) %>% 
  ungroup()
  

metros_perforados <- metros_perforados_empresa %>%
  group_by(anio) %>% 
  summarise(metros_perforados = sum(metros_perforados, na.rm = T)) %>%
  mutate(indice_metros = generar_indice(serie= metros_perforados, 
                                        fecha = anio, 
                                        fecha_base = 2001)) 

graf_metros_perforados <- metros_perforados_empresa%>% 
  ggplot(aes(anio, metros_perforados, fill = empresa)) +
  geom_col()+
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90))+
  labs(title = "Metros perforados por empresa")+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))
ggplotly(graf_metros_perforados, width = 800, height = 600)


#listado de empresas con sus id's
listado_empresa <- distinct(metros_perforados_empresa %>% 
              select(idempresa, empresa),idempresa, .keep_all = T) 
  


```



### Pozos en operación

Fuentes:

* Secretaría de Energía - [Datos MINEM](https://github.com/datosminem/produccion-de-petroleo-y-gas-por-pozo):
  + [Listado de pozos cargados por empresas operadoras](http://datos.minem.gob.ar/dataset/produccion-de-petroleo-y-gas-por-pozo/archivo/cbfa4d79-ffb3-4096-bab5-eb0dde9a8385): se toma la variable "Fecha del Fin de terminación de perforación del pozo" (adjiv_fecha_fin_term) como año de puesta en producción del pozo. Se podría elaborar un stock de pozos a partir de acumular los pozos terminados y restando los pozos abandonados, agrupando con la variable "Fecha de abandono del pozo"(adjiv_fecha_abandono)
  + [Pozos terminados](http://datos.minem.gob.ar/dataset/perforacion-de-pozos-de-petroleo-y-gas/archivo/a2ce14af-5c56-45c2-9b9c-c7a1e5156dff)
  + [Capítulo IV](http://datos.minem.gob.ar/dataset/produccion-de-petroleo-y-gas-por-pozo/archivo/cb5c0f04-7835-45cd-b982-3e25ca7d7751)
  + [Estado de pozos](http://datos.minem.gob.ar/dataset/estado-de-pozos-de-petroleo-y-gas) (AUN NO SE PROCESÓ ESTA BASE NI LA ANTERIOR) 
  + [SESCO](http://www.energia.gob.ar/contenidos/verpagina.php?idpagina=1624)
* [IAPG](https://www.iapg.org.ar/web_iapg/sectores/estadisticas/productos/listados/listado_todos_los_productos.htm). Se presentan dos series: una elaborada a partir de los pozos perforados por año (resultante de descargar una base por cada año del sitio web oficial) y otra que corresponde al stock de pozos de petróleo de extracción efectiva (procedente de los datos de Estadísticas del Centenario de IAPG).



```{r message=FALSE, warning=FALSE, include=FALSE, mecho=FALSE, paged.print=FALSE}
# sec energia
# pozos cargados por empresas
listado_pozos <- read_csv("C:/Archivos/Datos/Hidrocarburos/Pozos/capitulo iv/listado-de-pozos-cargados-por-empresas-operadoras.csv") %>% 
  mutate(anio_terminacion_pozo =year(adjiv_fecha_fin_term)) %>%
  left_join(listado_empresa) %>% 
  group_by(anio_terminacion_pozo, idempresa, empresa) %>% 
  summarise(pozos = n()) %>% 
  filter(!is.na(anio_terminacion_pozo))


  # mutate(empresa = case_when(idempresa == "YPF" ~ "YPF",
  #                           idempresa == "PAE" ~ "PAE",
  #                           idempresa == "YSUR" ~ "YSUR",
  #                           idempresa == "PLU" ~ "Pluspetrol",
  #                           idempresa == "PLUE" ~ "Pluspetrol",
  #                           idempresa == "VIS" ~ "Vista Oil and Gas",
  #                           idempresa == "TPT" ~ "Tecpetrol", 
  #                           idempresa == "CGC" ~ "CGC",
  #                           idempresa == "WIN" ~ "Wintershall",
  #                           idempresa == "TAU" ~ "Total Austral",
  #                           idempresa == "YSUR" ~ "YSUR",
  #                           idempresa == "SHE" ~ "Shell",
  #                           idempresa == "CAP" ~ "Capex",
  #                           idempresa == "PPAM" ~ "Pampa",
  #                           T ~ "Otra")) 
                            # idempresa == "PETROBRAS ARGENTINA S.A." ~ "Petrobras",
                            # idempresa == "PESA (PETROBRAS E.S.A.)" ~ "Petrobras",
                            # idempresa == "ENAP SIPETROL ARGENTINA S.A." ~ "ENAP SIPETROL",
                            # idempresa == "VISTA OIL & GAS ARGENTINA SA" ~ "Vista Oil and Gas",
                            # idempresa == "SINOPEC ARGENTINA EXPLORATION AND PRODUCTION, INC." ~ "Sinopec",
                            # idempresa == "PLUSPETROL ENERGY S.A." ~ "Pluspetrol",
                            # idempresa == "YSUR PETROLERA ARGENTINA S.A." ~ "YSUR"))

graf_pozos_sec_energia <- listado_pozos %>% 
  ggplot(aes(anio_terminacion_pozo, pozos, fill = empresa))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")+
  labs(title = "Pozos cargados por empresas operadoras (por año de terminación)",
       caption = "Secretaría de Energía")
ggplotly(graf_pozos_sec_energia, width = 600, height = 400)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
  
pozos_terminados_anterior_al_2009 <- read_csv("C:/Archivos/Datos/Hidrocarburos/Pozos/secretaria de energia/pozos-terminados-anterior-al-2009.csv") %>% 
  rename(cantidad = Cantidad)

pozos_terminados <- read_csv("C:/Archivos/Datos/Hidrocarburos/Pozos/secretaria de energia/pozos-terminados.csv") %>% 
  bind_rows(pozos_terminados_anterior_al_2009) %>% 
  group_by(anio, idempresa, empresa ) %>% 
  summarise(pozos  = sum(cantidad, na.rm = T))


graf_pozos_terminados <- pozos_terminados %>%
  ggplot(aes(anio, pozos , fill = empresa))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")+
  labs(title = "Cantidad de pozos terminados",
       caption = "Secretaría de Energía")
ggplotly(graf_pozos_terminados, width = 600, height = 400)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
#pozos iapg (bases anuales)
pozo_iapg_05 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2005.xls", 
    skip = 1) %>% 
  mutate(anio = 2005) %>% 
  group_by(Operador) %>% 
  mutate_all(as.double)

pozo_iapg_06 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2006.xls", 
    skip = 1) %>% 
  mutate(anio = 2006) %>% 
  group_by(Operador) %>% 
  mutate_all(as.double)

pozo_iapg_07 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2007.xls", 
    skip = 1) %>% 
  mutate(anio = 2007) %>% 
  group_by(Operador) %>% 
  mutate_all(as.double)

pozo_iapg_08 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2008.xls", 
    skip = 2) %>% 
  mutate(anio = 2008) %>% 
  group_by(Operador) %>% 
  mutate_all(as.double)

pozo_iapg_09 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2009.xls", 
    skip = 2) %>% 
  mutate(anio = 2009) %>% 
  group_by(Operador) %>% 
  mutate_all(as.double)

pozo_iapg_10 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2010.xls", 
    skip = 2) %>% 
  mutate(anio = 2010) %>% 
  group_by(Operador) %>% 
  mutate_all(as.double)

pozo_iapg_12 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2012.xls", 
    skip = 2) %>% 
  mutate(anio = 2012) %>% 
  group_by(Operador) %>% 
  mutate_all(as.double)

pozo_iapg_13 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2013.xls", 
    skip = 2) %>% 
  mutate(anio = 2013) %>% 
  group_by(Operador) %>% 
  mutate_all(as.double)

pozo_iapg_14 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2014.xls", 
    skip = 2) %>% 
  mutate(anio = 2014) %>% 
  group_by(Operador) %>% 
  mutate_all(as.double)

pozo_iapg_15 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2015.xls", 
    skip = 2) %>% 
  mutate(anio = 2015) %>% 
  group_by(Operador) %>% 
  mutate_all(as.double)

pozo_iapg_16 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2016.xls", 
    skip = 2) %>% 
  mutate(anio = 2016)

pozo_iapg_17 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2017.xls", 
    skip = 2)  %>% 
  mutate(anio = 2017)

pozo_iapg_18 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2018.xls", 
    skip = 2)  %>% 
  mutate(anio = 2018)

pozo_iapg_19 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/POZOSPERFORADOS_2019.xls", 
    skip = 2)  %>% 
  mutate(anio = 2019) %>% 
  rename("Total Pozos" = "Total Pozos Terminados")

#se me colaron algunas filas de totales que hay que borrar
pozos_iapg <- pozo_iapg_05 %>% 
  bind_rows(pozo_iapg_06, pozo_iapg_07, pozo_iapg_08, pozo_iapg_09, 
            pozo_iapg_10, pozo_iapg_12, pozo_iapg_13, pozo_iapg_14, pozo_iapg_15,
            pozo_iapg_16, pozo_iapg_17, pozo_iapg_18, pozo_iapg_19) %>%
  rename(total_pozos =  "Total Pozos") %>% 
  filter(!(Operador %in% c("Totales", "TOTAL")) & !(is.na(Operador)) ) %>% 
  mutate(empresa =case_when(Operador == "YPF S.A." ~ "YPF",
                            Operador == "PAN AMERICAN ENERGY (SUCURSAL ARGENTINA) LLC" ~ "PAE",
                            Operador == "PAN AMERICAN ENERGY SL" ~ "PAE",
                            Operador == "PAN AMERICAN" ~ "PAE",
                            Operador == "PETROBRAS ARGENTINA S.A." ~ "Petrobras",
                            Operador == "PESA (PETROBRAS E.S.A.)" ~ "Petrobras",
                            Operador == "TECPETROL S.A." ~ "Tecpetrol",
                            Operador == "PLUSPETROL S.A." ~ "Pluspetrol",
                            Operador == "SINOPEC ARGENTINA EXPLORATION INC" ~ "Sinopec",
                            Operador == "COMPAÑÍA GENERAL DE COMBUSTIBLES S.A." ~ "CGC",
                            Operador == "VISTA OIL & GAS ARGENTINA SA" ~ "Vista Oil and Gas",
                            Operador == "VISTA OIL & GAS ARGENTINA SAU" ~ "Vista Oil and Gas",
                            Operador == "WINTERSHALL ENERGIA S.A." ~ "Wintershall",
                            Operador == "ENAP SIPETROL ARGENTINA S.A." ~ "ENAP SIPETROL",
                            Operador == "YSUR ENERGÍA ARGENTINA S.R.L." ~ "YSUR",
                            Operador == "YSUR PETROLERA ARGENTINA S.A" ~ "YSUR",
                            Operador == "TOTAL AUSTRAL S.A." ~ "Total Austral",
                            T ~ Operador)) %>%
  filter(!is.na(empresa)) %>% 
  ungroup() %>% 
  select(empresa, anio,total_pozos) %>% 
  group_by(anio, empresa) %>% 
  summarise(total_pozos = sum(total_pozos)) %>% 
  arrange(anio)
pozos_iapg

graf_pozos_iapg <- pozos_iapg %>% 
  ggplot(aes(anio, total_pozos, fill = empresa))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")+
  labs(title = "Pozos perforados",
       caption = "IAPG")
ggplotly(graf_pozos_iapg, width = 600, height = 400)
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
#pozos iapg acumulados
pozos_iapg_centenario <- read_delim("C:/Archivos/Datos/Hidrocarburos/Pozos/IAPG/pozos_iapg_centenario.csv", ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  rename(totales = totale)

graf_pozos_iapg_centenario <- pozos_iapg_centenario %>% 
  ggplot(aes(anio, totales))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")+
  labs(title = "Pozos en extracción definitiva",
       caption = "IAPG")
ggplotly(graf_pozos_iapg_centenario, width = 600, height = 400)


# comparacion de fuentes
comparacion_pozos <- pozos_iapg %>% 
  group_by(anio) %>% 
  summarise(pozos_perforados_iapg = sum(total_pozos, na.rm = T)) %>% 
  right_join(pozos_terminados %>%
               group_by(anio) %>% 
               summarise(pozos_terminados_sec_energia = sum(pozos, na.rm = T))) %>% 
  right_join(listado_pozos %>% 
                rename(anio = anio_terminacion_pozo) %>% 
                group_by(anio) %>% 
                summarise(pozos_cargados_sec_energia = sum(pozos, na.rm = T))) %>% 
  full_join(pozos_iapg_centenario %>% 
              mutate(variacion_pozos = variacion_interanual(totales)) %>%
              select(anio, pozos_variacion_iapg = variacion_pozos)) 


graf_pozos <- comparacion_pozos %>%
  gather(key = "fuente",
         value = "valor",
         2:ncol(.)) %>% 
  ggplot(aes(anio, valor, color = fuente))+
  geom_line()+
  # geom_point()+
  ylim(0, 1700 )+
  labs(title = "Pozos. Comparación de fuentes")+
  theme(legend.position = "bottom")
ggplotly(graf_pozos, width = 800, height = 400)
```


ver relaciones
* PBI hidrocarburos / PBI total (ver cual elegir)
* corregir nuestro VBP depurando servicios
* MIP's coef tecnico (para ver CI en el sector petrolero y peso del sector petrolero en PBI)

* stock petrolero / stock total JIC,EM 
* Stock extraccion = PPyE PAE + PPyE Tecp + PPyE Petrobras upstr + Activo YPF upstream
  * ver que porcentaje que representan estas empresas en la produccion o pozos y ver de ampliarlo 
  * ver relacion Activo YPF upstream / PPyE integrada YPF
  * ver relacion ganancias AFIP y BOLSAR con el stock correspondiente (coherencia) 
  * ver relacion con Coremberg
  * pasar ENGE 

*grinberg
  * convertir lo nuestro a costos. agarrar nuestros valor y dividirlo por barriles (sumando gas en BOE)
  * costos por bbl, precio el barril y precio de produccion (sumo la gcia normal al costo1)


## Activos

Pasar datos de bs de uso en yacimientos para armar relación activo yacimeinto/total

Fuentes:

* Balances de Bolsar (unicamente empresas que cotizan en la bolsa de valores argentina). Revisar el stock del sector distribución porque se presenta demasiado grande con respecto al de los demás. Falta pasar los datos del activo de casi todas las empresas
* AFIP. Con esta fuente no tenemos calculo de renta, sino que solo usamos la TG como parámetro. Nota: "_c" significa casos presentados de la variable correspondiente
* Memorias de YPF. La década de los 80 presenta picos que hay que revisar


* Calculo del Capital Total Adelantado (KTA) 

  + Bolsar: Es equivalente a la suma de Propiedad, Planta y Equipos Neta (descontando los terrenos y obras en curso) y los Inventarios. Cuando los datos lo habilitan, se le agregó los salarios adelantados (salarios y cargas consumidos sobre rotación). Luego, cuando no se presentaron datos de Propiedad, Planta y Equipos, se tomó el activo no corriente.
  + AFIP: Es equivalente a la suma de Bienes de Uso, Bienes de Cambio, Inventarios y Disponibilidades.
  + Memoria YPF: Suma de Bienes de Uso y Bienes de Cambio



```{r echo=FALSE, message=FALSE, warning=FALSE}
# BOLSAR

#segmentos de YPF y Petrobras
ypf_seg <- read_delim("C:/Archivos/Datos/Balances/gas y petroleo_datos/datos_r/ypf_segmentos.csv", 
    ",", escape_double = FALSE, trim_ws = TRUE) %>% 
  select(-X1) %>% 
  mutate(sector = case_when( sector ==  "quimica" ~ "petroquimica",
                             T ~ sector),
         anio = year(fecha))

petrobras_ar_seg <- read_delim("C:/Archivos/Datos/Balances/gas y petroleo_datos/datos_r/petrobras_arg_segmentos.csv", 
    ",", escape_double = FALSE, trim_ws = TRUE)%>% 
  select(-X1)

union_segmentos <- ypf_seg %>% 
  select(anio, empresa,sector, unidad, activo = activos) %>% 
  bind_rows(petrobras_ar_seg %>% 
              rename(anio = fecha) %>% 
              select(anio , empresa, unidad, sector, prop_planta_equipo = ppye, activo = activos)) %>% 
  gather(key = variable,
         value = valor,
         5:ncol(.)) %>%
  left_join(ipc_promedio %>% select(anio, ipc_18)) %>% 
  mutate(valor =valor/ipc_18,
         unidad = "Millones de pesos 2018") %>% 
  select(-ipc_18)

stock_segmentos <- union_segmentos %>% 
  group_by(anio, sector, variable ,unidad ) %>% 
  summarise(valor = sum(valor, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(fuente = "Activo de YPF y Petrobras",
         variable_sector = paste(variable, sector, sep = " "))


## Stock por empresas
stock_balances_empresas <- read_csv("C:/Archivos/Datos/Balances/gas y petroleo_datos/datos_r/resultados/balances_arg.csv", 
    col_types = cols(X1 = col_skip())) %>% 
  filter( !(empresa %in% c("chevron_global", "petrobras_global" ))) %>% 
  mutate(unidad = "Millones de pesos 2018",
         anio = year(fecha),
         fuente = "Bolsar") %>%
  select(anio,fuente, everything(.), -c(fecha, pais, tg_ant, tg_desp, rotacion)) %>% 
   gather(key = variable,
         value = valor,
         6:ncol(.)) %>% 
  left_join(ipc_promedio %>% select(anio, ipc_18)) %>% 
  mutate(valor = valor /ipc_18,
         empresa = case_when(empresa == "petrobras_ar" ~ "Petrobras",
                             empresa == "tecpetrol" ~ "Tecpetrol",
                             empresa == "camuzzi_pamp" ~ "Camuzzi Gas Pampeana",
                             empresa == "metrogas" ~ "Metrogas",
                             T ~ empresa)) %>% 
  group_by(anio, empresa,fuente, sector, unidad, variable) %>%
  summarise(valor = sum(valor, na.rm = T)) %>%
  filter(variable %in% c("KTA", "ppye", "ppye_neta" , "inventarios", "activo_no_corr", "activo"))
    


## Stock por rama
stock_balances_rama <-  stock_balances_empresas %>%
  ungroup() %>% 
  bind_rows(stock_segmentos %>% 
              # filter(sector == "upstream" & variable == "activo") %>%
              filter(variable_sector == "activo upstream") %>%
              select(-variable_sector) %>%
              mutate(sector = case_when(sector == "upstream" ~ "produccion"),
                     variable =  case_when(variable == "activo" ~ "ppye"),
                     fuente = "Bolsar",
                     empresa ="YPF y Petrobras")) %>% 
  group_by(anio, sector,variable, unidad, fuente) %>%
  summarise(valor = sum(valor, na.rm = T))  
  
  # spread(key = sector,
  #        value = KTA) %>% 
  # mutate(integrada_y_extraccion = integrada + produccion,
  #        variable = "KTA") %>% 
  # rename(extraccion = produccion) %>% 
  # select(anio, variable, moneda, everything(.))


####################################
# Tasas de depreciacion
#AFIP
tasa_depreciacion_afip <- read_excel("C:/Archivos/Datos/AFIP/gcia_v8.xlsx", 
    skip = 4) %>%
  select(-c(49:ncol(.))) %>% 
  group_by( rama, year) %>% 
  summarise(tasa_depreciacion = depreciacionbsuso/bsuso)
#Balances
read_csv("C:/Archivos/Datos/Balances/gas y petroleo_datos/datos_r/resultados/balances_arg.csv", 
         col_types = cols(X1 = col_skip())) %>%
    filter(empresa == "YPF") %>% 
    group_by(empresa) %>% 
    mutate(tasa_depreciacion = depreciaciones/ppye) %>% 
  select(fecha, empresa, tasa_depreciacion)


###AFIP
# Stock de balances -  AFIP
datos_afip <- read_excel("C:/Archivos/Datos/AFIP/gcia_v8.xlsx", 
    skip = 4) %>%
  select(-c(49:ncol(.)))  %>% 
  rename(anio = year,
         idsector = idrama) %>% 
  mutate(unidad = "pesos corrientes",
         sector = case_when( rama == "petro" ~ "extraccion_petroleo_gas",
                           rama == "ser_petro" ~ "servicios_petroleros",
                           T ~ rama))%>% 
  select(anio, unidad, idsector, sector, everything(.), -rama)
datos_afip


stock_afip <- datos_afip %>% 
  group_by(anio, idsector, sector, unidad) %>% 
  summarise(KTA = disponibilidades + bscambio + inventarios + bsuso,
            ppye = sum(bsuso, na.rm = T),
            activo = sum(activo, na.rm = T)) %>%
  left_join(ipc_promedio %>% select(anio, ipc_18)) %>%
  mutate(KTA = (KTA/10^6) / ipc_18,
         ppye= (ppye/10^6) / ipc_18,
         activo= (activo/10^6) / ipc_18,
         unidad = "Millones de pesos 2018") %>% 
  arrange(idsector) %>% 
  filter(sector %in% c("extraccion_petroleo_gas", "servicios_petroleros")) %>%
  ungroup() %>% 
  select(-c(idsector, ipc_18)) %>% 
  gather(key = variable,
         value = valor,
         4:ncol(.)) %>% 
  mutate(fuente = "AFIP")
stock_afip



################################## 
# Memorias YPF 
balance_ypf <- read_excel("C:/Archivos/Datos/Hidrocarburos/Excels de Betania/Calculos Betania Tg.xls", 
    sheet = "YPF_A $HOY_PARADEFLACYCALCULAR", 
    skip = 1) %>% 
  select(-c(12:ncol(.))) %>% 
  mutate_all(as.double) %>% 
  rename(anio = "Año",
         unidad = moneda,
         ventas = "Ventas...3",
         costo_ventas = "Costo de las Ventas...4",
         utilidad_neta = "Utilidad neta",
         utilidad_operativa = "Utilidad operativa",
         ppye = "Bs Uso",
         bienes_de_cambio = "Bs Cambio",
         utilidad_neta_antes_impuestos = "UN antes de impuestos (g´ activos y dividendos)",
         activo = "Activo Total",
         patrimonio_neto = "Patrimonio Neto") %>%
  filter(!(is.na(anio))) %>%
  group_by(anio, unidad) %>%
  mutate_all(function(x) {x / 10^6}) %>%
  ungroup() %>% 
  left_join(ipc_promedio %>% select(anio, ipc_18)) %>%
  mutate(unidad = "Millones de pesos  de 2018",
         ventas =ventas/ipc_18,
         costo_ventas = costo_ventas/ipc_18,
         utilidad_neta = utilidad_neta/ipc_18,
         utilidad_operativa = utilidad_operativa/ipc_18,
         ppye = ppye/ipc_18,
         bienes_de_cambio = bienes_de_cambio/ipc_18,
         utilidad_neta_antes_impuestos = utilidad_neta_antes_impuestos/ipc_18,
         activo = activo/ipc_18,
         patrimonio_neto = patrimonio_neto/ipc_18,
         KTA = ppye + bienes_de_cambio,
         sector = "Memoria de YPF") %>% 
  select(anio, sector, unidad, everything(.)) 
balance_ypf

stock_ypf <- balance_ypf %>% 
  gather(key = variable,
         value = valor, 
         4:ncol(.)) %>% 
  filter(variable %in% c("KTA", "activo", "ppye")) %>% 
  mutate(valor = case_when(anio == 1983 ~ 0,
                           anio == 1985 ~ 0,
                           anio == 1986 ~ 0,
                           anio == 1987 ~ 0,
                           anio == 1988 ~ 0,
                           T ~ valor)) %>%
  bind_rows(stock_balances_empresas %>% 
    ungroup() %>% 
    select(anio,  sector =empresa, unidad, variable, valor ) %>% 
    filter(sector == "YPF",
           variable  %in% c("KTA", "activo", "ppye")))
  

```

### Stock total de la rama 
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Stock de la rama
stock_rama <- stock_afip %>% 
  bind_rows(stock_balances_rama)

# write.csv(stock_rama, file ="/Archivos/Datos/Stock/stock_hidrocarburos.csv")


graf_stock_rama <- stock_rama %>% 
  # mutate(valor = number_format(valor, big.mark = " " )) %>% 
  filter(sector != "distribucion") %>%
  ggplot(aes(anio, valor, color = sector, shape = fuente))+
  geom_line()+
  geom_point(size = .8)+
  theme(legend.position = "bottom")+
  labs(title = "Stock de capital adelantado y activo de segmentos",
       subtitle = "Subsectores del sector hidrocarburífero",
       y = "Millones de pesos de 2018")+
  theme_classic()+
  facet_wrap(~ variable )

ggplotly(graf_stock_rama, width = 800, height = 400)
```


### Stock de segmentos de YPF y Petrobras
```{r echo=FALSE, message=FALSE, warning=FALSE}
graf_stock_segmentos <- union_segmentos %>% 
  ggplot(aes(anio, valor, color = sector))+
  geom_line()+
  theme(legend.position = "bottom")+
  labs(title = "Stock de capital de segmentos",
       subtitle = "YPF y Petrobras Argentina",
       y = "Millones de pesos de 2018")+
  theme_classic()+
  facet_wrap(variable ~ empresa )

ggplotly(graf_stock_segmentos, width = 700, height = 500)


```

### Stock por empresas

```{r echo=FALSE, message=FALSE, warning=FALSE}

graf_stock_emp <- stock_balances_empresas %>%
  filter(
    # variable %in% c("KTA", "activo"),
         sector != "distribucion") %>% 
  ggplot(aes(anio, valor, color = empresa))+ 
  geom_line()+
  geom_point()+
  labs(title = "Stock de capital por empresa",
        y = "Millones de pesos de 2018")+
  facet_wrap(~variable)
ggplotly(graf_stock_emp, width = 700, height = 500)


```

### YPF largo plazo
Comparación entre la Memoria YPF (recopilado por BFR) y los balances extríados de Bolsar
```{r echo=FALSE, message=FALSE, warning=FALSE}

graf_stock_ypf <-  stock_ypf %>% 
  ggplot(aes(anio, valor, color = sector))+ 
  geom_line()+
  geom_point()+
  labs(title = "Stock de capital de YPF",
        y = "Millones de pesos de 2018")+
  facet_wrap(~variable)
ggplotly(graf_stock_ypf, width = 700, height = 500)

```

### Estimación de stock de capital a partir de la evolución de pozos perforados


El ejercicio consiste en verificar si los pozos terminados sirven como indicador de la inversión y, por lo tanto, de aproximador al stock de capital adelantado. Para ello se parte de un año base de la serie de Propiedad, Planta y Equipo del sector extracción de Bolsar y AFIP, para luego indexar las variables por la evolución de los pozos. Los balances de Bolsar que corresponden únicamente a extracción son dos: PAE y Tecpetrol, por lo que el valor obtenido puede estar subrepresentado para dar cuenta del total de la rama. Con respecto al índice de pozos, se tomaron dos series alternativas: una construída a partir del stock de pozos en extracción efectiva (fuente: IAPG) y otra elaborada con los pozos terminados anuales cargados por empresa operadora (fuente: Secretaría de Energía).  

El año base elegido es 2006, dado que es el último dato que poseemos del stock de pozos totales en actividad de IAPG.

Se realizó la misma estimación para YPF, filtrando las variables de Propiedad, Planta y Equipo (para el total de la empresa, por lo que incluye no sólo extracción sino refinación y otros rubros) y activo total del upstream. Se utilizó únicamente el indice de pozos terminados anuales de YPF para estimar la PPyE y el  activo, dado que no se posee valores del stock de pozos en perforación para los años en donde existen valores contables que sirvan de año base. Luego, se estimó un stock de capital total de rama a partir de ponderar el stock de YPF por la relación entre los pozos de YPF y los pozos totales de la rama.


En síntesis, el listado de variables estimadas- a partir de las dos series de pozos (stock y flujo),salvo para la estimación de YPF que solo se pudo hacer con flujo de pozos por ausencia de información- es las siguientes:

* $ppye\_estimado\_bolsar$ = $PPyE\ año\ base\ de\ Bolsar$ * $indice\ de\ pozos$
* $ppye\_estimado\_afip$ = $PPyE\ año\ base\ de\ AFIP$ * $indice\ de\ pozos$

* $ppye\_estimado\_ypf$ = $PPyE\ año\ base\ de\ YPF$ * $indice\ de\ pozos\ YPF$
* $activo\_estimado\_upstream\_ypf$ = $Activo\ año\ base\ de\ YPF$ * $indice\ de\ pozos\ YPF$

* $ppye\_estimado\_total$ = $ppye\_estimado\_ypf$ * $$\frac{pozos\ totales}{pozos\ de\ YPF}$$

* $activo\_estimado\_upstream$ = $activo\_estimado\_upstream\_ypf$  * $$\frac{pozos\ totales}{pozos\ de\ YPF}$$

Para poder seleccionar la estimación más adecuada, se realizó un análisis de correlación entre todas las series estimadas y los valores contables que se poseen de PPyE de AFIP, Bolsar e YPF. Se presentan distintos cuadros de correlaciones, con sus nivles de significancia, diagramas de dispersión entre variables y su distribución. Las series construídas que poseen mejor correlación son la Propiedad, Planta y Equipo a partir de Bolsar estimadas con índice de stock de pozos (correlación fuerte de 0.89 y significativa al 0.001) y flujo de pozos (correlación moderada de 0.54 y significativa al 0.05) y luego el activo del upstream total de la rama a partir de YPF (correlación moderada de 0.42 y significativa al 0.1 con los valores contables de YPF y correlación fuerte de 0.88 y significativa al 0.001 con las estimaciones de PPyE de AFIP y Bolsar a partir de flujo de pozos).

la estimación tiene que realizarse con PPyE porque hay que excluir salarios e inventarios (que están en KTA)

#### Análisis de correlacion entre Propiedad, Planta y Equipo y Pozos en producción


reemplazar ipc por un ibif o indice especifico

##### Total rama
```{r echo=FALSE, message=FALSE, warning=FALSE}

stock_y_pozos_tasas <- stock_rama %>% 
  filter(variable == "ppye" & sector %in% c("extraccion_petroleo_gas", "produccion")) %>%
  select(anio, valor,fuente) %>%
  arrange(anio) %>% 
  spread(key = fuente, value = valor) %>% 
  mutate(AFIP = variacion_interanual(AFIP),
         Bolsar = variacion_interanual(Bolsar)) %>% 
  full_join(comparacion_pozos 
            %>%
            # select(- pozos_perforados_iapg)
            select(- pozos_variacion_iapg)
            , by = "anio") %>%
  rename(ppye_afip = AFIP,
         ppye_bolsar = Bolsar,
         pozos_iapg = pozos_perforados_iapg,
         # pozos_iapg_centenario = pozos_variacion_iapg,
         pozos_terminados = pozos_terminados_sec_energia,
         pozos_cargados = pozos_cargados_sec_energia ) %>% 
  arrange(anio) %>%
  filter(anio > 1998) %>%
  select(-anio) %>%
  mutate_all(tasa_crecimiento)  
  


GGally::ggpairs(stock_y_pozos_tasas, lower = list(continuous = "smooth"))
plot(stock_y_pozos_tasas)

# round(var(stock_y_pozos_tasas, na.rm = TRUE), 4)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

#matriz de correlacion
cor_pozos <- cor(stock_y_pozos_tasas, use = "complete.obs")
cor_pozos

#  distintos correlogramas
#con ggcorrplot
library(ggcorrplot)
p.mat = cor_pmat(stock_y_pozos_tasas)
ggcorrplot(cor_pozos, hc.order = TRUE,
    type = "lower", p.mat = p.mat, lab = T)

# # #con corrplot
# col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
# corrplot::corrplot(cor_pozos, method="color", col=col(200),
#          type="upper", order="hclust",
#          addCoef.col = "black", # Add coefficient of correlation
#          tl.col="black", tl.srt=45, #Text label color and rotation
#          # Combine with significance
#          # p.mat = p.mat,
#          # insig = "blank",
#          sig.level = 0.01)

# # #con gggally
# GGally::ggcorr(stock_y_pozos_tasas, method = c("complete.obs", "pearson") ,
#                label = T, label_round = 2)
```

```{r}
#años base 2006
ppye_anio_base_bolsar <- (stock_rama %>% 
  filter(variable == "ppye" & sector == "produccion") %>%
  select(anio, unidad, ppye = valor))
ppye_anio_base_bolsar <- ppye_anio_base_bolsar$ppye[ppye_anio_base_bolsar$anio ==2006]

# valor_base <- serie[which(fecha==fecha_base)]

ppye_anio_base_afip <- (stock_rama %>% 
  filter(variable == "ppye" & sector == "extraccion_petroleo_gas") %>%
  select(anio, unidad, ppye = valor))
ppye_anio_base_afip <- ppye_anio_base_afip$ppye[ppye_anio_base_afip$anio == 2006]


stock_y_pozos <-  comparacion_pozos %>% 
  gather(key = fuente_pozo,
         value = cantidad_pozos,
         2:ncol(.)) %>%
  arrange(fuente_pozo,anio) %>% 
  group_by(fuente_pozo) %>% 
  mutate(indice_pozos_06 = generar_indice(serie= cantidad_pozos ,
                                        fecha = anio,
                                        fecha_base = 2006)) %>% 
  # left_join(stock_rama %>%  
  #             filter(variable == "ppye" & sector %in% c("extraccion_petroleo_gas", "produccion")) %>%
  #             select(anio, ppye = valor, fuente_stock = fuente), by = "anio") %>% 
  mutate(ppye_afip = ppye_anio_base_afip * indice_pozos_06,
         ppye_bolsar =ppye_anio_base_bolsar * indice_pozos_06,
         unidad_ppye="Millones de pesos 2018") %>% 
  gather(key = fuente_ppye,
         value = ppye_estimado,
         5:6)
stock_y_pozos

ggplotly(stock_y_pozos %>% 
  filter(anio >1960) %>% 
  ggplot(aes(anio,ppye_estimado , color = fuente_pozo))+
  geom_line()+
  labs(y= "Millones de pesos de 2018")+
  facet_wrap(~fuente_ppye    ),
    width = 800, length =500)

#stock estimado a partir de pozos
stock_estimado <- stock_y_pozos %>% 
  ungroup() %>% 
  filter(fuente_pozo =="pozos_cargados_sec_energia", fuente_ppye =="ppye_bolsar") %>% 
  rename(unidad = unidad_ppye, valor =ppye_estimado) %>% 
  select(-c(cantidad_pozos, indice_pozos_06, fuente_pozo))


#diferencia entre ppye estimada y valor contable de bolsar
stock_estimado %>% 
  left_join(stock_rama %>% 
              filter(fuente=="Bolsar", variable =="ppye", sector == "produccion") %>% 
              select(anio, unidad, ppye_bolsar = valor)) %>% 
  na.omit() %>% 
  mutate(diff = (valor/ppye_bolsar -1)*100)

#cambio stock solo para los años que tenemos BOLSAR
stock_estimado <- stock_rama %>% 
              filter(fuente %in% c("Bolsar", "AFIP"), variable =="ppye", 
                     sector %in% c("produccion", "extraccion_petroleo_gas")) %>% 
              select(anio, unidad,fuente_ppye=fuente , valor)
  
  
```


###### Stock de pozos
```{r}
stock_y_pozos_tasas_v2 <- stock_rama %>% 
  filter(variable == "ppye" & sector %in% c("extraccion_petroleo_gas", "produccion")) %>%
  select(anio, valor,fuente) %>%
  spread(key = fuente, value = valor) %>% 
  full_join(pozos_iapg_centenario%>%
            select(anio, pozos_iapg = totales ), by = "anio") %>%
  rename(ppye_afip = AFIP,
         ppye_bolsar = Bolsar ) %>% 
  arrange(anio) %>%
  filter(anio > 1998) %>%
  select(-anio) %>%
  mutate_all(tasa_crecimiento)  
  


GGally::ggpairs(stock_y_pozos_tasas_v2, lower = list(continuous = "smooth"))
plot(stock_y_pozos_tasas_v2)

# round(var(stock_y_pozos_tasas, na.rm = TRUE), 4)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

#matriz de correlacion
cor_pozos <- cor(stock_y_pozos_tasas_v2, use = "complete.obs")
cor_pozos

#  distintos correlogramas
#con ggcorrplot
library(ggcorrplot)
p.mat = cor_pmat(stock_y_pozos_tasas)
ggcorrplot(cor_pozos, hc.order = TRUE,
    type = "lower", p.mat = p.mat, lab = T)

# # #con corrplot
# col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
# corrplot::corrplot(cor_pozos, method="color", col=col(200),
#          type="upper", order="hclust",
#          addCoef.col = "black", # Add coefficient of correlation
#          tl.col="black", tl.srt=45, #Text label color and rotation
#          # Combine with significance
#          # p.mat = p.mat,
#          # insig = "blank",
#          sig.level = 0.01)

# # #con gggally
# GGally::ggcorr(stock_y_pozos_tasas, method = c("complete.obs", "pearson") ,
#                label = T, label_round = 2)
```


##### YPF
```{r}
ppye_ypf <- ypf_seg %>% 
  filter(sector  == "upstream" ) %>% 
  mutate(anio = year(fecha)) %>% 
  left_join(ipc_promedio %>% 
              select(anio, ipc_18), by = "anio") %>% 
  mutate(variable = "activo_upstream_ypf",
         activos = activos/ipc_18,
         unidad = "Millones de pesos 2018")%>% 
  select(anio, empresa, unidad ,  activo_upstream= activos) %>% 
  left_join(stock_balances_empresas %>% 
    ungroup() %>% 
    filter(variable == "ppye" & empresa == "YPF") %>%
    select(anio, empresa, unidad, ppye_integrada =valor) , by = c("anio", "empresa", "unidad")) %>% 
  mutate(activo_upstream = variacion_interanual(activo_upstream),
         ppye_integrada = variacion_interanual(ppye_integrada)) %>% 
  full_join(listado_pozos %>%
              select(-empresa) %>% 
              ungroup() %>% 
              filter(idempresa == "YPF") %>% 
              rename(anio = anio_terminacion_pozo, empresa = idempresa), by = c("anio", "empresa") ) %>% 
  arrange(anio)
ppye_ypf

ppye_ypf_tasas <- ppye_ypf %>%
   arrange(anio) %>%
  filter(anio %in% 1998:2018) %>%
  select(-c(anio, empresa, unidad)) %>%
  mutate_all(tasa_crecimiento)

#matriz de correlacion
cor_pozos_ypf <- cor(ppye_ypf_tasas, use = "complete.obs")
cor_pozos_ypf

#  distintos correlogramas
#con ggcorrplot
p.mat = cor_pmat(cor_pozos_ypf)
ggcorrplot(cor_pozos_ypf, hc.order = TRUE,
    type = "lower", p.mat = p.mat, lab = T)

GGally::ggpairs(ppye_ypf_tasas, lower = list(continuous = "smooth"))
plot(ppye_ypf_tasas)
```


```{r}
#años bases
anio_base_ypf_segmento <-   ppye_ypf$activo_upstream[ppye_ypf$anio == 2006]

anio_base_ypf_bolsar <- ppye_ypf$ppye_integrada[ppye_ypf$anio == 2006]


stock_y_pozos_ypf <-  ppye_ypf %>% 
  mutate(indice_pozos_06 = generar_indice(serie= pozos ,
                                        fecha = anio,
                                        fecha_base = 2006)) %>% 
  mutate(ppye_ypf_estimado = anio_base_ypf_bolsar * indice_pozos_06,
         activo_ypf_estimado =anio_base_ypf_segmento * indice_pozos_06,
         unidad_ppye="Millones de pesos 2018")

stock_y_pozos_ypf %>%
           select(anio, unidad = unidad_ppye, ppye_ypf_estimado, activo_ypf_estimado) %>%
           gather(key = estimacion,
                   value = valor, 
                   3:4) %>% 
           filter(anio >1960) %>% 
  ggplot(aes(anio,valor , color = estimacion))+
  geom_line()+
  labs(y= "Millones de pesos de 2018", title = "Estimacion de Activo usptream y PPyE de YPF a partir de indice de pozos")
```

###### PPyE y activo upstream total rama a partir de YPF

```{r}
pozos_yfp_sobre_total <- listado_pozos %>%
  rename(anio = anio_terminacion_pozo) %>% 
  group_by(anio) %>% 
  summarise(pozos_cargados_sec_energia = sum(pozos, na.rm = T)) %>% 
  left_join(listado_pozos %>%
              rename(anio = anio_terminacion_pozo) %>% 
              filter(idempresa == "YPF") %>% 
              group_by(anio, idempresa) %>% 
              summarise(pozos_cargados_ypf = sum(pozos, na.rm = T))) %>% 
  mutate(ypf_sobre_total = pozos_cargados_ypf/pozos_cargados_sec_energia)
# pozos_yfp_sobre_total

estimacion_ppye_total_via_ypf <- stock_y_pozos_ypf %>% 
  select(anio, unidad = unidad_ppye, ppye_ypf_estimado, activo_ypf_estimado) %>% 
  gather(key = estimacion,
         value = valor, 
         3:4) %>% 
  left_join(pozos_yfp_sobre_total %>% 
              select(anio, ypf_sobre_total)) %>% 
  mutate(valor = valor/ypf_sobre_total,
          estimacion = case_when(estimacion == "ppye_ypf_estimado" ~ "ppye_estimado_total",
                                 estimacion == "activo_ypf_estimado" ~ "activo_estimado_upstream" ))
  
estimacion_ppye_total_via_ypf %>%
           filter(anio >1960) %>% 
  ggplot(aes(anio,valor , color = estimacion))+
  geom_line()+
  labs(y= "Millones de pesos de 2018", 
       title = "Estimacion de Activo usptream y PPyE total a partir de ampliación de pozos YPF")
```









## Inversiones

Fuentes: 

* Balances de Bolsar. Inversión calculada a partir de variaciones del activo + consumo de capital fijo (esto último está pendiente)
* Secretaria de Energía. Resolución 2057 
  + [Inversiones realizadas año anterior](http://datos.minem.gob.ar/dataset/inversiones-en-mercado-de-hidrocarburos-upstream/archivo/285d45e5-1b88-4dae-8e5c-c01843c7c8c0)
  + [Inversiones anuales previstas a realizar en el año de la presentación de la DDJJ](http://datos.minem.gob.ar/dataset/inversiones-en-mercado-de-hidrocarburos-upstream)


4) construir serie de inversión para atras (buscar Stock de YPF pero solo para extracción). armar ejercicio de FD y ver si las proporciones se mantienen. 

* Reconstruccion de serie de inversion por empresa
ver un flujo de pozos y un flujo de inversion y luego ver si lo que mueve la inversion son los pozos (que su evolucion sea similar). 

- inversion por empresa (balance: variacion del activo + consumo de K fijo)
- inversion por empresa (secretaria de energia)
- inversion agregada (tipo de inversion) (cuentas nacionales?)
- pozos nuevos por empresa por año
- pozos nuevos totales
- aplicar MIP para YPF 

Inversión a partir de Balances
```{r echo=FALSE, message=FALSE, warning=FALSE}

inversiones_empresa <- stock_balances_empresas %>%
  ungroup() %>% 
  select(-c(fuente, sector)) %>% 
  filter(variable == "ppye") %>%
  arrange(empresa, anio) %>% 
  group_by(unidad, variable, empresa) %>%
  mutate(valor = variacion_interanual(valor))
   
# inversiones_empresa

graf_inversiones_empresa <- inversiones_empresa %>% 
  filter(empresa != "Camuzzi Gas Pampeana") %>% 
  ggplot(aes(anio, valor, color = empresa))+ 
  geom_line()+
  geom_point()+
  labs(title = "Inversiones por empresa",
       subtitle = "A partir de balances",
        y = "Millones de pesos de 2018",
       caption = "Balances de empresas extraídos de Bolsar")+
  facet_wrap(~variable)
# ggplotly(graf_inversiones_empresa, width = 800, height = 600)

```


Inversión a partir de Secretaria de Energía
```{r echo=FALSE, message=FALSE, warning=FALSE}
inversiones_anio_anterior <- read_csv("C:/Archivos/Datos/Hidrocarburos/Inversion/Secretaria de Energia/resolucin-2057-inversiones-realizadas-ao-anterior.csv", 
    col_types = cols(`Fecha Fin Tareas` = col_date(format = "%d/%m/%Y"), 
        `Fecha Inicio Tareas` = col_date(format = "%d/%m/%Y"))) %>% 
  rename(anio = "Año de presentación de la DDJJ",
         empresa = "Empresa informante",
         concepto = "Descripción del plan de acción (Conceptos)",
         cantidad_exploracion = "Cant. Exploracion",
         cantidad_explotacion = "Cant. Explotacion",
         cantidad_exploracion_complementaria = "Cant. Exploracion Complementaria",
         exploracion_millones_usd = "Millones u$s Exploracion",
         explotacion_millones_usd = "Millones u$s Explotacion",
         exploracion_compl_millones_usd = "Millones u$s Exp. Complementaria") %>% 
  mutate(anio = anio - 1,
         empresa =case_when(empresa == "YPF S.A." ~ "YPF",
                            empresa == "PAN AMERICAN ENERGY (SUCURSAL ARGENTINA) LLC" ~ "PAE",
                            empresa == "PAN AMERICAN ENERGY SL" ~ "PAE",
                            empresa == "PETROBRAS ARGENTINA S.A." ~ "Petrobras",
                            empresa == "PESA (PETROBRAS E.S.A.)" ~ "Petrobras",
                            empresa == "ENAP SIPETROL ARGENTINA S.A." ~ "ENAP SIPETROL",
                            empresa == "VISTA OIL & GAS ARGENTINA SAU" ~ "Vista Oil and Gas",
                            empresa == "VISTA OIL & GAS ARGENTINA SA" ~ "Vista Oil and Gas",
                            empresa == "SINOPEC ARGENTINA EXPLORATION AND PRODUCTION, INC." ~ "Sinopec",
                            empresa == "TECPETROL S.A." ~ "Tecpetrol", 
                            empresa == "PLUSPETROL S.A." ~ "Pluspetrol",
                            empresa == "PLUSPETROL ENERGY S.A." ~ "Pluspetrol",
                            empresa == "COMPAÑÍA GENERAL DE COMBUSTIBLES S.A." ~ "CGC",
                            empresa == "WINTERSHALL ENERGIA S.A." ~ "Wintershall",
                            empresa == "YSUR ENERGÍA ARGENTINA S.R.L." ~ "YSUR",
                            empresa == "YSUR PETROLERA ARGENTINA S.A." ~ "YSUR",
                            empresa == "TOTAL AUSTRAL S.A." ~ "Total Austral",
                            T ~ empresa)) %>% 
  select(anio, empresa, idempresa,  concepto,
         cantidad_exploracion, cantidad_explotacion,cantidad_exploracion_complementaria,
         exploracion_millones_usd,explotacion_millones_usd, exploracion_compl_millones_usd ) %>% 
  # filter(str_detect(concepto, 'pozo')) %>%
  group_by(empresa, anio) %>% 
  summarise(inversion_explotacion = sum(explotacion_millones_usd, na.rm = T)) %>% 
  arrange(-inversion_explotacion) %>% 
  mutate(unidad = "Millones de USD")
inversiones_anio_anterior
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
resolucin_2057_inversiones_realizadas_mensual <- read_csv("C:/Archivos/Datos/Hidrocarburos/Inversion/Secretaria de Energia/resolucin-2057-inversiones-realizadas-mensual.csv")

resolucin_2057_inversiones_fin_concesion<- read_csv("C:/Archivos/Datos/Hidrocarburos/Inversion/Secretaria de Energia/resolucin-2057-inversiones-realizadas-fin-de-concesin.csv")
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
inversiones_2005_2012 <- read_excel("C:/Archivos/Datos/Hidrocarburos/Inversion/Secretaria de Energia/tablas dinamicas/inversiones_2005_2012.xlsx", 
    col_types = c("numeric", "text", "text", 
        "numeric", "numeric", "numeric"), 
    skip = 8) %>% 
  rename(plan_1ra_semana = "Plan 1ª Sem.",
         plan_anual = "Plan Anual",
         realizado_anual = "Realizado Anual",
         concepto = Concepto) %>% 
  mutate(anio =  zoo::na.locf(anio),
         empresa =  zoo::na.locf(empresa),
         unidad = "Millones de USD",
         empresa =case_when(empresa == "YPF S.A." ~ "YPF",
                            empresa == "PAN AMERICAN ENERGY (SUCURSAL ARGENTINA) LLC" ~ "PAE",
                            empresa == "PAN AMERICAN ENERGY SL" ~ "PAE",
                            empresa == "PETROBRAS ARGENTINA S.A." ~ "Petrobras",
                            empresa == "PESA (PETROBRAS E.S.A.)" ~ "Petrobras",
                            empresa == "ENAP SIPETROL ARGENTINA S.A." ~ "ENAP SIPETROL",
                            empresa == "VISTA OIL & GAS ARGENTINA SAU" ~ "Vista Oil and Gas",
                            empresa == "VISTA OIL & GAS ARGENTINA SA" ~ "Vista Oil and Gas",
                            empresa == "SINOPEC ARGENTINA EXPLORATION AND PRODUCTION, INC." ~ "Sinopec",
                            empresa == "TECPETROL S.A." ~ "Tecpetrol", 
                            empresa == "PLUSPETROL S.A." ~ "Pluspetrol",
                            empresa == "PLUSPETROL ENERGY S.A." ~ "Pluspetrol",
                            empresa == "COMPAÑÍA GENERAL DE COMBUSTIBLES S.A." ~ "CGC",
                            empresa == "WINTERSHALL ENERGIA S.A." ~ "Wintershall",
                            empresa == "YSUR ENERGÍA ARGENTINA S.R.L." ~ "YSUR",
                            empresa == "YSUR PETROLERA ARGENTINA S.A." ~ "YSUR",
                            empresa == "TOTAL AUSTRAL S.A." ~ "Total Austral",
                            T ~ empresa)) %>% 
  filter(!(empresa %in% c("O&G DEVELOPMENTS LTD S.A." ,"PETROMINERA CHUBUT S.E."))) %>%
  # filter(str_detect(concepto, 'pozo')) %>%
  group_by(empresa, anio, unidad) %>% 
  summarise(inversion_anual = sum(realizado_anual, na.rm = T)) %>% 
  arrange(-inversion_anual)
inversiones_2005_2012



```

```{r echo=FALSE, message=FALSE, warning=FALSE}

graf_inversiones_2005_2012 <-  inversiones_2005_2012 %>%
  ggplot(aes(anio, inversion_anual, color = empresa))+ 
  geom_line()+
  geom_point()+
  labs(title = "Inversiones por empresa (tablas dinamicas)",
       subtitle = "Extraído de tablas dinámicas",
        y = "Millones de USD",
       caption = "Secretaria de Energía")+
  theme(legend.position = "none")
ggplotly(graf_inversiones_2005_2012, width = 800, height = 600)

graf_inversiones_anio_anterior <-  inversiones_anio_anterior %>%
  ggplot(aes(anio, inversion_explotacion, color = empresa))+ 
  geom_line()+
  geom_point()+
  labs(title = "Inversiones por empresa (año anterior)",
       subtitle = "Inversiones año anterior",
        y = "Millones de USD",
       caption = "Secretaria de Energía")+
  theme(legend.position = "none")
ggplotly(graf_inversiones_anio_anterior, width = 700, height = 450)

```


### Análisis de correlación entre Inversión y Pozos

- buscar correlacion, para ver si la serie de inversión se mueve similar a los pozos
- usar stock y ademas usar variacion de stock (bs de uso)

Con pozos de IAPG
```{r echo=FALSE, message=FALSE, warning=FALSE}
# con inversiones realizadas año anterior
inversion_pozos <- pozos_iapg %>% 
  left_join(inversiones_anio_anterior %>%
              ungroup(), by = c("empresa", "anio")) %>% 
  mutate(inversion_por_pozo = inversion_explotacion /total_pozos)

#con inversiones anunciadas
inversion_pozos_2 <- pozos_iapg %>% 
  left_join(inversiones_2005_2012 %>%
              ungroup(), by = c("empresa", "anio")) %>% 
  mutate(inversion_por_pozo = inversion_anual /total_pozos)

#esta mal pq es flujo de pozos vs stock de capital
# kta_pozos <- pozos_iapg %>% 
#   left_join(stock_balances_empresas %>%
#               ungroup() %>% 
#               select(-sector), by = c("empresa", "anio")) %>% 
#   mutate(ppye_por_pozo = prop_plant_equip /total_pozos)


```


```{r echo=FALSE, message=FALSE, warning=FALSE}
graf_inversion_pozo <- inversion_pozos %>% 
  filter( anio >= 2012) %>%
  ggplot(aes(anio,inversion_por_pozo, color = empresa ))+
  geom_line()+
  geom_point()+
  labs(title = "Inversiones año anterior sobre pozos IAPG", 
       y = "Millones de USD")+
  theme_classic()
ggplotly(graf_inversion_pozo, width = 800, height = 600)

graf_inversion_pozo_2 <- inversion_pozos_2 %>% 
  filter( anio <= 2012) %>%
  ggplot(aes(anio,inversion_por_pozo, color = empresa ))+
  geom_line()+
  geom_point()+
  labs(title = "Inversiones realizadas sobre pozos IAPG", 
       y = "Millones de USD")+
  theme_classic()
ggplotly(graf_inversion_pozo_2, width = 800, height = 400)
```

Con pozos Cap IV
```{r echo=FALSE}
# con inversiones realizadas año anterior
inversion_pozos_capiv <- listado_pozos %>%
  rename(anio =anio_terminacion_pozo) %>% 
  left_join(inversiones_anio_anterior %>%
              ungroup(), by = c("empresa", "anio" )) %>%
  mutate(inversion_por_pozo = inversion_explotacion /pozos)

graf_inversion_pozo <- inversion_pozos_capiv %>% 
  filter( anio >= 2012) %>%
  ggplot(aes(anio,inversion_por_pozo, color = empresa ))+
  geom_line()+
  geom_point()+
  labs(title = "Inversiones año anterior sobre pozos Capitulo IV", 
       y = "Millones de USD")+
  theme_classic()+
  theme(legend.position = "none")
ggplotly(graf_inversion_pozo, width = 700, height = 400)


```

## Regalías

* Fuentes: 
  + Secretaría de Energía (Base Regalías)


REVISAR EL CALCULO DE BETANIA 
cuanto ganarian las provincias si el precio del mercado interno se acomoda al internacional?

```{r echo=FALSE, message=FALSE, warning=FALSE}
#regalias
#filtro con productos
productos <- list("crudo", "gas", "gasolina", "glp")

#loop para levantar las bases
lista_regalias = list()
for(i in productos){
  regalias_i <- read_delim(paste0("C:/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/regalias_", i, ".csv"), 
    ";", escape_double = FALSE, trim_ws = TRUE, 
    skip = 1)
  lista_regalias[[i]] <- regalias_i
}

#bases individuales
regalias_crudo <- lista_regalias$crudo %>% 
  mutate(moneda = "USD",
         producto = "crudo")
regalias_gas <- lista_regalias$gas %>% 
  mutate(moneda = "ars",
         producto = "gas")
regalias_gasolina <- lista_regalias$gasolina %>% 
  mutate(moneda = "USD",
         producto = "gasolina")
regalias_glp <- lista_regalias$glp %>% 
  mutate(moneda = "ars",
         producto = "glp")

#base completa
regalias <-  regalias_crudo %>% 
  bind_rows(regalias_gas, regalias_gasolina, regalias_glp) %>% 
  rename(anio = "AÑO",
         mes = "MES", 
         regalias_total = "TOTAL PROVINCIA") %>% 
  mutate(fecha = as.Date(parse_date_time(paste0(anio, mes), orders = "ym"))) %>% 
  select(fecha, anio, mes, producto, moneda, regalias_total, everything(.)) %>% 
  group_by(producto, anio, moneda ) %>% 
  summarise(regalias_total = sum(regalias_total)) %>% 
  left_join(tcp_anual %>% select(-TCP)) %>% 
  mutate(regalias_total = case_when(moneda == "USD" ~ regalias_total * TCC,
                                    T ~ regalias_total),
         unidad = "ars") %>% 
  select(-c(TCC, moneda))

regalias

regalias_usd <- regalias %>% 
  left_join(tcp_anual_b %>% select(anio, tcc)) %>% 
  mutate(regalias = regalias_total /tcc, 
         unidad = "USD") %>% 
  select(-c(regalias_total, tcc))

```

## Subsidios
```{r}
# CEFIP cont et al. Subsidios como % del PBI
subsidios_cefip <- read_excel("/Archivos/Datos/Hidrocarburos/subsidios/subsidios.xlsx") %>% 
  gather(key = anio,
         value = subsidios_porcentaje_pbi,
         2:ncol(.)) %>% 
  filter(sector %in% c("CAMMESA", "Plan Gas","ENARSA", "Subsidios FF GN y GLP")) %>% 
  mutate(anio = as.double(anio)) %>% 
  left_join(ganancia_y_pbi %>% 
              select(anio, pbi)) %>%
  mutate(subsidios_porcentaje_pbi=as.double(subsidios_porcentaje_pbi),
         subsidios_cefip = subsidios_porcentaje_pbi * pbi * 10^6) %>% 
  group_by(anio) %>% 
  summarise(unidad = "Pesos corrientes",
            subsidios_cefip=sum(subsidios_cefip, na.rm = T))

#ejes 
subsidios_ejes <- read_excel("/Archivos/Datos/Hidrocarburos/Estimacion propia/subsidios.xlsx" ) %>% 
  rename(subsidios_usd = subsidios_hidrocarburos) %>% 
  right_join(tcp_anual_b %>% 
               select(anio, tcc), by = "anio") %>%
  group_by(anio) %>% 
  summarise(unidad = "Pesos corrientes",
         subsidios_ejes = subsidios_usd*tcc*10^6)

subsidios_hidrocarburos <- subsidios_ejes%>% 
  select(anio, unidad, subsidios_ejes) %>% 
  full_join(subsidios_cefip, by =c("anio", "unidad")) %>% 
  arrange(-anio) %>% 
  mutate(unidad = "Pesos corrientes")
         # x = subsidios_cefip/subsidios_ejes)
subsidios_hidrocarburos  
```



# Valor total de la producción  


## Criterios metodológicos 
Se presentan a continuación distintas estimaciones sobre la magnitud de riqueza presente en el sector hidrocarburífero: Valor Bruto y Agregado de Producción (VBP y VA), Consumo Interemedio (CI), Masa Salarial (MS) y Excedente Bruto de Explotación (EBE). El VBP surge de la valuación de la producción a sus precios correspondientes. El VA resulta de la diferencia entre el VBP y CI, el cual puede surgir originalmente de esta resta o a partir del coeficiente técnico de la Matriz Insumo Producto (MIP). El EBE constituye la plusvalía (PV) total de la rama, es decir, la suma de la renta de la tierra (RT) más la ganancia normal (Gnorm), y se obtiene luego de descontar la MS y los impuestos específicos (Imp) del VA. En todos los casos que se presentarán a continuación, los Imp se calcularon a partir de aplicar sobre el VBP un coeficiente  resultante del peso de los impuestos promedio de la  MIP de 1997. Lo mismo pasa con la estimación de la depreciación de capital o consumo de capital fijo (ConsKfijo), que se obtiene a partir de aplicar la tasa de depreciación promedio resultante de los balances de YPF (1998 - 2018) sobre el total de Propiedad, Planta y Equipo (PPyE) de la rama. Esta partida se aplica para obtener el Excedente Neto de Explotación. Se presentan distintas estimaciones para el VBP, CI y MS, que luego se observarán en la formulación matemática:



* CCNN (*ccnn_oficial*)
  + Valores contables oficiales de las Cuentas Nacionales (sólo disponible para el período 2004-2012). Dado que se presentan series de VBP y VA, se pudo estimar el CI como la diferencia de dichas cuentas. Se procedió a separar el VBP a partir del peso del VBP de los servicios de apoyo a la extracción sobre el VBP de extracción de petróleo y gas, presente en el Cuadro de Utilización de Oferta (COU) de 2004 de INDEC. Se descontó esta proporción (resultante del 10,7%) del VBP total para obtener un VBP sólo de extracción. Dado que se posee información del salario promedio del sector y el empleo, se pudo obtener la MS resultante, tanto para el total del sector (extracción y servicios relacionados) como para sólo extracción. A partir de estos datos se elaboró un coeficiente que refleja el promedio de la proporción de la MS sobre el VBP que se utilizará en cálculos posteriores de MS total y MS de extracción. 

* Estimación propia con criterio CCNN (*vbp_va_ci_propia*)
  + Estimación propia de los valores contables a partir de las fuentes recopiladas, siguiendo los criterios de las Cuentas Nacionales. Es decir, para obtener el VBP se valua la producción destinada al mercado interno (resultante a partir de la diferencia entre producción y exportaciones) con los precios internos y las exportaciones con los precios de exportación, valuados tipo de cambio comercial (TCC). Se procedió también a separar el VBP de extracción neto de los servicios tal como se explicó anteriormente. El CI se estimó a partir de aplicar el coeficiente técnico (ratio CI/VBP) resultante de la MIP de 1997 (equivalente a 0.272). De igual manera, para calcular la masa salarial se aplicó el coeficiente de MS mencionado anteriormente. Finalmente, como se mencionó anteriormente, el VA el EBE se calcularon a partir de las diferencias mencionadas anteriormente. 

* Empalme CCNN (*vbp_ccnn*)
  + Estimación que toma los valores oficiales de las cuentas nacionales para el período donde se presentan datos (2004 -2012) y que imputa los valores faltantes por medio de la evolución del índice del VBP propio con criterio CCNN explicado anteriormente. Asimismo, se utilizaron los valores oficiales de la MS cuando se encontraba disponible el dato (1996-2018), mientras que se utilizó el valor propio estimado con criterio de las CCNN para los restantes años. 
  
* Criterio Propio (*pv_hidrocarburos_propia*)
  + Estimación propia que refleja con mayor precisión el valor de la riqueza total presente en el sector. El VBP se obtiene a paritr de valuar la totalidad de la producción a los precios externos o de referencia internacional y con el tipo de cambio de paridad (TCP), que mide la capacidad real de compra de la moneda nacional. Sin embargo, como el CI constituye intercambios de mercancías realizadas en el ámbito nacional, dicha partida se obtiene a partir de los valores obtenidos en la serie de empalme CCNN. De igual manera, se utilizó la MS resultante de esta última estimación. 




## Formulación matemática de estimaciones

Valor Bruto de Producción total, estimación con criterio propio
$$VBP_{propia} = (Pext_{petróleo} * Q_{petróleo} + Pext_{gas} * Q_{gas}) * TCP$$

Donde: 

* $VBP_{propia}$ = Valor Bruto de la Producción total, estimación propia
* $Pext_{petróleo}$ = Precio de exportación o referencia internacional del petróleo crudo (según corresponda)
* $Pext_{gas}$ = Precio de exportación o referencia internacional del gas natural (según corresponda)
* $Q_{petróleo}$ = Cantidades producidas totales de petróleo crudo
* $Q_{gas}$ = Cantidades producidas totales de gas natural
* $TCP$ = Tipo de Cambio de Paridad


Valor Bruto de Producción total, estimación con criterio CCNN
$$VBP_{CCNN} = (Pint_{petróleo} * QMInt_{petróleo} + Pext_{petróleo} * Expo_{petróleo} + Pint_{gas} * QMInt_{gas} + Pext_{gas} * Expo_{gas})* TCC$$

Donde:

* $VBP_{CCNN}$ = Valor Bruto de la Producción total,  estimación propia con criterio de las CCNN
* $Pint_{petróleo}$ = Precio mercado interno del petróleo crudo
* $Pint_{gas}$ = Precio mercado interno del gas natural
* $QMInt_{petróleo}$ = cantidades vendidas al mercado interno de petróleo crudo
* $QMInt_{gas}$ = cantidades vendidas al mercado interno del gas natural
* $Expo_{petróleo}$ = exportaciones de petróleo crudo
* $Expo_{gas}$ = exportaciones de gas natural
* $TCC$ = Tipo de Cambio Comercial


<br>

Valor Bruto de Producción extracción, estimación con criterio CCNN

$$VBP\_extr_{CCNN} = VBP_{CCNN} * (1-prop\_servicios)$$

Donde:

* $VBP\_extr_{CCNN}$ = Valor Bruto de la Producción extracción,  estimación propia con criterio de las CCNN
* $prop\_extr$ = proporción del VBP de servicios de apoyo sobre VBP de extracción de petróleo y gas


Proporción de los servicios de apoyo sobre la extracción de petróleo y gas
<br>
$$prop\_servicios = \frac{VBP\_servicios_{COU}}{VBP\_extr_{COU} + VBP\_servicios_{COU}}$$

Donde:

* $VBP\_servicios_{COU}$ = VBP de servicios de apoyo del Cuadro de Utilización de Oferta
* $VBP\_extracción_{COU}$ = VBP de extracción de petróleo y gas del Cuadro de Utilización de Oferta



<br>
Consumo Intermedio, valores oficiales de las CCNN
$$ CI_{CCNN} = VBP_{CCNN} -  VA_{CCNN} $$

Donde:

* $CI_{CCNN}$ = Consumo Intermedio total, estimación propia
* $VA_{CCNN}$ = Valor Agregado, estimación de las CCNN 

<br>
Consumo Intermedio, estimación con criterio CCNN
$$ CI_{CCNN} = VBP_{CCNN} *  Coef\_tec $$
Donde:

* $Coef\_tec$ = Coeficiente técnico de Matriz Insumo Producto

<br>
Consumo Intermedio de extracción, estimación con criterio CCNN

$$ CI\_extr_{CCNN} = VBP\_extr_{CCNN} *  Coef\_tec $$

Donde:

* $ CI\_extr_{CCNN}$ = Consumo Intermedio de extracción, estimación criterio CCNN

<br>
Masa Salarial, valores oficiales de las CCNN
$$MS = W * Emp * 13$$
Donde: 

* $MS$ = Masa Salarial 
* $W$ =  Salario anual promedio
* $Emp$ = Empleo

<br>
Masa Salarial, estimación con criterio CCNN
$$MS =  VBP_{CCNN} *  Coef\_MS$$

Donde: 

* $Coef\_MS$ = Coeficiente de la proporción de MS sobre VBP

<br>
Masa Salarial de extracción, estimación con criterio CCNN
$$MS\_extr =  VBP\_extr_{CCNN} *  Coef\_MS$$

Donde: 

  * $MS\_extr$ = Masa salarial del sector extracción

<br>
Valor agregado, estimación criterio CCNN
$$VA_{CCNN}  = VBP_{CCNN} – CI_{CCNN} $$
Donde:

* $VA_{CCNN}$ = Valor Agregado, estimación propia con criterio CCNN

<br>
Valor agregado de extracción, estimación con criterio CCNN
$$VA\_extr_{CCNN}  = VBP\_extr_{CCNN} – CI\_extr_{CCNN} $$

Donde:

* $VA\_extr_{CCNN}$ = Valor Agregado de extracción, estimación propia con criterio CCNN 


<br>
Valor agregado, estimación con criterio propio
$$VA_{propia}  = VBP_{propia} – CI\_extr_{CCNN} $$

Donde:

* $VA_{propia}$ = Valor Agregado, estimación con criterio propio 


<br>

Excedente Bruto de Explotación, estimación con criterio CCNN
$$EBE_{CCNN}  = VA_{CCNN} – MS   $$
<br>

Excedente Bruto de Explotación de extracción, estimación con criterio CCNN
$$EBE\_extr_{CCNN}  = VA\_extr_{CCNN} – MS\_extr   $$

<br>

Excedente Bruto de Explotación, estimación con criterio propio
$$EBE_{propia}  = VA_{propia} – MS\_extr   $$


Donde:

* $EBE$ = Excedente Bruto de Explotación
* $CI\_extr_{CCNN}$ = Consumo intermedio del sector extracción, estimación con criterio CCNN


<br>
Consumo de Capital Fijo, estimación con criterio propio
$$ConKfijo = PPyE *  prom(\frac{Dep}{PPyE}) $$

Donde: 

* $ConKfijo$ = Consumo de Capital Fijo
* $PPyE$= Propiedad, Planta y Equipo neta
* $prom(\frac{Dep}{PPyE}) $ =  tasa de depreciación promedio
* $Dep$ = Depreciaciones (cuenta gastos por naturaleza)

<br>

Plusvalía (Excedente Neto de Explotación), estimación con criterio propio
$$PV_{propia} = VA_{propia} - ConKfijo - Imp $$


Donde:

* $PV_{propia}$ = Plusvalía (*Excedente Neto de Explotación*)
* $Imp$ = Impuestos normales



## Fuentes para la construcción de series 

* Producción de Crudo: 
  + 1911 a 1992: Anuario de combustibles 
  + 1993 - actualidad: SESCO Downstream
  
* Exportaciones de Crudo: 
  + 1962 a 1993: UN Comtrade (clasificación SITC as reported)
  + 1994 en adelante: SESCO Downstream
  + Los datos faltantes de SESCO se completaron con MECON
  + Siguen habiendo datos faltantes para los años 1965, 1970-74, 1976-78, 1980-84
  
* Precio Mercado Interno de Crudo: 
  + 1963 a 1965: Kozulj y Pistonesi - Revista IDEE ajustado con el índice del precio del Anuario de YPF 
  + 1989 a 1991: Anuario de YPF
  + 1966 a 1988: Kozulj y Pistonesi - Revista IDEE
  + 1992: MECON ajustado con la variación del Índice de precios internos al por mayor (IPIM)
  + 1993 en adelante: MECON 
  
* Precio Mercado Externo Crudo:
  + entre 1962 y 1992: precio de exportación argentina de UN Comtrade
  + entre 1993-2001 y 2004-2014: precio de exportación argentina de Mecon
  + entre 2002 y 2003: precio de exportación de Argentina de UN Comtrade (Clasificación HS as reported)  
  + 2014 en adelante: precio de exportación argentina de Secretaría de Energía (Regalías)
  + Valores faltantes previos a 1992: Brent  (Fuente: Inflation Data)
  
* Producción de Gas:
  + 1911 a 1992: Anuario de combustibles 
  + 1993 en adelante: SESCO Downstream
  
* Exportaciones de gas: 
  + 1962 a 1996: UN Comtrade,
  + 1997 en adelante: SESCO Downstream
  + Datos faltantes para los años 1999 y 2000
  
* Precio Mercado Interno de gas:
  + 1963 - 1969 & 1989 - 1992: Anuario de YPF
  + 1970 - 1988:  Kozulj y Pistonesi - Revista IDEE
  + 1993 en adelante: Secretaría de Energía - Base Regalías
  + El dato del año 1992 se dividió por 10, dado que resultaba excesivamente alto, lo cual es metodológicamente inaceptable pero sirve de ejercicio. 
  
* Precio Mercado Externo:
  + Años 1964 y 1965: Precio de importación de gas proveniente de Bolivia hacia Argentina de UN Comtrade
  + 1966 en adelante: Precio de exportacion de gas desde Bolivia a Argentina de UN Comtrade
  + Datos faltantes para los años previos a 1963 y período 1968-1971 

* Valor Bruto de la Producción, Valor Agregado y Consumo Intermedio:
  + INDEC - Dirección Nacional de Cuentas Nacionales (Base Minería e Hidrocarburos de las Cuentas Nacionales). Las variables "extraccion_y_servicios_hidrocarburos" refieren a "Extracción de petróleo crudo y gas natural. Actividades de servicios relacionadas con la extracción de petróleo y gas, excepto las actividades de prospección"
  + Cálculo propio del VBP con datos datos de producción y precio internacional recopilados. Las fuentes son las siguientes (los criterios son los mismos para la utilización posterior en el cálculo de renta de la tierra hidrocarburífera por diferencial de precios, sobrevaluación cambiaria y otros mecanismos)

* Salario y empleo
  + 1960-1996: estimación a partir de aplicación del coeficiente de proporción de la masa salarial sobre el VBP
  + 1996 en adelante: Ministerio de Trabajo, Empleo y Seguridad Social - Observatorio de Empleo y Dinámica Empresarial (OEDE)

* Consumo de capital fijo
  + Coeficiente de depreciación estimado a partir de Estados Contables de YPF (1998-2018)
<br>



### Cuentas Nacionales

[Producto Interno Bruto Explotación Minas y Canteras Millones de pesos constantes. Base 1960. Valores trimestrales
PIB Explotación Minas y Canteras en millones de pesos de 1960. 1970-1980](https://datos.gob.ar/dataset/sspm-producto-interno-bruto-sectorial-1970-1980)


[Producto Interno Bruto Explotación Minas y Canteras, Australes constantes. Base 1970.Valores trimestrales
PIB Explotación Minas y Canteras en australes a precios de 1970. 1980-1990](https://datos.gob.ar/dataset/sspm-producto-interno-bruto-sectorial-1980-1990) 

```{r message=FALSE, warning=FALSE, include=FALSE}
#MIP 97
# coeficientes de requerimientos directos

mip_97 <- read_excel("C:/Archivos/Datos/MIP/mip_matriz12.xls", 
    skip = 7) %>% 
  select(-"...1") %>% 
  rename(actividad = "...2")
  # filter("...2" %in% c( "Usos de la producción nacional a precios básicos",  "Valor bruto de la producción a precios básicos" ))

ci_extraccion <- mip_97[c(126,149), c("actividad" , "Extracción de petróleo, gas, carbón y uranio")]

coef_tecnico_97 <- ci_extraccion[1,2]/ci_extraccion[2,2]

x <- mip_97[c(140, 149),] #%>% 
   # gather(key = sector, value = valor, 2:ncol(.)) %>% 

imp_prom_97 <- apply(X = x[1,2:ncol(x)]/x[2,2:ncol(x)] , MARGIN = 1 , FUN = function(x) mean(x, na.rm=T)  )
    

# coef CUO 2004 a partir de CI/VBP
# coef_tecnico <-  0.369104302


#Peso de los servicios
#CUO 
#la suma de las columnas nos da el VBP
COU <- read_excel("C:/Archivos/Datos/MIP/sh_cou_06_16.xls", 
    skip = 2) %>%
  rename(producto = "...1",
         cpc = "...2") %>% 
  filter(str_detect(producto, "\\d") & !(str_detect(producto, "^N"))) %>%
  group_by(producto) %>% 
  mutate_all(as.double)

servicio_s_extraccion <-  sum(COU[12])/( sum(COU[11]) + sum(COU[12]) )
nrow(COU)


# Depreciación del stock
consumo_k_fijo_ypf <- (read_csv("C:/Archivos/Datos/Balances/gas y petroleo_datos/datos_r/resultados/balances_arg.csv", 
    col_types = cols(X1 = col_skip())) %>%
  filter(empresa == "YPF") %>% 
  group_by(empresa) %>% 
  mutate(tasa_depreciacion = depreciaciones/ppye) %>% 
  summarise(tasa_depreciacion = mean(depreciaciones/ppye)))$tasa_depreciacion

var((read_csv("C:/Archivos/Datos/Balances/gas y petroleo_datos/datos_r/resultados/balances_arg.csv", 
    col_types = cols(X1 = col_skip())) %>%
  filter(empresa == "YPF") %>% 
  group_by(fecha) %>%
  summarise(tasa_depreciacion = mean(depreciaciones/ppye)))$tasa_depreciacion)



```




```{r echo=FALSE, message=FALSE, warning=FALSE}
#CCNN (datos oficiales)
## Base minería
ccnn_oficial <- read_excel("C:/Archivos/Datos/Hidrocarburos/Mecon/base-mineria-e-hidrocarburos cuentas nacionales.xls", sheet = "Cuentas Nacionales", skip = 5) %>% 
  rename(anio = "Año",
         periodo ="Período",
        vbp_extraccion_y_servicios_hidrocarburos =  "...5",
        va_extraccion_y_servicios_hidrocarburos =  "...15") %>% 
  filter(is.na(periodo), !is.na(anio) ) %>%  #filtramos los datos anuales
  mutate(unidad = "Miles de pesos corrientes",
         vbp_extraccion_y_servicios_hidrocarburos= as.double(vbp_extraccion_y_servicios_hidrocarburos),
         va_extraccion_y_servicios_hidrocarburos= as.double(va_extraccion_y_servicios_hidrocarburos),
         vbp_extraccion_hidrocarburos = vbp_extraccion_y_servicios_hidrocarburos * (1 - servicio_s_extraccion),
         va_extraccion_hidrocarburos = va_extraccion_y_servicios_hidrocarburos * (1 - servicio_s_extraccion),
         ci_extraccion_y_servicios_hidrocarburos=
           vbp_extraccion_y_servicios_hidrocarburos-va_extraccion_y_servicios_hidrocarburos,
         ci_extraccion_hidrocarburos = vbp_extraccion_hidrocarburos - va_extraccion_hidrocarburos) %>% 
  select(anio, unidad,
         vbp_extraccion_y_servicios_hidrocarburos , 
         va_extraccion_y_servicios_hidrocarburos,
         ci_extraccion_y_servicios_hidrocarburos,
         vbp_extraccion_hidrocarburos , 
         va_extraccion_hidrocarburos,
         ci_extraccion_hidrocarburos) %>% 
  group_by(anio, unidad) %>%
  mutate_all(function(x) {x/10^3}) %>%
  ungroup() %>% 
  mutate(unidad = "Millones de pesos corrientes") %>% 
  left_join(masa_salarial_hidrocarburos %>% 
              select(anio,  unidad,
                     ms_tot = masa_salarial_total_oede,
                     ms_extr =masa_salarial_extraccion_oede ), by = c("anio", "unidad")) %>% 
  mutate(ebe_tot = va_extraccion_y_servicios_hidrocarburos - ms_tot,
         ebe_extr = va_extraccion_hidrocarburos -ms_extr,
         fuente = "CCNN oficial" ) %>% 
  rename(vbp_extr = vbp_extraccion_hidrocarburos,
         ci_extr = ci_extraccion_hidrocarburos,
         va_extr =va_extraccion_hidrocarburos,
         vbp_tot= vbp_extraccion_y_servicios_hidrocarburos , 
         va_tot= va_extraccion_y_servicios_hidrocarburos,
         ci_tot = ci_extraccion_y_servicios_hidrocarburos) %>% 
  ungroup()
ccnn_oficial

mean_coef_ms <-  ccnn_oficial %>% 
  summarise(coef_ms_tot = mean(ms_tot/vbp_tot,na.rm= T),
              coef_ms_extr= mean(ms_extr/vbp_extr ,na.rm= T))

median_coef_ms <-  ccnn_oficial %>% 
  summarise(coef_ms_tot = median(ms_tot/vbp_tot,na.rm= T),
              coef_ms_extr= median(ms_extr/vbp_extr ,na.rm= T))

# # estimacion propia coef tecnico
# ccnn_oficial %>% 
#   summarise(coef_req_extr_y_serv =mean(ci_extr_y_servicios_hidrocarburos/vbp_extr_y_servicios_hidrocarburos, na.rm=T),
#          coef_req_extr = mean(ci_extr_hidrocarburos/vbp_extr_hidrocarburos, na.rm=T))


# Base INDEC
x <- read_excel("../data/indec/sh_VBP_VAB_03_21.xls", sheet = 3, skip = 3) %>% 
  na.omit() 
names(x) <-c("sector", 2004:2020)
vbp_ccnn <- x %>% 
  gather(key = anio,value = vbp_tot , 2:ncol(.))

y <- read_excel("../data/indec/sh_VBP_VAB_03_21.xls", sheet = 5, skip = 4) %>% 
  select(1, contains("Total")) %>% 
  na.omit() 
names(y) <-c("sector", 2004:2020)
va_ccnn <- y %>% 
  gather(key = anio,value = va_tot , 2:ncol(.))

ccnn_oficial <- va_ccnn %>% 
  filter(grepl("Extracción de petróleo", sector)) %>% 
  inner_join(vbp_ccnn %>% filter(grepl("Extracción de petróleo", sector)), by = c("sector", "anio")) %>% 
  mutate(anio = as.double(anio)) %>% 
  left_join(masa_salarial_hidrocarburos %>% 
              select(anio,  unidad,
                     ms_tot = masa_salarial_total_oede,
                     ms_extr =masa_salarial_extraccion_oede ), by = c("anio")) %>% 
  mutate(vbp_extr = vbp_tot* (1 - servicio_s_extraccion),
         va_extr = va_tot* (1 - servicio_s_extraccion),
         ci_tot = vbp_tot - va_tot,
         ci_extr = vbp_extr  - va_extr,
         ebe_tot =va_tot-ms_tot,
         ebe_extr = va_extr -ms_extr,
         unidad = "Millones de pesos corrientes",
          fuente = "CCNN oficial" ) %>% 
  select(anio, unidad, fuente, everything(.), -sector)

## VA y VBP precios 93
x <- read_excel("C:/Archivos/repos/hidrocarburos/analisis/data/mecon/PBI_Base 1993_PM.xlsx", 
    sheet = "VBP c", col_types = c("text", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric"), skip = 6) %>% 
    select(1, !contains("I"))
names(x) <- c("sector", 1993:2009)
vbp_93 <- x %>% 
  gather(key = anio,value = vbp_tot , 2:ncol(.))

y <- read_excel("C:/Archivos/repos/hidrocarburos/analisis/data/mecon/PBI_Base 1993_PM.xlsx", 
    sheet = "VAB c", skip = 6) %>% 
    select(1, !contains("I"))
names(y) <- c("sector", 1993:2009)
va_93 <- y %>% 
  gather(key = anio,value = va_tot , 2:ncol(.))

valor_produccion_93 <- va_93 %>%  inner_join(vbp_93) %>% 
  mutate(anio = as.double(anio))

consumo_intermedio_93 <- valor_produccion_93 %>% 
  filter(grepl("C - EXPLOTACION DE MINAS Y CANTERAS", sector)) %>% 
  mutate(coef_tec_93 = 1-(va_tot/vbp_tot), 
           coef_tec_93_index = generar_indice(coef_tec_93, fecha = anio, fecha_base = 2004))
  
## Serie de CI
# < 1997 : MIP 97
# 97 a 2004 : progresion de mip97 a indec
# 2004 a 2019: indec
coef_consumo_intermedio <- data.frame(anio = 1960:2020) %>%
  left_join(ccnn_oficial %>%  select(anio, vbp_tot, va_tot), by = "anio") %>% 
  left_join(consumo_intermedio_93 %>% select(anio, coef_tec_93_index)) %>% 
  mutate(coef_ci = 1-(va_tot/vbp_tot))
ci_base = coef_consumo_intermedio$coef_ci[coef_consumo_intermedio$anio ==2004]

coef_consumo_intermedio <- coef_consumo_intermedio %>% 
  mutate(coef_ci = case_when( anio <= 2004 ~ coef_tec_93_index * ci_base,
                              T ~ coef_ci)) %>% 
         # coef_ci = imputeTS::na.interpolation(coef_ci, option = "linear" )) %>% 
  select(anio, coef_ci)
coef_consumo_intermedio
```

### Estimaciones propias 

```{r echo=FALSE, message=FALSE, warning=FALSE}
#variables para la estimación 
precios_y_cantidades <- prod_merge_crudo %>% 
  select(anio, unidad_cant_crudo = unidad, prod_crudo) %>%
  left_join(expo_q_crudo %>% 
              select(anio, unidad_cant_crudo =unidad, expo_crudo)) %>% 
  left_join(existencias_petroleo %>% 
              select(anio, unidad_cant_crudo = unidad, existencias_crudo)) %>% 
  replace_na(list(existencias_crudo=0 )) %>% 
  replace_na(list(expo_crudo=0 )) %>% 
  left_join(precio_mi_crudo %>% 
              select(anio, unidad_precio_crudo = unidad, precio_crudo_mdoint), by = "anio") %>% 
  left_join(precios_referencia_y_expo_crudo %>% 
              select(anio, unidad_precio_crudo = unidad, precio_me_crudo), by = c("anio", "unidad_precio_crudo")) %>% 
  left_join(prod_merge_gas_MMBTU %>% 
              select(anio, unidad_cant_gas= unidad,prod_gas), by = "anio") %>%
  left_join(expo_q_gas_MMBTU %>% select(anio, unidad_cant_gas= unidad, expo_gas)) %>% 
  left_join(precio_mdomundial_gas_MMBTU %>% 
              select(anio, unidad_precio_gas = unidad, precio_externo_gas, precio_exportacion_gas_ar), by = "anio") %>% 
  left_join(precio_interno_gas_mmbtu_usd %>% 
              select(anio,  precio_gas_mdoint)) %>% 
  left_join(tcp_anual_b %>% 
              select(anio, tcp, tcc), by = "anio")

# writexl::write_xlsx(precios_y_cantidades, path = "resultados/argentina/insumos_criterio_ccnn.xlsx")

## Criterio CCNN 
criterio_ccnn <- precios_y_cantidades %>% 
  left_join(coef_consumo_intermedio, by ="anio") %>% 
  mutate(crudo_mdo_interno = prod_crudo - expo_crudo,
         expo_gas = replace_na(expo_gas, 0 ),
         gas_mdo_interno = prod_gas - expo_gas,
         unidad = "Millones de pesos corrientes",
         
        # criterio CCNN
         vbp_tot = ((crudo_mdo_interno*precio_crudo_mdoint+
                                 expo_crudo*precio_me_crudo
                               + gas_mdo_interno * precio_gas_mdoint 
                               +expo_gas*precio_exportacion_gas_ar )*tcc)/10^6,
         vbp_extr =vbp_tot*(1-servicio_s_extraccion),
         ci_tot = vbp_tot *coef_ci ,
         ci_extr = vbp_extr * coef_ci,
        va_tot=   vbp_tot - ci_tot,
        va_extr=   vbp_extr - ci_extr,
        ms_extr = vbp_extr * mean_coef_ms$coef_ms_extr,
         ms_tot = vbp_tot * mean_coef_ms$coef_ms_tot,
         ebe_tot = va_tot - ms_tot,
         ebe_extr=va_extr - ms_tot  ,
        fuente = "Criterio CCNN")
criterio_ccnn


# Empalme CCNN
indice_vbp_criterio_ccnn <- criterio_ccnn %>% 
  ungroup() %>% 
  mutate(vbp_criterio_ccnn_04 = generar_indice(vbp_tot,
                                               fecha = anio,
                                               fecha_base = 2004) ) %>% # ,
         # vbp_criterio_ccnn_12 = generar_indice(vbp_tot,
         #                                       fecha = anio,
         #                                       fecha_base = 2012)) %>% 
  select(anio, vbp_criterio_ccnn_04)

empalme_ccnn <- ccnn_oficial %>% 
  full_join(coef_consumo_intermedio, by = "anio") %>% 
  full_join(indice_vbp_criterio_ccnn, by = "anio") %>% 
  arrange(anio) %>% 
  mutate(vbp_extr = case_when(anio < 2004 ~ ccnn_oficial$vbp_extr[ccnn_oficial$anio == 2004] * vbp_criterio_ccnn_04,
                                    T ~ vbp_extr) ,
    vbp_tot = case_when( anio < 2004 ~ ccnn_oficial$vbp_tot[ccnn_oficial$anio == 2004] * vbp_criterio_ccnn_04,
                           T ~ vbp_tot),
    ci_extr = vbp_extr * coef_ci ,
    ci_tot = vbp_tot *coef_ci   ,
    va_tot = case_when(is.na(va_tot) ~ vbp_tot - ci_tot ,
                                   T ~ va_tot),
    va_extr = case_when(is.na(va_extr) ~ vbp_extr - ci_extr ,
                                   T ~ va_extr),
    ms_tot = case_when(is.na(ms_tot) ~ vbp_tot*mean_coef_ms$coef_ms_tot,
                                   T ~ ms_tot) ,
    ms_extr = case_when(is.na(ms_extr) ~ vbp_tot*mean_coef_ms$coef_ms_extr,
                                   T ~ ms_extr), 
    ebe_tot = case_when(is.na(ebe_tot) ~ va_tot -ms_tot,
                                   T ~ ebe_tot),
    ebe_extr = case_when(is.na(ebe_extr) ~ va_extr -ms_extr,
                                   T ~ ebe_extr),
    fuente = "Empalme CCNN",
    unidad = "Millones de pesos corrientes") %>% 
   left_join(stock_estimado %>%
               left_join(ipc_promedio %>% select(anio, ipc_18)) %>%
              filter(fuente_ppye == "Bolsar") %>%
              mutate(consumo_k_fijo = valor * ipc_18 * consumo_k_fijo_ypf) %>% 
               select(anio, consumo_k_fijo)) %>%
  mutate( pv = ebe_extr - consumo_k_fijo - (vbp_tot * imp_prom_97))
  

## Criterio propio 
criterio_propio <- precios_y_cantidades %>%
  left_join(empalme_ccnn %>% 
              select(anio,unidad, ci_tot, ci_extr, ms_tot, ms_extr ) ) %>% 
  left_join(stock_estimado %>%
               left_join(ipc_promedio %>% select(anio, ipc_18)) %>%
              # filter(variable == "ppye_estimado_bolsar") %>% 
                            filter(fuente_ppye == "Bolsar") %>% 
              mutate(consumo_k_fijo = valor * ipc_18 * consumo_k_fijo_ypf) %>% 
               select(anio, consumo_k_fijo)) %>% 
  mutate(
        # criterio propio
         vbp_tot =( (prod_crudo*precio_me_crudo  + prod_gas * precio_externo_gas) * tcp)/10^6,
         va_tot = vbp_tot - ci_extr,
         ebe_tot = va_tot - ms_extr ,
         vbp_extr =  NA ,
         ebe_extr =NA,
         va_extr=NA, 
         fuente = "Criterio propio", unidad ="Millones de pesos corrientes" ,
          pv = ebe_tot - consumo_k_fijo - (vbp_tot * imp_prom_97))

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
filtro <- c("anio", "unidad", "fuente", "vbp_tot", "vbp_extr",
            "ci_tot", "ci_extr",  "ms_tot", "ms_extr",
            "va_tot",  "va_extr" , "ebe_tot", "ebe_extr"  )

valor_total_produccion_corr <- ccnn_oficial %>% 
  select(filtro) %>% 
  # rbind(criterio_ccnn %>%select(filtro)) %>% 
  rbind(empalme_ccnn %>% select(filtro)) %>% 
  rbind(criterio_propio %>% select(filtro)) %>% 
  gather(key = variable, value=valor, 4:12) 

valor_total_produccion <-  valor_total_produccion_corr %>% 
  left_join(ipc_promedio %>% select(anio, ipc_18)) %>%
  mutate(valor = valor /ipc_18,
         unidad = "Millones de pesos de 2018")


  

graf_valor_produccion <- valor_total_produccion %>% 
  filter(anio > 1960) %>% 
  ggplot( aes(anio, valor, color = fuente))+
  geom_line(alpha = 0.7)+
  geom_point(size = 0.435, alpha = 0.2)+
  theme_classic()+
  theme(legend.position = "bottom")+
  labs(title = "Valor de la Producción hidrocarburífera", 
       subtitle = "Valor total y componentes",
       y = "Millones de pesos de 2018")+
  facet_wrap(~variable)
gp <- ggplotly(graf_valor_produccion, width = 750, height = 800)  
gp[['x']][['layout']][['annotations']][[2]][['x']] <- -0.11
gp %>% layout(margin = list(l = 75))


```




# Tasa de Ganancia


$$TG_{hidrocarburos} = \frac{PV_{hidrocarburífera}}{KTA_{hidrocarburífero}}$$


```{r message=FALSE, warning=FALSE, include=FALSE}
#levanto data sets de otro R markdown
balances_arg <- read_csv("C:/Archivos/Datos/Balances/gas y petroleo_datos/datos_r/resultados/balances_arg.csv", 
    col_types = cols(fecha = col_date(format = "%Y-%m-%d"), X1 = col_skip()))

petrobras_arg_segmentos <- read_csv("C:/Archivos/Datos/Balances/gas y petroleo_datos/datos_r/resultados/petrobras_arg_segmentos.csv", 
    col_types = cols(X1 = col_skip()))

ypf_segmentos <- read_csv("C:/Archivos/Datos/Balances/gas y petroleo_datos/datos_r/resultados/ypf_segmentos.csv", 
    col_types = cols(X1 = col_skip()))

```

## Por empresa
```{r echo=FALSE, message=FALSE, warning=FALSE}
graf_tg_emp <- balances_arg %>%
  filter(tg_ant != Inf) %>% 
  ggplot(aes(fecha, tg_ant, color = empresa))+ 
  geom_line()+
  geom_point()+
  scale_y_continuous(labels = scales::percent)+
  labs(title = "Tasa de ganancia empresas hidrocarburos",
       subtitle =  "Antes de impuestos")+
  theme(axis.text.x = element_text(angle = 90))+
  facet_wrap(~sector)

ggplotly(graf_tg_emp, width = 600, height = 400)
```

## Por subsector

```{r}
balances_arg %>% 
  filter(unidad == "Millones de pesos") %>% 
  group_by(fecha, sector) %>% 
  summarise("TG antes de impuestos" = sum(gcia_ant,na.rm = T)/sum (KTA,na.rm = T),
         "TG despues de impuestos" = sum(gcia_ant, impuesto_gcia, na.rm = T)/sum(KTA, na.rm = T ) ) %>%
  gather(key = variable, value = valor, 3:4) %>% 
  filter(variable =="TG despues de impuestos") %>%
  ggplot(aes(fecha, valor, color = sector))+ 
  geom_line()+
  geom_point()+
  scale_y_continuous(labels = scales::percent)+
  labs(title = "Tasa de ganancia empresas hidrocarburos",
       subtitle =  "Antes y después de impuestos")+
  theme(axis.text.x = element_text(angle = 90))+
  facet_wrap(~variable)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
graf_tg_ypf <- ypf_seg %>% 
  # filter(sector %in% c("quimica", "downstream", "upstream")) %>%
  filter(sector != "adm_central") %>%
  ggplot(aes(fecha, tg_activo, color = sector))+ 
  geom_line()+
  geom_point()+
  # facet_wrap(~sector)+
  scale_y_continuous(labels = scales::percent)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Tasa de ganancia de segmentos YPF")
graf_tg_ypf
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
graf_tg_petrobras <- petrobras_ar_seg %>% 
  filter(sector %in% c("petroquimica", "downstream", "upstream", "gas_y_energia")) %>%
  # filter(sector != "adm_central") %>%
  ggplot(aes(fecha, tg, color = sector))+
  geom_line()+
  # facet_wrap(~sector)+
  scale_y_continuous(labels = scales::percent)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Tasa de ganancia de segmentos Petrobras Argentina")
graf_tg_petrobras
```
##Total rama

```{r echo=FALSE, message=FALSE, warning=FALSE   ,fig.width=10, fig.height=5}

tasa_ganancia_rama <- empalme_ccnn %>%
  distinct() %>% 
    filter(anio >1997) %>% 
  select(anio, unidad, pv) %>% 
    # left_join(stock_y_pozos %>% 
  #             select(anio,  ppye = ppye_estimado, stock_seleccionado = fuente_ppye, fuente_pozo),
  #           by = c("anio")) %>% 
  left_join(stock_estimado %>%
              left_join(ipc_promedio , by = "anio") %>% 
                      mutate(fuente_pozo = "Estimación sin pozos",
                             valor = valor *ipc_18) %>% 
                      select(anio,  ppye = valor, stock_seleccionado = fuente_ppye, fuente_pozo),
            by = c("anio")) %>% 
  mutate(tasa_ganancia = pv/ppye) %>% 
  filter(!is.na(stock_seleccionado)) %>% 
  select(-fuente_pozo)

graf_tg_rama_1 <- tasa_ganancia_rama%>%
  ggplot(aes(anio, tasa_ganancia, color =stock_seleccionado ))+
  geom_line(alpha = 0.5)+
  geom_point()+
  scale_y_continuous(labels = scales::percent)+
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom")+
  labs(title = "Tasa de ganancia hidrocarburífera con PPyE de extracción") 
  # facet_wrap(~stock_seleccionado)
# ggplotly(graf_tg_rama_1, width = 800, height = 600)
graf_tg_rama_1

############

# #el DF tasa_ganancia_rama_stock contiene las estimaciones distintas estimaciones de KTA con stock de pozos 
# tasa_ganancia_rama_stock <- valor_total_produccion %>%
#   filter(variable == "excedente_bruto_explotacion" & fuente == "Criterio propio con VBP CCNN" ) %>% 
#   select(anio, unidad, excedente_bruto_explotacion = valor) %>% 
#   left_join(stock_estimado %>% 
#               # filter(variable %in% c("ppye_estimado_afip", "ppye_estimado_bolsar",
#               #                        "ppye_estimado_total")) %>%
#               # filter(variable == "ppye_estimado_bolsar") %>%
#               # filter(variable == "ppye_estimado_total") %>%
#               select(anio, unidad,  ppye = valor, stock_seleccionado = fuente_ppye) %>% 
#               mutate(unidad = "Millones de pesos de 2018")) %>% 
#   mutate(tasa_ganancia = excedente_bruto_explotacion/ppye)
# 
# graf_tg_rama_2 <- tasa_ganancia_rama_stock %>% 
#   filter(anio >1960) %>% 
#   ggplot(aes(anio, tasa_ganancia, color = stock_seleccionado))+
#   geom_line(alpha = 0.5)+
#   geom_point()+
#   scale_y_continuous(labels = scales::percent)+
#   theme(axis.text.x = element_text(angle = 90),
#         legend.position = "bottom")+
#   labs(title = "Tasa de ganancia hidrocarburífera con PPyE a partir de stock de pozos (1960 - 2018)")
# # ggplotly(graf_tg_rama_2, width = 800, height = 600)
# graf_tg_rama_2

```

## Renta apropiada por las empresas de la rama

La renta apropiada por las empresas de la rama se calcula por medio del diferencial de tasas de ganancia entre el sector hidrocarburífero que surge a partir de los balances y la rentabilidad normal de la economía.

$$Renta\_empresas = KTA_{hidrocarburífero} * (TG_{hidrocarburífera} - TG_{referencia})$$
$$TG_{hidrocarburífera} = \frac{Gcia_{hidrocarburos}}{KTA_{hidrocarburífero}}$$ 
Por lo cual, la renta apropiada por las empresas de la rama sería equivalente a:

$$Renta\_empresas = Gcia_{hidrocarburos} - KTA_{hidrocarburífero} *  TG_{referencia}$$

Donde:

* $KTA_{hidrocarburífero}$ = Stock de capital adelantado de empresas hidrocarburíferas
* $TG_{hidrocarburífera}$ = Tasa de ganancia de empresas hidrocarburíferas
* $TG_{referencia}$ = Tasa de ganancia de referencia
* $Gcia_{hidrocarburos}$ = Ganancia de empresas hidrocarburíferas


```{r echo=FALSE, message=FALSE, warning=FALSE}
  
tg_industrial <- read_delim("C:/Archivos/Datos/Hidrocarburos/TG/tg_industrial.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  mutate(anio = as.double(anio))

renta_tg <-  tasa_ganancia_rama %>%
  select(anio, unidad, stock_seleccionado,  ppye , tasa_ganancia) %>% 
  # filter(stock_seleccionado == "ppye_bolsar",fuente_pozo == "pozos_cargados_sec_energia" ) %>% 
  left_join(tg_industrial, by = "anio") %>% 
  rename(tg_hidrocarburos = tasa_ganancia) %>% 
  mutate(union_tg = case_when(anio < 1993 ~ tg_indu_jic,
                              anio >= 1993 ~ tg_indu_em),
         renta_con_tg_jic = ppye *(tg_hidrocarburos - tg_indu_jic),
         renta_con_tg_em = ppye *(tg_hidrocarburos - tg_indu_em),
         renta_con_tg_union = ppye *(tg_hidrocarburos - union_tg)) %>% 
  distinct()

graf_tg_rama <- renta_tg %>%
  filter(!is.na(stock_seleccionado)) %>% 
  gather(key = tipo_renta,
         value = renta,
         c(renta_con_tg_jic, renta_con_tg_em,renta_con_tg_union )) %>% 
  filter(anio >1960) %>% 
  left_join(ipc_promedio %>% select(anio, ipc_18)) %>% 
  mutate(renta = renta/ipc_18) %>% 
  ggplot(aes(anio, renta, fill = tipo_renta))+ 
  geom_col(position ="dodge")+
  # geom_point()+
  labs(title = "Renta hidrocarburífera por diferencial de tasas de ganancia",
       y = "Millones de pesos de 2018")+
  theme(axis.text.x = element_text(angle = 90))+  facet_wrap(~stock_seleccionado, ncol = 1)
ggplotly(graf_tg_rama, width = 600, height = 400)
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
renta_empresas_balances <- read_csv("C:/Archivos/Datos/Balances/gas y petroleo_datos/datos_r/resultados/renta_empresa.csv", 
    col_types = cols(X1 = col_skip())) 

renta_produccion_balances <-  renta_empresas_balances %>% 
  filter(!(empresa %in% c("chevron_global", "petrobras_global" )),
         sector %in% c( "integrada", "produccion")
         ) %>% 
  group_by(fecha, unidad) %>% 
  summarise(KTA = sum(KTA, na.rm = T),
            ganancia_empresas_antes_impuestos = sum(gcia_ant, na.rm = T),
            ganancia_empresas_desp_impuestos = sum(gcia_desp, na.rm = T),
            renta_empresas_antes_impuestos = sum(renta_ant_corr, na.rm = T),
            renta_empresas_desp_impuestos = sum(renta_desp_corr, na.rm = T)) %>% 
  ungroup() %>% 
  mutate( anio = lubridate::year(fecha)) %>% 
  select(anio, everything(.), -fecha)

graf_renta_emp <- renta_empresas_balances %>%
  filter(sector != "distribucion") %>% 
  filter(!is.na(renta_desp_p18),
         !(empresa %in% c("chevron_global", "petrobras_global" ))) %>% 
  ggplot(aes(fecha, renta_desp_p18, fill = empresa)) + 
  geom_col(position = "stack")+
  labs(title = "Renta hidrocarburífera por empresa",
       subtitle = "Millones de pesos corrientes")+
  facet_wrap(~sector)

ggplotly(graf_renta_emp, width = 600, height = 400)

```




```{r echo=FALSE}
ejercicio <- valor_total_produccion %>% 
  filter(variable == "va_tot") %>% 
  # full_join(stock_rama %>%
  #             select(anio, rama = sector, activos = variable, valor_activos = valor, 
  #                    fuente_activos = fuente) %>% 
  #             # filter(fuente_activos == "AFIP"))%>%
  #             filter(fuente_activos == "Bolsar"))%>%
  full_join(stock_balances_empresas %>%
              ungroup() %>% 
              filter(empresa == "YPF") %>% 
              select(anio, rama = sector, activos = variable, valor_activos = valor)) %>% 
              # filter(fuente_activos == "Bolsar"))%>%
  mutate(relacion = valor_activos/valor) %>% 
  filter(anio > 1990, !(is.na(activos)))
ejercicio            
  
graf_relacion <- ejercicio %>% 
  # ggplot( aes(anio, relacion, color = rama))+
  ggplot( aes(anio, relacion, color = fuente))+
  # geom_line()+
  geom_point()+
  theme_classic()+
  theme(legend.position = "bottom")+
  labs(title = "Activo sobre valor agregado")+
  facet_wrap(~activos) 

  ggplotly(graf_relacion, width = 600, height = 400)


```



# Renta por el diferencial de precios entre el mercado interno y las referencias internacionales 

Renta apropiada mediante el abaratamiento en el consumo interno por efecto del diferencial de precios interno/externo, sobrevaluación de la moneda y retenciones a la exportación


### Criterio de cómputo de JK (variable 'renta_dif_precios')

$$RDP= ProdInt * Pext * TCP - ProdInt * PMI * TCC$$

Donde:

* $RDP$ = Renta apropiada por efecto diferencial de precios interno/externo y sobrevaluación
* $MdoInt$ = Producción destinada al Mercado Interno: Producción - Exportaciones - Existencias (barriles de petróleo ó MMBTU)
* $Pext$ = Precio de referencia del mercado externo (USD)
* $PMI$ = Precio de venta del mercado interno (USD)
* $TCP$ = Tipo de Cambio de Paridad
* $TCC$ = Tipo de Cambio Comercial

### Criterio de cómputo de JIC y cia (variable 'renta_abaratamiento_sobrevaluacion')
$$RDP = MdoInt * PMI * (\frac{TCP}{TCC}  - 1)$$  




```{r echo=FALSE, message=FALSE, warning=FALSE}

renta_dif_precios_crudo <- prod_merge_crudo %>% 
  # filter(anio > 1990) %>% 
  select(anio, unidad, prod_crudo) %>% 
  left_join(expo_q_crudo %>% 
              select(anio, unidad, expo_crudo)) %>% #union con expo
  left_join(existencias_petroleo) %>% 
  replace_na(list(existencias_crudo=0 )) %>% 
  replace_na(list(expo_crudo=0 )) %>% 
  # mutate(prod_mdo_interno = prod_crudo - expo_crudo - existencias_crudo) %>% 
  mutate(prod_mdo_interno = prod_crudo - expo_crudo ) %>% 
  left_join(precio_mi_crudo %>% 
              select(anio, precio_crudo_mdoint),
            by = c("anio")) %>%  # uno con precio interno
  left_join(precios_referencia_y_expo_crudo %>% 
              mutate(brent = case_when(anio < 1987 ~ brent_historic,
                                       anio >= 1987 ~ brent_iea )) %>% 
              select(anio, precio_me_crudo, brent ),
            by = c("anio")) %>%   # uno con precio externo 
  left_join(tcp_anual_b, by = "anio") %>% 
  mutate(renta_dif_precios_crudo = prod_mdo_interno*precio_me_crudo*tcp - prod_mdo_interno*precio_crudo_mdoint*tcc,
         renta_dif_precios_brent = prod_mdo_interno*brent*tcp - prod_mdo_interno*precio_crudo_mdoint*tcc,
         # renta_abaratamiento_sobrevaluacion = prod_mdo_interno *precio_crudo_mdoint(tcp/tcc-1),
         unidad_precio = "USD", unidad_renta = "Pesos corrientes") %>% 
  select(anio, unidad_cantidad= unidad , prod_crudo, expo_crudo, existencias_crudo, prod_mdo_interno,
         unidad_precio, precio_interno_crudo = precio_crudo_mdoint, precio_externo_crudo = precio_me_crudo,
          tcc, tcp, unidad_renta, 
         # renta_abaratamiento_sobrevaluacion_crudo = renta_abaratamiento_sobrevaluacion,
         renta_dif_precios_crudo, renta_dif_precios_brent) 




graf_dif_crudo <- renta_dif_precios_crudo %>%
  left_join(ipc_promedio %>% select(anio, ipc_18)) %>% 
  mutate(renta_dif_precios_crudo = renta_dif_precios_crudo/ipc_18,
         renta_dif_precios_brent = renta_dif_precios_brent/ipc_18) %>% 
  filter(anio >1960) %>% 
  select(anio, 12:ncol(.) ) %>% 
  gather(key = tipo_renta,
         value = valor,
         3:4) %>% 
  mutate(valor = valor / 10^6) %>% 
  ggplot(aes(anio, valor, color = tipo_renta, fill = tipo_renta))+
  geom_col(position = "dodge")+
  theme(legend.position = "bottom")+
  labs(title = "Renta petrolera por diferencial de precios interno y externo",
       y = "MM de pesos de 2018")
graf_dif_crudo



```


```{r echo=FALSE, message=FALSE, warning=FALSE}
renta_diferencial_precios_gas <- prod_merge_gas_MMBTU %>% 
  select(anio, unidad, prod_gas) %>% 
  left_join(expo_q_gas_MMBTU %>% select(anio, unidad, expo_gas)) %>% 
  mutate(expo_gas = replace_na(expo_gas, 0 ),
        prod_mdo_interno = prod_gas - expo_gas) %>%
  left_join(precio_mi_gas_MMBTU %>%
              select(anio , precio_interno_gas =  precio_gas_mdoint),
            by = "anio") %>%  # uno con precio interno
  left_join(precio_mdomundial_gas_MMBTU %>%
              select(anio, precio_externo_gas), 
            by = "anio") %>%   # uno con precio externo
  left_join(tcp_anual_b, by = "anio") %>%
  mutate(
    precio_interno_gas = precio_interno_gas/ tcc,
    renta_dif_precios_gas = prod_mdo_interno * tcp * precio_externo_gas
      - prod_mdo_interno * tcc * precio_interno_gas ,
    renta_abaratamiento_sobrevaluacion = prod_mdo_interno * precio_interno_gas*(tcp/tcc-1),
      unidad_precio = "USD", unidad_renta = "Pesos corrientes") %>% 
  select(anio, unidad_cantidad= unidad , prod_gas, expo_gas, prod_mdo_interno, 
         unidad_precio, precio_interno_gas, precio_externo_gas, tcc, tcp,
         unidad_renta, renta_dif_precios_gas, renta_abaratamiento_sobrevaluacion_gas = renta_abaratamiento_sobrevaluacion )
renta_diferencial_precios_gas



graf_dif_gas <- renta_diferencial_precios_gas %>% 
  left_join(ipc_promedio %>% select(anio, ipc_18)) %>% 
  mutate(renta_dif_precios_gas = renta_dif_precios_gas/ipc_18,
         renta_abaratamiento_sobrevaluacion_gas = 
           renta_abaratamiento_sobrevaluacion_gas/ipc_18) %>%
    select(anio, 11:ncol(.) ) %>% 
  gather(key = tipo_renta,
         value = valor,
         3:4) %>% 
  mutate(valor = valor / 10^6) %>% 
  ggplot(aes(anio, valor, color = tipo_renta, fill = tipo_renta))+
  geom_col(position = "dodge")+
  theme(legend.position = "bottom")+
  labs(title = "Renta gasífera por diferencial de precios interno y externo",
       y = "MM de pesos de 2018")+
  xlim(1960, 2021)
graf_dif_gas



```

# Renta apropiada por sobrevaluación cambiaria


$$Rsobrevaluacion = Expo * Pext * (TCP - TCC)$$ 

Donde:
* $Rsobrevaluacion$ = Renta apropiada por exportaciones con tipo de cambio sobrevaluado
* $Expo$ = Exportaciones  (barriles de petróleo ó MMBTU)
* $Pext$ = Precio de referencia del mercado externo (USD)
* $TCP$ = Tipo de Cambio de Paridad
* $TCC$ = Tipo de Cambio Comercial

```{r echo=FALSE}

renta_tcp_crudo <-  renta_dif_precios_crudo %>%
  left_join(expo_usd_crudo %>% 
              select(anio, expo_crudo_usd = expo_crudo, unidad_expo = unidad )) %>% 
   mutate(renta_sobrevaluacion_crudo = expo_crudo*precio_externo_crudo*tcp - expo_crudo*precio_externo_crudo*tcc,
          renta_sobrevaluacion_crudo_valor = expo_crudo_usd* tcp - expo_crudo_usd* tcc, 
         unidad_precio = "USD", unidad_renta = "Pesos corrientes",
         dif = renta_sobrevaluacion_crudo/renta_sobrevaluacion_crudo_valor-1) %>% 
  select(anio, unidad_cantidad , expo_crudo,
         unidad_expo, expo_crudo_usd,
         unidad_precio, precio_externo_crudo ,
          tcc, tcp, unidad_renta,
         renta_sobrevaluacion_crudo, renta_sobrevaluacion_crudo_valor, dif)  
renta_tcp_crudo

renta_tcp_gas <-  renta_diferencial_precios_gas %>% 
   mutate(renta_sobrevaluacion_gas = expo_gas*precio_externo_gas*tcp - expo_gas*precio_externo_gas*tcc,
         unidad_precio = "USD", unidad_renta = "Pesos corrientes") %>% 
  select(anio, unidad_cantidad , expo_gas, 
         unidad_precio, precio_externo_gas ,
          tcc, tcp, unidad_renta,
         renta_sobrevaluacion_gas)  



```



# Renta apropiada por el Estado mediante impuestos específicos

```{r echo=FALSE}

retenciones_campodonico <- read_excel("/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/retenciones.xlsx" , 
    sheet = "usd") %>% 
  left_join(tcp_anual %>% select(-TCP)) %>% 
  mutate(retenciones_hc = retenciones_hg * TCC * 1000000,
         unidad = "ars") %>% 
  select(anio, unidad, retenciones_hc)

retenciones_crudo <- read_excel( "/Archivos/Datos/Hidrocarburos/Estimacion propia/datasets/retenciones.xlsx" ) %>%
  rename(retenciones_crudo_jk = retenciones_jk,
         retenciones_crudo_bfr = "retenciones_bfr_M$2008") %>% 
  mutate(retenciones_crudo_bfr = retenciones_crudo_bfr * ipc08_bfr * 1000 ,
         unidad = "ars") %>% 
  select(-ipc08_bfr) %>% 
  left_join(retenciones_campodonico)


rentenciones_regalias <- regalias %>% 
  group_by(anio, unidad) %>% 
  summarise(regalias_total = sum(regalias_total, na.rm = T)) %>% 
  left_join(retenciones_crudo %>% select(-c(retenciones_crudo_bfr, retenciones_hc))) 



retenciones_crudo


```




$$Rimp = RE + Reg$$

Donde:

* $Rimp$ = Renta apropiada por el Estado mediante impuestos específicos
* $RE$ = Retenciones
* $Reg$ = Regalias

# Renta apropiada por consumidores y refinerías y procesadoras

### Criterio de cómputo de Ramón (2019)

#### Refinerías y procesadoras

$$RR = (PI - PRMi) * CrudoP$$



* $RR$ = Renta apropiada por las Refinadoras 
* $PI$ = promedio ponderado de Precios Internacionales 
* $PRMi$ = Precio ponderado a Refinerías del Mercado Interno
* $CrudoP$ = barriles de Crudo Procesado por las refinadoras

#### Consumidores

$$RC = (PI - PRMi - MR) * CrudoP $$

* $RC$ = Renta apropiada por los Consumidores
* $MR$ = Margen de Refinerías

Esto resulta equivalente a plantear:

$$RC = PCMi * CrudoP$$

* $PCMi$ = Precio ponderado a Consumidores del Mercado Interno.




# Renta Hidrocarburífera Total. En precios constantes, sobre Plusvalía Total y PBI

Existen dos caminos para llegar al monto total de renta de la tierra hidrocarburífera: uno es descontando la ganancia normal de las empresas a la plusvalía total del sector y el otro es por medio de la suma de mecanismos de apropiación.

$$Renta\_hidrocarburífera = PV_{hidrocarburífera} - Gcia\_Normal_{hidrocarburífera}$$
Donde:

* $Gcia\_Normal_{hidrocarburífera}$ = Ganancia Normal del sector hidrocarburífero
* $PV_{hidrocarburífera}$ = Plusvalía del sector hidrocarburífero  

$$Gcia\_Normal_{hidrocarburífera} = KTA_{hidrocarburífero} * TG_{referencia}$$


Donde:

* $KTA_{hidrocarburos}$ = Stock de capital adelantado del sector hidrocarburífero 
* $TG_{referencia}$ = Tasa de ganancia normal de referencia.

En este caso, seleccionamos la tasa de ganancia del sector industrial como parámetro para diferenciar la renta de la ganancia. A su vez, para el capital total adelantado de las empresas hidrocarburíferas, seleccionamos unicamente el valor resultante de la estimación de la PPyE de Bolsar a partir del indice de flujo de pozos (variable "ppye_bolsar_flujo"), por lo que le faltan los inventarios y salarios adelantados.

El cálculo de renta total hidrocarburífera que se obtiene por medio de descontar la ganancia normal a la plusvalía total del sector, debe ser igual a la renta obtenida por medio de la agregación de los distintos mecanismos de apropiación. Es decir:

$$Renta\_hidrocarburífera = Renta\_diferencial\_precios + Renta\_sobrevaluación + Renta\_empresas + Impuestos\_netos\_específicos $$
$$Impuestos\_netos\_específicos = Retenciones + Regalías - Subsidios$$

## Método directo (a partir de descuentos sobre el VBP)

```{r echo=FALSE}
# knitr::opts_chunk$set(echo= TRUE,fig.width = 120,fig.height = 400)
renta_directo <- renta_tg %>% 
  select(anio, ppye , #es stock de bolsar
         tg_hidrocarburos, tg_normal = union_tg) %>% 
  left_join(criterio_propio %>% 
              select(anio,  pv) )%>% 
  left_join(subsidios_hidrocarburos %>% 
              left_join(ipc_promedio %>% select(anio, ipc_18), by ="anio") %>%
              mutate(subsidios = (subsidios_ejes/10^6)/ipc_18, 
                     subsidios =replace_na(subsidios, 0) ) %>% 
              select(anio, subsidios)) %>% 
  left_join(ipc_promedio %>% select(anio, ipc_18), by ="anio") %>% 
  mutate(renta_con_tg_normal = ppye* (tg_hidrocarburos - tg_normal),
         gcia_normal_hidrocarburos = ppye * tg_normal,
         renta_total = (pv/ipc_18) - gcia_normal_hidrocarburos -subsidios,
         # proporcion_subsidios = subsidios/
         #   (pv - gcia_normal_hidrocarburos),
         unidad = "Millones de pesos de 2018") %>% 
  select(anio , ipc_18, unidad, everything(.), -renta_con_tg_normal) %>% #saco renta_con_tg_normal por no uso
  filter(anio >1997)
renta_directo

renta_directo %>%
  filter(anio >1960) %>% 
  ggplot(aes(anio, renta_total))+ 
  geom_line()+
  labs(title = "Renta hidrocarburífera total a partir de estimación propia del VBP",
       y = "Millones de pesos de 2018")+
  theme(axis.text.x = element_text(angle = 90))



renta_directo_pbi <- renta_directo %>% 
  left_join(ganancia_y_pbi %>% rename(unidad_pbi_gcia = unidad),  by = "anio") %>% 
  # left_join(ipc_promedio %>% select(anio, ipc_18),  by = "anio") %>% 
  mutate(renta_pv =(renta_total*ipc_18 )/ganancia, 
         renta_pbi =(renta_total*ipc_18 )/pbi )


graf_renta_directo_pbi <- renta_directo_pbi %>% 
  select(anio, renta_pv,renta_pbi ) %>%
  # filter(anio >= 1962, fuente_gcia == "Propia") %>%
  filter(anio >= 1962) %>%
  gather(key = tipo_renta,
         value = valor,
         2:3) %>%
  ggplot(aes(anio, valor))+
  # geom_col(position = "dodge")+
  geom_line()+
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))+
  labs(title = "Renta hidrocarburífera total sobre PBI y Ganancias Totales",
       subtitle = "A partir de estimación propia del VBP",
       y = "%")+
  scale_y_continuous(labels=scales::percent_format(accuracy = 2))+
  facet_grid(~tipo_renta )

# graf_renta_directo_pbi
ggplotly(graf_renta_directo_pbi, height = 400, width = 600)

```


## Método indirecto (suma de mecanismos)

```{r echo=FALSE}
renta_indirecto <- renta_dif_precios_crudo %>% 
  # select(anio,renta_dif_precios_crudo, renta_dif_precios_brent ) %>%
  select(anio,renta_dif_precios_crudo ) %>%
  left_join(renta_diferencial_precios_gas %>% select(anio, renta_dif_precios_gas) ) %>% 
  left_join(rentenciones_regalias %>% select(-unidad) %>% 
              rename(retenciones = retenciones_crudo_jk)) %>% 
  left_join(renta_tcp_crudo %>% select(anio, renta_sobrevaluacion_crudo)) %>% 
  left_join(renta_tcp_gas %>% select(anio, renta_sobrevaluacion_gas)) %>% 
   left_join(subsidios_hidrocarburos %>%
              select(anio,  subsidios = subsidios_ejes), by ="anio") %>% 
  group_by(anio ) %>% 
  mutate_all(function(x) {x / 10^6}) %>% #las vbles cargadas anteriormente se pasan a MM
  mutate_all(function(x) replace_na(x, 0)) %>% 
  ungroup() %>% 
  left_join(renta_tg %>% 
              filter(stock_seleccionado == "Bolsar") %>% 
              select(anio, renta_empresas = renta_con_tg_union) ) %>%
  # left_join(renta_produccion_balances %>% select(anio, renta_empresas)) %>%
  # left_join(renta_directo %>%
  #             filter(stock_seleccionado == "ppye_bolsar") %>%
  #             select(anio, renta_empresas = renta_con_tg_normal) %>% 
  #             mutate(renta_empresas = 0)) %>%
  left_join(tcp_anual_b) %>% 
  left_join(ganancia_y_pbi %>% rename(unidad_pbi_gcia = unidad)) %>% 
  left_join(ipc_promedio %>% select(anio, ipc_18)) %>% 
  mutate(
    renta_dif_precios_gas = renta_dif_precios_gas /ipc_18,
         renta_dif_precios_crudo = renta_dif_precios_crudo / ipc_18,
         # renta_dif_precios_brent = renta_dif_precios_brent /ipc_18,
         renta_sobrevaluacion_crudo = renta_sobrevaluacion_crudo/ipc_18,
         renta_sobrevaluacion_gas = renta_sobrevaluacion_gas/ipc_18,
         regalias_total = regalias_total / ipc_18,
         retenciones = retenciones / ipc_18, 
         subsidios = subsidios/ipc_18,
    renta_empresas =replace_na(renta_empresas,  0),
         renta_empresas = renta_empresas/ipc_18,
         renta_total = renta_dif_precios_gas+ renta_dif_precios_crudo +
           renta_sobrevaluacion_crudo + renta_sobrevaluacion_gas +
           renta_empresas+
           regalias_total +  retenciones - subsidios,
         proporcion_subsidios = subsidios/(renta_dif_precios_gas+ renta_dif_precios_crudo +
           renta_sobrevaluacion_crudo + renta_sobrevaluacion_gas +
           regalias_total +  retenciones)  ,
         renta_pv = (renta_total*ipc_18)/ganancia,
         renta_pbi = (renta_total*ipc_18)/pbi,
         unidad = "Millones de pesos 2018",
         renta_usd_tcc = (renta_total*ipc_18) / tcc, 
         renta_usd_tcp = (renta_total*ipc_18) / tcp,)  %>% 
  rename(renta_diferencial_precios_gas = renta_dif_precios_gas,
         renta_diferencial_precios_crudo = renta_dif_precios_crudo,
         # renta_diferencial_precios_brent = renta_dif_precios_brent,
         renta_expo_sobrevaluada_crudo = renta_sobrevaluacion_crudo ,
         renta_expo_sobrevaluada_gas = renta_sobrevaluacion_gas,) %>% 
  select(anio, unidad, ipc_18,tcc,tcp, everything(.) , -sobrevaluacion) %>% 
  # select(-renta_dif_precios_crudo)
  # select(-renta_dif_precios_brent) %>% 
  distinct()


#Renta total
graf_renta_total <- renta_indirecto %>%
  filter(anio >1960) %>% 
  select(-c(unidad, ipc_18, renta_total, tcc, tcp,
            subsidios, proporcion_subsidios)) %>% 
  gather(key = tipo_renta,
         value = valor,
         2:8) %>% 
  ggplot(aes(anio, valor, color = tipo_renta, fill = tipo_renta))+
  geom_col(position = "stack")+
  theme(legend.position = "bottom")+
  labs(title = "Renta hidrocarburífera total (petróleo y gas)", 
       subtitle = "Cursos de apropiación. Millones pesos de 2018", 
       y = "Millones de pesos 2018")+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+
  theme_classic()

ggplotly(graf_renta_total, width = 600, height = 400)

# proporcion subsidios
# renta_indirecto[,c("anio","proporcion_subsidios")] %>% arrange(-anio)
```


```{r echo=FALSE}
#Renta tcp y tcc
graf_renta_total_usd <- renta_indirecto %>% 
  select(c(anio, renta_usd_tcc, renta_usd_tcp)) %>%
  filter(anio > 1962) %>% 
  gather(key = tipo_renta,
         value = valor,
         2:3) %>%
  ggplot(aes(anio, valor, color = tipo_renta) )+
  geom_line()+
  geom_point()+
  theme(legend.position = "bottom")+
  labs(title = "Renta hidrocarburífera total (petróleo y gas)", 
       subtitle = "Millones de USD", 
       y = "Millones de USD")+
  theme_classic()+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))
ggplotly(graf_renta_total_usd, width = 600, height = 400)




#comparacion con FR
graf_comparacion_rentas <- renta_indirecto %>% 
  mutate(fuente = "Propia via suma de mecanismos") %>% 
  select(anio, unidad,fuente,  renta_total ) %>% 
  bind_rows(renta_directo_pbi %>% 
                mutate(fuente = "Propia via descuentos sobre VBP") %>% 
               select(anio,fuente,  renta_total ) ) %>% 
  bind_rows(renta_hidrocarburos_fr %>% 
              mutate(fuente = "Fárfaro Ruiz y Bill") %>%
              select(anio, unidad, fuente,  renta_total)) %>% 
  filter(anio >= 1962) %>%
  ggplot(aes(anio, renta_total, color = fuente))+
  geom_line()+
  geom_point(alpha = 0.35)+
  theme(legend.position = "bottom")+
  labs(title = "Renta hidrocarburífera total (petróleo y gas)", 
       subtitle = "Comparación de estimaciones. Millones pesos de 2018", 
       y = "Millones de pesos 2018")+
  theme_classic()
graf_comparacion_rentas


#sobre pbi y pv
graf_renta_total_pv <- renta_indirecto %>% 
  select(anio, renta_pv,renta_pbi ) %>%
  filter(anio >= 1962) %>%
  gather(key = tipo_renta,
         value = valor,
         2:3) %>%
  ggplot(aes(anio, valor, color = tipo_renta, fill = tipo_renta))+
  geom_col(position = "dodge")+
  theme(legend.position = "bottom")+
  labs(title = "Renta hidrocarburífera total sobre PBI y Ganancias Totales",
       subtitle = "Suma de mecanismos",
       y = "%")+
  scale_y_continuous(labels=scales::percent)


ggplotly(graf_renta_total_pv, width = 600, height = 400)

```



```{r echo=FALSE}


#solo renta empresas
# renta_indirecto %>%
#   filter(anio > 1960) %>% 
#   mutate(renta_empresas_pv = renta_empresas*ipc_18/ganancia,
#          renta_empresas_pbi = renta_empresas*ipc_18/pbi) %>% 
#   select(anio, renta_empresas_pv, renta_empresas_pbi) %>% 
#   gather(key = variable, value = valor, 2:3 ) %>% 
#   ggplot(aes(anio, valor, fill = variable))+
#   geom_col(position = "dodge")+
#   theme(legend.position = "bottom")+
#   labs(title = "Renta hidrocarburífera apropiada por empresas sobre PBI y Ganancias Totales",
#        y = "%")+
#   scale_y_continuous(labels=scales::percent)

  
```


```{r}
#################### solo gas
# Gas
# renta_gas_pbi_pv <- renta_diferencial_precios_gas %>% 
#   select(anio,renta_diferencial_precios_gas, renta_abaratamiento_sobrevaluacion_gas ) %>% 
#   group_by(anio ) %>% 
#   mutate_all(function(x) {x / 10^6}) %>% 
#   left_join(ganancia_y_pbi) %>% 
#   mutate(renta_dif_precios_gas_pv = renta_dif_precios_gas/ganancia,
#          renta_dif_precios_gas_pbi = renta_dif_precios_gas/pbi,
#          renta_abaratamiento_sobrevaluacion_gas_pv = renta_abaratamiento_sobrevaluacion_gas/ganancia,
#          renta_abaratamiento_sobrevaluacion_gas_pbi = renta_abaratamiento_sobrevaluacion_gas/pbi,
#          unidad = "Millones de Pesos corrientes")
# 
# graf_renta_gas_pv <- renta_gas_pbi_pv %>% 
#   select(anio, 7:ncol(.) ) %>% 
#   gather(key = tipo_renta,
#          value = valor,
#          2:ncol(.)) %>% 
#   ggplot(aes(anio, valor, color = tipo_renta, fill = tipo_renta))+
#   geom_col(position = "dodge")+
#   theme(legend.position = "bottom")+
#   labs(title = "Renta petrolera por diferencial de precios interno y externo sobre PBI y Ganancias Totales",
#        y = "%")
# plotly::ggplotly(graf_renta_gas_pv)
```

## Costos

$$Q\_total = Q_{petróleo} + Q_{gas} $$
Donde:
  
  * $Q\_total$ = Cantidades producidas de petróleo y gas en Barriles Equivalentes de Petróleo
  * $Q_{petróleo}$ = Cantidades producidas de petróleo crudo en barriles equivalentes de petróleo (BOE)
  * $Q_{gas}$ = Cantidades producidas de gas natural en barriles equivalentes de petróleo (BOE)
  

$$ Costos\_totales =  CI + MS + ConKfijo$$

Donde:

* $Costos\_totales$ = Costos totales hidrocarburíferos
* $CI$ = Consumo Intermedio, distintas estimaciones
* $MS$ = Masa Salarial, distintas estimaciones
* $ConKfijo$ = Consumo de Capital Fijo


$$Costos\_totales\_con\_Gcia = Costos\_totales + Gcia\_Normal_{hidrocarburífera} $$
Donde:

* $Costos\_totales\_con\_Gcia$ = Costos totales hidrocarburíferos con ganancia normal 
* $Gcia\_Normal_{hidrocarburífera}$ = Ganancia normal del sector hidrocarburífero

$$ Precio\_costo = \frac{Costos\_totales}{Q\_total}   $$
Donde:
* $Precio\_costo$ = Precio de costo en BOE

A partir de esto se puede calcular un costo recuperable del petróleo y del gas

$$Costo\_crudo = Q_{petróleo} * Precio\_costo$$
$$Costo\_gas = Q_{gas} * Precio\_costo$$


$$Precio\_produccion = \frac{Costos\_totales\_con\_Gcia}{Q\_total}$$

$$Precio\_vta\_potencial =  \frac{Q\_total*Pext_{petróleo} - Costos\_totales}{Q\_total} $$


Donde:
* $Precio\_produccion$= Precio de produccion
* $Precio_vta_potencial$ = Precio de venta potencial
* $Pext_{petróleo}$ = Precio de exportación/referencia internacional del petróleo crudo

```{r}
#estimacion costos propia
costos <- produccion_total %>% 
  select(anio, unidad_produccion=unidad,
         produccion_crudo =prod_crudo, produccion_gas=prod_gas,
         produccion_total=produccion_total_bep) %>% 
 left_join(stock_estimado %>%
               left_join(ipc_promedio %>% select(anio, ipc_18)) %>%
              # filter(variable == "ppye_estimado_bolsar") %>% 
              mutate(consumo_k_fijo = valor * ipc_18 * consumo_k_fijo_ypf) %>% 
               select(anio, consumo_k_fijo)) %>%
  left_join(valor_total_produccion %>% 
              left_join(ipc_promedio %>% select(anio, ipc_18)) %>% 
              left_join(tcp_anual_b %>% select(-sobrevaluacion)) %>%
              filter(variable %in% c("ci_extr", "ms_extr"),
                     fuente%in% c("CCNN oficial", "Empalme CCNN")) %>% #"Criterio CCNN"
              mutate(valor = (valor*10^6)*ipc_18/tcc,
                     unidad ="USD tcc") %>% 
              spread(key=variable, value=valor)) %>% 
  left_join(renta_directo %>% 
              select(anio, #stock_seleccionado,
                     ppye, tg_normal, renta_total) ) %>% 
  left_join(precios_referencia_y_expo_crudo %>% 
              select(anio, unidad, precio_referencia_externo = precio_me_crudo)) %>% 
  mutate(ppye = (ppye*10^6)*ipc_18/tcc,
         renta_total = (renta_total*10^6)*ipc_18/tcc,
         unidad_costos= "USD/boe",
         costos_totales = (ci_extr +ms_extr + consumo_k_fijo),
         costos_totales_sum_gcia_normal = costos_totales + (ppye  * tg_normal),
         precio_costo = costos_totales/produccion_total,
         precio_costo_mmbtu = conversor_bepMMBTU_p(precio_costo),
         precio_produccion =costos_totales_sum_gcia_normal/produccion_total,
         precio_venta_potencial = (produccion_total *precio_referencia_externo -
                                     costos_totales)/produccion_total )
         # precio_venta_potencial = ((ppye * tg_normal)+renta_total)/produccion_total)
# (produccion x precio internacional - costos_totales) / barriles BOE = gcia + renta por barril 
#expresar en usd tcc y tcp
costos

costos %>% 
           filter(anio > 1997) %>% 
  ggplot(aes(anio, precio_costo, color = fuente))+ 
  geom_line(alpha = 0.5, size = 1.4)+
    labs(title = "Precio de costo",
         subtitle= "Estimacion propia a partir de CCNN y reestimacion de VBP con criterio CCNN", 
         y = "USD/BOE", x = "Año")


```

# Comparación con estimación de otros autores

```{r}

#renta usd vs autores
#falta agregar renta_hidrocarburos_jk
renta_autores <- renta_indirecto %>% 
  select(anio,tcc, tcp, ipc_18, retenciones, regalias_total, contains("renta")) %>% 
  select( -(13:ncol(.))) %>% 
  filter(anio > 1962) %>%
  mutate( retenciones= retenciones*ipc_18/tcc,       
          regalias_total = regalias_total*ipc_18/tcc, 
          renta_diferencial_precios_crudo = renta_diferencial_precios_crudo*ipc_18/tcp,
          renta_diferencial_precios_gas = renta_diferencial_precios_gas*ipc_18/tcp,
          renta_expo_sobrevaluada_crudo = renta_expo_sobrevaluada_crudo*ipc_18/tcp,  
          renta_expo_sobrevaluada_gas = renta_expo_sobrevaluada_gas*ipc_18/tcp  ,
          renta_sobrevaluacion = renta_expo_sobrevaluada_crudo+ renta_expo_sobrevaluada_gas,
          renta_diferencial_precios = 
            renta_diferencial_precios_gas+ renta_diferencial_precios_crudo,
          # renta_empresas = renta_empresas*ipc_18/tcc,
          # renta_empresas = renta_empresas*ipc_18/tcc,
          renta_total = (renta_total*ipc_18) / tcp,
          unidad = "Millones de USD",
         autor = "Propia") %>% 
  rename(retenciones = retenciones,
         regalias = regalias_total
          # renta_empresas = renta_empresas,
         # renta_total_gas = renta_diferencial_precios_gas,
         # renta_total_crudo = renta_diferencial_precios_crudo,
         ) %>% 
  select(anio, unidad, autor, everything(.), 
         -c(ipc_18, tcc, tcp, renta_expo_sobrevaluada_crudo, renta_expo_sobrevaluada_gas,
            renta_diferencial_precios_gas, renta_diferencial_precios_crudo)) %>% 
  gather(key = tipo_de_renta,
         value = valor,
         4:ncol(.)) %>% 
    bind_rows(renta_autores)
#####


#grafico comparacion con otros autores
graf_tipos_renta <- renta_autores %>% 
  filter(!(tipo_de_renta%in% c("renta_total", 
                               "renta_diferencial_precios",
                               "renta_estado_total"))) %>% 
  ggplot(aes(anio, valor, color = autor))+
  geom_line()+
  geom_point(size = 0.5)+
  facet_wrap(~tipo_de_renta, scales = "free_y")+
  labs(title = "Renta hidrocarburífera", 
       subtitle = "Comparación de estimaciones. Millones USD", 
       y = "Millones de USD")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggplotly(graf_tipos_renta, width = 800, height = 600)  



graf_renta_total_comparacion <- renta_autores %>% 
  # filter(!(autor == "Propia" & tipo_de_renta == "renta_total")) %>%
  # mutate(tipo_de_renta= case_when(tipo_de_renta =="renta_diferencial_precios" &
  #                                   autor == "Propia" ~ "renta_total",
  #                                 T ~ tipo_de_renta)) %>%
  filter(tipo_de_renta == "renta_total") %>% 
  ggplot(aes(anio, valor, color = autor))+
  geom_line()+
  geom_point()+
  theme(legend.position = "bottom")+
  labs(title = "Renta hidrocarburífera total (petróleo y gas)", 
       subtitle = "Con renta total propia metodología autores", 
       y = "Millones de USD")+
  theme_classic()+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))
graf_renta_total_comparacion

ggplotly(graf_renta_total_comparacion, width = 600, height = 400)
# ggplotly(graf_renta_total_comparacion_b)

```



# Exportacion de resultados

```{r}

#raw data for metadata
datos <-  list( prod_merge_crudo, precio_mi_crudo, expo_q_crudo, precios_referencia_y_expo_crudo, prod_merge_gas_MMBTU, 
   precio_interno_gas_mmbtu_usd,  expo_q_gas,  precio_mdomundial_gas_MMBTU, subsidios_hidrocarburos,
   ganancia_y_pbi, tcp_anual_b, ipc_promedio , renta_indirecto[,c(1:13, 17)], renta_dif_precios_crudo[,-14], 
 renta_diferencial_precios_gas[,-13], renta_tcp_crudo[,-c(12:13)], renta_tcp_gas, regalias_usd, retenciones_crudo, subsidios_hidrocarburos, 
 renta_produccion_balances , criterio_propio, renta_directo, renta_directo_pbi[,c(1,14:15)], 
 renta_indirecto[,c(1,19:20)],  ccnn_oficial, criterio_ccnn, empalme_ccnn, criterio_propio, 
renta_autores, renta_empresas_balances,  stock_balances_empresas, union_segmentos, costos)

## variables de todos los dataframes
columnas <- c()
for(i in 1:length(datos)){
  columnas <- c(columnas, colnames(datos[[i]]))
}

list_col <-  as.data.frame(unique(columnas))


# x <- readxl::read_excel("columnas.xlsx") %>% 
#   # rename(variable = "unique(columnas)") %>% 
#   mutate(unidad = case_when(str_detect(variable, regex("gas|bolivia"))  & str_detect(variable, regex("precio|price")) ~ "USD/MMBTU",
#                             str_detect(variable, regex("gas|lng"))  & str_detect(variable, regex("prod")) ~ "MMBTU",
#                             str_detect(variable, regex("crudo|petroleo"))  & str_detect(variable, regex("precio")) ~ "USD/Barril",
#                             str_detect(variable, regex("crudo|petroleo")) ~ "Barriles",
#                             str_detect(variable, regex("crudo|petroleo"))  & str_detect(variable, regex("prod|expo")) ~ "Barriles"))
#                             

# writexl::write_xlsx(x, path =  "columnas.xlsx")

```


```{r include=FALSE}
## Exportación de resultados
prod_merge_crudo_ex <- prod_merge_crudo %>% 
  rename(regalias_prod = regalias, mecon_prod= mecon, sesco_prod = sesco,
         anuario_prod = anuario_combustibles , sec_energia_prod = crudo_sec_energia , eia_prod  =eia)
prod_merge_gas_MMBTU_ex <- prod_merge_gas_MMBTU %>% 
  rename(regalias_prod = regalias, mecon_prod= mecon, sesco_prod = sesco,
         anuario_prod = anuario_combustibles , eia_prod  =eia)
precio_mi_crudo_ex <- precio_mi_crudo %>% 
  rename(idee_precio = idee, regalias_precio = regalias, mecon_precio = mecon, 
         ypf_precio = ypf, mecon_ccnn_precio = mecon_ccnn )
precio_interno_gas_mmbtu_usd_ex <- precio_interno_gas_mmbtu_usd %>% 
  rename(idee_precio = idee, regalias_precio = regalias, mecon_precio = mecon, 
         ypf_precio = ypf, mecon_ccnn_precio = mecon_ccnn , anuario_precio = anuario)


coeficientes <- list("Proporción de los servicios sobre extraccion" = servicio_s_extraccion,
                     "Tasa de depreciación de YPF" = consumo_k_fijo_ypf,
                     "Impuestos promedios MIP 97" = imp_prom_97,
                     "Coeficiente tecnico MIP 97" = coef_tecnico_97,
                     "Proporción de la Masa Salarial total promedio 2004-2012"= mean_coef_ms$coef_ms_tot,
                     "Proporción de la Masa Salarial extraccion promedio 2004-2012"= mean_coef_ms$coef_ms_extr,
                     "Coeficiente consumo intermedio (Año)" =coef_consumo_intermedio$anio,
                     "Coeficiente consumo intermedio (1- VA/VBP)" =coef_consumo_intermedio$coef_ci)
capture.output(coeficientes, file = "../resultados/argentina/coeficientes.txt")

costos_comparacion <- readxl::read_excel("../resultados/argentina/costos.xlsx")
indice <-  read_excel("../resultados/argentina/metadata_arg.xlsx", sheet = "indice")
variables <-  read_excel("../resultados/argentina/metadata_arg.xlsx", sheet = "variables")
writexl::write_xlsx(list(indice = indice,
                         variables= variables ,
                         tipo_cambio = tcp_anual_b,
                         ipc = ipc_promedio %>% select(-fecha),
                         pv_y_pbi = ganancia_y_pbi ,
                         produccion_crudo = prod_merge_crudo_ex, 
                         produccion_gas = prod_merge_gas_MMBTU_ex,
                         exportacion_crudo = expo_q_crudo,
                         exportacion_gas = expo_q_gas,
                         precio_interno_crudo = precio_mi_crudo_ex, 
                         precio_interno_gas =precio_interno_gas_mmbtu_usd_ex, 
                          precios_externo_crudo = precios_referencia_y_expo_crudo, 
                         precio_externo_gas = precio_mdomundial_gas_MMBTU,
                         RTPG_mecanismos = renta_indirecto[,c(1:13, 17)] %>% filter(anio >1961),
                         RTPG_PextQ = renta_directo,
                         RTPG_mecanismos_vs_pib =renta_indirecto[,c(1,19:20)]  %>% filter(anio >1961),
                         RTPG_PextQ_vs_pib = renta_directo_pbi[,c(1,14:15)],
                         crudo_dif_precios = renta_dif_precios_crudo[,-14], 
                         gas_dif_precios = renta_diferencial_precios_gas[,-13],
                        crudo_sobrevaluacion = renta_tcp_crudo[,-c(12:13)],
                        gas_sobrevaluacion = renta_tcp_gas,
                         regalias_pg = regalias_usd,
                         retenciones_pg = retenciones_crudo,
                         subsidios_pg = subsidios_hidrocarburos,
                         tg_pg_total =renta_tg,
                         tg_pg_empresas = renta_empresas_balances,
                         stock_pg_balances = stock_balances_empresas,
                         segmento_YPF_PetBR =union_segmentos,
                         ccnn_pg = ccnn_oficial,
                         criterio_ccnn_pg=criterio_ccnn %>% select(-c(ci_tot , ci_extr)) ,
                         empalme_ccnn_pg=empalme_ccnn,
                         VBPextTcp  =criterio_propio ,
                         RTPG_comparacion = renta_autores , 
                         costos_pg_comparacion = costos_comparacion ,
                          costos_pg_ccnn=costos),
                    path = "../resultados/argentina/renta_de_la_tierra_hidrocarburifera_arg.xlsx")


x <- renta_autores %>% 
  filter(anio >1997,tipo_de_renta =="renta_total") %>% 
  group_by(anio, unidad, autor) %>% 
  # summarise(valor = sum(valor, na.rm = T)) %>% 
  spread(key = autor, value = valor)  %>% 
  mutate(variable = "Renta de la tierra hidrocarburífera total de Argentina" ) %>% 
  select( anio, unidad, variable, everything(.), -tipo_de_renta)

writexl::write_xlsx(x, path = "../resultados/argentina/tabla_comparacion_autores.xlsx")


# Exportacion vieja

# writexl::write_xlsx(list(produccion_crudo = prod_merge_crudo_ex, 
#                          precio_interno_crudo = precio_mi_crudo_ex, 
#                          exportacion_crudo = expo_q_crudo, 
#                          precios_externo_crudo = precios_referencia_y_expo_crudo,
#                          produccion_gas = prod_merge_gas_MMBTU_ex, 
#                          precio_interno_gas =precio_interno_gas_mmbtu_usd_ex, 
#                          exportacion_gas = expo_q_gas, 
#                          precio_externo_gas = precio_mdomundial_gas_MMBTU,
#                          pv_y_pbi = ganancia_y_pbi ,
#                          tipo_cambio = tcp_anual_b,
#                          ipc = ipc_promedio %>% select(-fecha)),
#                     path =  "../resultados/argentina/variables.xlsx")


# writexl::write_xlsx(list(metodo_indirecto = renta_indirecto[,c(1:13, 17)],
#                          crudo_dif_precios_ms = renta_dif_precios_crudo[,-14],
#                          gas_dif_precios_ms = renta_diferencial_precios_gas[,-13],
#                            crudo_sobrevaluacion_ms = renta_tcp_crudo[,-c(12:13)],
#                            gas_sobrevaluacion_ms = renta_tcp_gas,
#                          regalias = regalias_usd,
#                          retenciones = retenciones_crudo,
#                          subsidios = subsidios_hidrocarburos,
#                          renta_balances = renta_produccion_balances  ),
#                     path = "../resultados/argentina/renta_metodo_indirecto.xlsx")
# 
# writexl::write_xlsx(list(va_criterio_propio = criterio_propio,
#                           metodo_directo = renta_directo),
#                     path = "../resultados/argentina/renta_metodo_directo.xlsx")
# 
# writexl::write_xlsx(list( metodo_directo_pbi = renta_directo_pbi[,c(1,14:15)],
#                          metodo_indirecto_pbi=renta_indirecto[,c(1,19:20)]),
#                     path = "../resultados/argentina/renta_sobre_pbi.xlsx")

# writexl::write_xlsx(list(ccnn_oficial = ccnn_oficial,
#                          criterio_ccnn=criterio_ccnn,
#                          empalme_ccnn=empalme_ccnn,
#                          criterio_propio =criterio_propio),
#                     path= "/Archivos/repos/hidrocarburos/analisis/resultados/argentina/valor_total_produccion.xlsx")
# 
# 
# writexl::write_xlsx(list(comparacion_autores = renta_autores),
#                     path = "resultados/argentina/renta_comparacion_autores.xlsx")
# 
# 
# writexl::write_xlsx(list( tg_total =renta_tg,
                            # "renta empresas" = renta_empresas_balances,
#                            stock_balances = stock_balances_empresas,
#                          segmento_YPF_PetBR =union_segmentos), 
#                     path = "resultados/argentina/stock, tg y renta empresas argentina.xlsx")
# 
# writexl::write_xlsx(list(costos_ccnn=costos),
#                     path = "resultados/argentina/costos_ccnn.xlsx")


# writexl::write_xlsx(list(produccion = prod_merge_crudo, 
#                          exportaciones = expo_q_crudo,
#                          existencias = existencias_petroleo, 
#                          precio_interno = precio_mi_crudo, 
#                          precio_externo = precios_referencia_y_expo_crudo,
#                          tcp = tcp_anual_b,
#                          calculo = renta_dif_precios_crudo), 
#                     path = "resultados/renta_diferencial_precios_crudo.xlsx")
# 
# writexl::write_xlsx(list(produccion = prod_merge_gas_MMBTU, 
#                          exportaciones = expo_q_gas_MMBTU,
#                          precio_interno = precio_mi_gas_MMBTU, 
#                          precio_externo = precio_mdomundial_gas_MMBTU,
#                          tcp = tcp_anual_b,
#                          calculo = renta_diferencial_precios_gas), 
#                     path = "resultados/renta_diferencial_precios_gas.xlsx")
# # 
# writexl::write_xlsx(list("con pozos perforados por año"= stock_estimado, 
#                          "con stock de pozos" = ejercicio_fd_stock,
#                          "a partir YPF (flujo)" = ejercicio_fd_ypf), 
#                     path = "resultados/estimacion de stock a partir de pozos.xlsx")

# writexl::write_xlsx(list("con pozos perforados por año"= stock_y_pozos), 
#                     path = "resultados/estimacion de stock a partir de pozos.xlsx")

# 
# writexl::write_xlsx(list("flujo"= comparacion_pozos,
#                          "flujo_total"= listado_pozos,
#                          "stock" = pozos_iapg_centenario), 
#                     path = "resultados/argentina/pozos.xlsx")
# 
# 
# writexl::write_xlsx(list(afip = stock_afip,
#                          balances_bolsar = stock_balances_empresas,
#                          segmento_YPF_PetBR =union_segmentos,
#                          bolsar_v2 = stock_balances_rama,
#                          "inversion por pozo (IAPG)" = inversion_pozos,
#                           "inversion por pozo (Cap IV)"= inversion_pozos_capiv),
#                     path = "resultados/argentina/stock_petroleo.xlsx")
# 



print("El código terminó de correr")

```







